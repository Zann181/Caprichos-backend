<!-- mesero_mis_ordenes.html -->
<style>
    /* Estilos espec√≠ficos para mis √≥rdenes */
    .mis-ordenes-grid { display: grid; gap: 1.5rem; }
    .orden-card { 
        border: 1px solid var(--gris-piedra); 
        border-radius: 8px; 
        background: #fff; 
        transition: all 0.3s ease;
        position: relative;
    }
    .orden-card:hover { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        transform: translateY(-2px); 
    }
    
    /* Estados de las √≥rdenes */
    .orden-card.status-EN-ESPERA { border-left: 4px solid var(--amarillo-modificado, #ffc107); }
    .orden-card.status-ENTREGADO { border-left: 4px solid var(--azul-info, #17a2b8); }
    .orden-card.status-POR-FACTURAR { border-left: 4px solid var(--naranja-tostado, #E8772E); }
    .orden-card.status-FACTURADO { border-left: 4px solid var(--verde-listo, #28a745); }
    
    /* Header de la orden */
    .orden-header { 
        background-color: var(--carbon-suave); 
        color: white; 
        padding: 1rem; 
        border-radius: 8px 8px 0 0; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .orden-header.status-EN-ESPERA { background: linear-gradient(135deg, var(--amarillo-modificado, #ffc107), #e0a800); }
    .orden-header.status-ENTREGADO { background: linear-gradient(135deg, var(--azul-info, #17a2b8), #138496); }
    .orden-header.status-POR-FACTURAR { background: linear-gradient(135deg, var(--naranja-tostado, #E8772E), var(--naranja-oscuro, #C0581B)); }
    .orden-header.status-FACTURADO { background: linear-gradient(135deg, var(--verde-listo, #28a745), #218838); }
    
    .mesa-info { font-size: 1.2em; font-weight: 700; }
    .tiempo-transcurrido { font-size: 0.85em; opacity: 0.8; }
    .orden-body { padding: 1.5rem; }
    
    /* Total y acciones */
    .orden-footer { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding-top: 1rem; 
        border-top: 1px solid #eee; 
        margin-top: 1rem; 
    }
    .orden-total { font-size: 1.2em; font-weight: 700; color: var(--carbon-suave); }
    
    /* Estados vac√≠os */
    .estado-vacio { 
        text-align: center; 
        padding: 3rem; 
        color: #888; 
        background-color: #f8f9fa; 
        border-radius: 8px; 
        border: 2px dashed #dee2e6; 
    }
    
    /* Filtros */
    .filtros-container { 
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 1.5rem; 
        margin-bottom: 2rem; 
        align-items: end;
    }
    .filtros-estados {
        display: flex; 
        gap: 0.5rem; 
        flex-wrap: wrap; 
    }
    .filtro-btn { 
        padding: 8px 16px; 
        border: 1px solid var(--gris-piedra); 
        background: white; 
        border-radius: 20px; 
        cursor: pointer; 
        transition: all 0.2s; 
        font-size: 14px;
    }
    .filtro-btn:hover, .filtro-btn.active { 
        background-color: var(--naranja-tostado); 
        color: white; 
        border-color: var(--naranja-tostado); 
    }
    #filtro-mesa {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid var(--gris-piedra);
        background-color: white;
        min-width: 150px;
    }

    /* Paginaci√≥n */
    #paginacion-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
    }
    .pagina-btn {
        padding: 8px 16px;
    }
    .pagina-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
        .filtros-container { grid-template-columns: 1fr; }
    }
</style>

<h2>üìã Mis √ìrdenes</h2>
<p>Revisa el historial y estado de todas tus √≥rdenes.</p>

<!-- Filtros de √≥rdenes -->
<div class="filtros-container">
    <div>
        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Filtrar por estado:</label>
        <div class="filtros-estados">
            <button class="filtro-btn active" data-filtro="TODAS">Todas</button>
            <button class="filtro-btn" data-filtro="EN ESPERA">En Espera</button>
            <button class="filtro-btn" data-filtro="ENTREGADO">Entregado</button>
            <button class="filtro-btn" data-filtro="POR FACTURAR">Por Facturar</button>
            <button class="filtro-btn" data-filtro="FACTURADO">Facturado</button>
        </div>
    </div>
    <div>
        <label for="filtro-mesa" style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Filtrar por mesa:</label>
        <select id="filtro-mesa">
            <option value="TODAS">Todas las mesas</option>
        </select>
    </div>
</div>

<!-- Contenedor de √≥rdenes -->
<div id="mis-ordenes-container" class="mis-ordenes-grid"></div>
<div id="paginacion-container"></div>

<script>
window.inicializar_mis_ordenes = function() {
    let todasLasOrdenes = [];
    let filtroEstado = 'TODAS';
    let filtroMesa = 'TODAS';
    let paginaActual = 1;
    const ORDENES_POR_PAGINA = 10;

    const container = document.getElementById('mis-ordenes-container');
    const paginacionContainer = document.getElementById('paginacion-container');
    const filtroMesaSelect = document.getElementById('filtro-mesa');

    const mostrarError = (mensaje) => {
        container.innerHTML = `<div class="estado-vacio" style="border-color: var(--rojo-error, #dc3545);"><h3 style="color: var(--rojo-error, #dc3545);">‚ùå ${mensaje}</h3><p>Hubo un problema al contactar al servidor.</p><button class="btn" onclick="window.inicializar_mis_ordenes()">üîÑ Reintentar</button></div>`;
        paginacionContainer.innerHTML = '';
    };

    const cargarOrdenes = async () => {
        container.innerHTML = `<div class="loading" style="text-align: center; padding: 2rem; color: #666;">üîÑ Cargando √≥rdenes...</div>`;
        try {
            const response = await fetch('/api/mesero/ordenes/'); // Asume que esta URL trae TODAS las √≥rdenes del mesero
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            todasLasOrdenes = await response.json();
            poblarFiltroMesas();
            aplicarFiltrosYRenderizar();
        } catch (error) {
            console.error('Error cargando mis √≥rdenes:', error);
            mostrarError('Error al cargar tus √≥rdenes');
        }
    };

    const poblarFiltroMesas = () => {
        const mesasUnicas = [...new Set(todasLasOrdenes.map(o => o.mesa.numero))].sort((a, b) => a - b);
        filtroMesaSelect.innerHTML = '<option value="TODAS">Todas las mesas</option>'; // Reset
        mesasUnicas.forEach(numMesa => {
            const option = document.createElement('option');
            option.value = numMesa;
            option.textContent = `Mesa ${numMesa}`;
            filtroMesaSelect.appendChild(option);
        });
    };

    const aplicarFiltrosYRenderizar = () => {
        let ordenesFiltradas = todasLasOrdenes;

        if (filtroEstado !== 'TODAS') {
            ordenesFiltradas = ordenesFiltradas.filter(o => o.estado === filtroEstado);
        }
        if (filtroMesa !== 'TODAS') {
            ordenesFiltradas = ordenesFiltradas.filter(o => String(o.mesa.numero) === filtroMesa);
        }

        renderizarPagina(ordenesFiltradas);
        renderizarPaginacion(ordenesFiltradas.length);
    };

    const renderizarPagina = (ordenes) => {
        container.innerHTML = '';
        if (ordenes.length === 0) {
            container.innerHTML = `<div class="estado-vacio"><h3>ü§∑‚Äç‚ôÇÔ∏è No se encontraron √≥rdenes</h3><p>Prueba con otros filtros o crea una nueva orden.</p></div>`;
            return;
        }

        const inicio = (paginaActual - 1) * ORDENES_POR_PAGINA;
        const fin = inicio + ORDENES_POR_PAGINA;
        const ordenesDeLaPagina = ordenes.slice(inicio, fin);

        ordenesDeLaPagina.forEach(orden => {
            container.appendChild(crearTarjetaOrden(orden));
        });
    };

    const renderizarPaginacion = (totalOrdenes) => {
        paginacionContainer.innerHTML = '';
        const totalPaginas = Math.ceil(totalOrdenes / ORDENES_POR_PAGINA);

        if (totalPaginas <= 1) return;

        paginacionContainer.innerHTML = `
            <button class="btn pagina-btn" id="pagina-anterior" ${paginaActual === 1 ? 'disabled' : ''}>Anterior</button>
            <span>P√°gina ${paginaActual} de ${totalPaginas}</span>
            <button class="btn pagina-btn" id="pagina-siguiente" ${paginaActual === totalPaginas ? 'disabled' : ''}>Siguiente</button>
        `;

        document.getElementById('pagina-anterior').addEventListener('click', () => {
            if (paginaActual > 1) {
                paginaActual--;
                aplicarFiltrosYRenderizar();
            }
        });
        document.getElementById('pagina-siguiente').addEventListener('click', () => {
            if (paginaActual < totalPaginas) {
                paginaActual++;
                aplicarFiltrosYRenderizar();
            }
        });
    };

    const crearTarjetaOrden = (orden) => {
        const ordenCard = document.createElement('div');
        const estadoClase = `status-${orden.estado.replace(' ', '-')}`;
        ordenCard.className = `orden-card ${estadoClase}`;

        const tiempoCreacion = new Date(orden.creado_en.replace(' ', 'T'));
        const minutosTranscurridos = Math.floor((new Date() - tiempoCreacion) / 60000);
        const tiempoTexto = minutosTranscurridos < 60 ? `${minutosTranscurridos} min` : `${Math.floor(minutosTranscurridos / 60)}h ${minutosTranscurridos % 60}m`;

        ordenCard.innerHTML = `
            <div class="orden-header ${estadoClase}">
                <div class="mesa-info">Mesa #${orden.mesa.numero}</div>
                <div class="tiempo-transcurrido">‚è±Ô∏è Hace ${tiempoTexto}</div>
            </div>
            <div class="orden-body">
                <p><strong>Estado:</strong> ${orden.estado}</p>
                <div class="orden-footer">
                    <div class="orden-total">Total: ${orden.total.toLocaleString()}</div>
                    <div class="acciones-orden">
                        <!-- Aqu√≠ podr√≠as agregar botones de acci√≥n si son necesarios -->
                    </div>
                </div>
            </div>`;
        return ordenCard;
    };

    // Event Listeners para filtros
    document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filtroEstado = btn.dataset.filtro;
            paginaActual = 1; // Resetear a la primera p√°gina
            aplicarFiltrosYRenderizar();
        });
    });

    filtroMesaSelect.addEventListener('change', (e) => {
        filtroMesa = e.target.value;
        paginaActual = 1; // Resetear a la primera p√°gina
        aplicarFiltrosYRenderizar();
    });

    // Carga inicial
    cargarOrdenes();
};

// Funci√≥n de actualizaci√≥n llamada por el long polling
window.actualizar_mis_ordenes = () => {
    if (document.getElementById('mis-ordenes-container')) {
        console.log('üîÑ Actualizando mis √≥rdenes por notificaci√≥n...');
        window.inicializar_mis_ordenes();
    }
};

if (typeof window.inicializar_mis_ordenes === 'function') {
    window.inicializar_mis_ordenes();
}
</script>
