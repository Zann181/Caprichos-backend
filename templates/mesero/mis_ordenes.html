<style>
    /* Estilos espec√≠ficos para mis √≥rdenes */
    .mis-ordenes-grid { display: grid; gap: 1.5rem; }
    .orden-card { 
        border: 1px solid var(--gris-piedra); 
        border-radius: 8px; 
        background: #fff; 
        transition: all 0.3s ease;
        position: relative;
    }
    .orden-card:hover { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        transform: translateY(-2px); 
    }
    
    /* Estados especiales de √≥rdenes */
    .orden-card.necesita-atencion { 
        border-left: 4px solid #28a745; 
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
        animation: pulseGreen 2s infinite;
    }
    @keyframes pulseGreen {
        0%, 100% { box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15); }
        50% { box-shadow: 0 6px 20px rgba(40, 167, 69, 0.25); }
    }
    
    .orden-card.en-preparacion { 
        border-left: 4px solid var(--amarillo-modificado); 
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15); 
    }
    
    /* Header de la orden */
    .orden-header { 
        background-color: var(--carbon-suave); 
        color: white; 
        padding: 1rem; 
        border-radius: 8px 8px 0 0; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .orden-header.lista { background: linear-gradient(135deg, #28a745, #20c997); }
    .orden-header.parcial { background: linear-gradient(135deg, var(--amarillo-modificado), #e0a800); }
    
    .mesa-info { font-size: 1.2em; font-weight: 700; }
    .estado-general { font-size: 0.9em; opacity: 0.9; margin-top: 4px; }
    .tiempo-transcurrido { font-size: 0.85em; opacity: 0.8; }
    
    /* Cuerpo de la orden */
    .orden-body { padding: 1.5rem; }
    
    /* Resumen de estado */
    .estado-resumen { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 1.5rem; 
        padding: 1rem; 
        background-color: rgba(232, 119, 46, 0.05); 
        border-radius: 6px; 
        border: 1px solid rgba(232, 119, 46, 0.1);
    }
    .estado-item { text-align: center; }
    .estado-numero { 
        font-size: 1.5em; 
        font-weight: 700; 
        color: var(--naranja-tostado); 
        display: block; 
    }
    .estado-label { font-size: 0.8em; color: #666; margin-top: 2px; }
    
    /* Lista de productos */
    .productos-existentes { border-top: 1px solid #eee; padding-top: 1rem; }
    .producto-existente { 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 0.75rem 0; 
        border-bottom: 1px solid #f0f0f0;
    }
    .producto-existente:last-child { border-bottom: none; }
    
    .producto-existente.listo { 
        color: var(--verde-listo); 
        font-weight: 600; 
    }
    .producto-existente.agregado-despues { 
        background-color: rgba(255, 193, 7, 0.1);
        padding: 0.75rem;
        border-radius: 4px;
        margin: 0.25rem 0;
        border-left: 4px solid var(--amarillo-modificado);
    }
    
    .producto-nombre { flex: 1; }
    .producto-estado { 
        font-size: 0.9em; 
        padding: 4px 8px; 
        border-radius: 12px; 
        font-weight: 600;
    }
    .producto-estado.listo { background-color: #d4edda; color: #155724; }
    .producto-estado.pendiente { background-color: #fff3cd; color: #856404; }
    .producto-estado.nuevo { background-color: #ffeaa7; color: #b2900f; }
    
    /* Total y acciones */
    .orden-footer { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding-top: 1rem; 
        border-top: 1px solid #eee; 
        margin-top: 1rem; 
    }
    .orden-total { font-size: 1.2em; font-weight: 700; color: var(--carbon-suave); }
    
    /* Notificaci√≥n de atenci√≥n */
    .alerta-atencion { 
        background: linear-gradient(135deg, #28a745, #20c997); 
        color: white; 
        padding: 0.75rem; 
        border-radius: 6px; 
        margin-top: 1rem; 
        font-weight: 600;
        text-align: center;
        animation: pulseNotification 1.5s infinite;
    }
    @keyframes pulseNotification {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }
    
    /* Botones de acci√≥n */
    .acciones-orden { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .btn-peque√±o { 
        padding: 10px 16px; 
        font-size: 14px; 
        border-radius: 6px; 
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 100px;
    }
    .btn-modificar { 
        background-color: var(--azul-info); 
        color: white; 
    }
    .btn-modificar:hover { 
        background-color: #138496; 
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
    }
    .btn-entregar {
        background-color: #28a745;
        color: white;
    }
    .btn-entregar:hover {
        background-color: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
    .btn-ver-cocina {
        background-color: #17a2b8;
        color: white;
    }
    .btn-ver-cocina:hover {
        background-color: #138496;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
    }
    
    /* Estados vac√≠os */
    .estado-vacio { 
        text-align: center; 
        padding: 3rem; 
        color: #888; 
        background-color: #f8f9fa; 
        border-radius: 8px; 
        border: 2px dashed #dee2e6; 
    }
    
    /* Filtros */
    .filtros-ordenes { 
        display: flex; 
        gap: 1rem; 
        margin-bottom: 2rem; 
        flex-wrap: wrap; 
        align-items: center;
    }
    .filtro-btn { 
        padding: 8px 16px; 
        border: 1px solid var(--gris-piedra); 
        background: white; 
        border-radius: 20px; 
        cursor: pointer; 
        transition: all 0.2s; 
        font-size: 14px;
    }
    .filtro-btn:hover, .filtro-btn.active { 
        background-color: var(--naranja-tostado); 
        color: white; 
        border-color: var(--naranja-tostado); 
    }
    
    @media (max-width: 768px) {
        .estado-resumen { grid-template-columns: repeat(2, 1fr); }
        .orden-footer { flex-direction: column; gap: 1rem; align-items: stretch; }
        .acciones-orden { justify-content: center; flex-direction: column; }
        .btn-peque√±o { width: 100%; }
    }
</style>

<h2>üìã Mis √ìrdenes Activas</h2>
<p>√ìrdenes que tienes asignadas y necesitan tu atenci√≥n:</p>

<!-- Filtros de √≥rdenes -->
<div class="filtros-ordenes">
    <span style="font-weight: 600;">Filtrar por estado:</span>
    <button class="filtro-btn active" data-filtro="todas">Todas</button>
    <button class="filtro-btn" data-filtro="necesita-atencion">üîî Necesitan Atenci√≥n</button>
    <button class="filtro-btn" data-filtro="en-preparacion">‚è≥ En Preparaci√≥n</button>
    <button class="filtro-btn" data-filtro="listas">‚úÖ Listas</button>
</div>

<!-- Contenedor de √≥rdenes -->
<div id="mis-ordenes-container" class="mis-ordenes-grid">
    <div style="text-align: center; padding: 2rem; color: #666;">
        üîÑ Cargando tus √≥rdenes activas...
    </div>
</div>

<script>
// Funci√≥n de inicializaci√≥n para mis √≥rdenes
window.inicializar_mis_ordenes = function() {
    let ordenesData = [];
    let filtroActual = 'todas';

    // === CARGAR MIS √ìRDENES ===
    async function cargarMisOrdenes() {
        try {
            const response = await fetch('/api/mesero/ordenes/');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            ordenesData = await response.json();
            aplicarFiltroYRenderizar();
            
        } catch (error) {
            console.error('Error cargando mis √≥rdenes:', error);
            mostrarError('Error al cargar tus √≥rdenes activas');
        }
    }

    // === APLICAR FILTRO Y RENDERIZAR ===
    function aplicarFiltroYRenderizar() {
        let ordenesFiltradas = ordenesData;
        
        // Aplicar filtro
        switch(filtroActual) {
            case 'necesita-atencion':
                ordenesFiltradas = ordenesData.filter(orden => orden.necesita_atencion);
                break;
            case 'en-preparacion':
                ordenesFiltradas = ordenesData.filter(orden => 
                    orden.productos_pendientes_count > 0 && orden.productos_listos_count === 0
                );
                break;
            case 'listas':
                ordenesFiltradas = ordenesData.filter(orden => 
                    orden.productos_pendientes_count === 0 && orden.productos_listos_count > 0
                );
                break;
            default: // 'todas'
                ordenesFiltradas = ordenesData;
        }
        
        renderizarMisOrdenes(ordenesFiltradas);
    }

    // === RENDERIZAR √ìRDENES ===
    function renderizarMisOrdenes(ordenes) {
        const container = document.getElementById('mis-ordenes-container');
        
        if (ordenes.length === 0) {
            let mensajeVacio = '';
            switch(filtroActual) {
                case 'necesita-atencion':
                    mensajeVacio = 'üòä No tienes √≥rdenes que necesiten atenci√≥n en este momento';
                    break;
                case 'en-preparacion':
                    mensajeVacio = 'üòä No tienes √≥rdenes en preparaci√≥n';
                    break;
                case 'listas':
                    mensajeVacio = 'üòä No tienes √≥rdenes listas para servir';
                    break;
                default:
                    mensajeVacio = 'üòä No tienes √≥rdenes activas en este momento';
            }
            
            container.innerHTML = `
                <div class="estado-vacio">
                    <h3>${mensajeVacio}</h3>
                    <p>Las nuevas √≥rdenes aparecer√°n aqu√≠ autom√°ticamente.</p>
                    <button class="btn" onclick="window.recargarPestana('nuevo-pedido')">‚ûï Crear Nueva Orden</button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        ordenes.forEach(orden => {
            const ordenCard = crearTarjetaOrden(orden);
            container.appendChild(ordenCard);
        });
    }

    // === CREAR TARJETA DE ORDEN ===
    function crearTarjetaOrden(orden) {
        const ordenCard = document.createElement('div');
        ordenCard.className = 'orden-card';
        
        // Determinar estado y clases
        let estadoGeneral = '';
        let claseHeader = '';
        let claseCard = '';
        
        if (orden.necesita_atencion) {
            claseCard = 'necesita-atencion';
            claseHeader = 'lista';
            estadoGeneral = 'üîî ¬°Productos listos para servir!';
        } else if (orden.productos_listos_count > 0 && orden.productos_pendientes_count > 0) {
            claseCard = 'en-preparacion';
            claseHeader = 'parcial';
            estadoGeneral = `üîÑ Parcialmente lista (${orden.productos_listos_count}/${orden.productos_listos_count + orden.productos_pendientes_count})`;
        } else if (orden.productos_listos_count > 0) {
            claseHeader = 'lista';
            estadoGeneral = '‚úÖ Lista para servir';
        } else {
            estadoGeneral = '‚è≥ En preparaci√≥n';
        }
        
        ordenCard.className += ` ${claseCard}`;
        
        // Calcular tiempo transcurrido
        const tiempoCreacion = new Date(orden.creado_en.replace(' ', 'T'));
        const ahora = new Date();
        const minutosTranscurridos = Math.floor((ahora - tiempoCreacion) / (1000 * 60));
        let tiempoTexto = '';
        
        if (minutosTranscurridos < 60) {
            tiempoTexto = `${minutosTranscurridos} min`;
        } else {
            const horas = Math.floor(minutosTranscurridos / 60);
            const mins = minutosTranscurridos % 60;
            tiempoTexto = `${horas}h ${mins}m`;
        }
        
        // Crear lista de productos
        let productosHtml = '';
        orden.productos.forEach(p => {
            let claseProducto = '';
            let estadoProducto = '';
            let iconoEstado = '';
            
            if (p.estado === 'LISTO') {
                claseProducto = 'listo';
                estadoProducto = 'listo';
                iconoEstado = '‚úÖ';
            } else {
                estadoProducto = 'pendiente';
                iconoEstado = '‚è≥';
            }
            
            if (p.agregado_despues) {
                claseProducto += ' agregado-despues';
                estadoProducto = 'nuevo';
                iconoEstado = 'üÜï';
            }
            
            productosHtml += `
                <div class="producto-existente ${claseProducto}">
                    <div class="producto-nombre">
                        ${iconoEstado} ${p.cantidad}x ${p.nombre}
                        ${p.observaciones ? `<div style="font-size: 0.8em; color: var(--naranja-tostado); font-style: italic; margin-top: 2px;">üìù ${p.observaciones}</div>` : ''}
                    </div>
                    <span class="producto-estado ${estadoProducto}">
                        ${p.estado === 'LISTO' ? 'Listo' : (p.agregado_despues ? 'Nuevo' : 'Pendiente')}
                    </span>
                </div>
            `;
        });
        
        // Crear alerta de atenci√≥n si es necesario
        let alertaAtencionHtml = '';
        if (orden.necesita_atencion) {
            alertaAtencionHtml = `
                <div class="alerta-atencion">
                    üîî ¬°Esta orden tiene productos listos para servir!
                </div>
            `;
        }
        
        // Construir HTML completo
        ordenCard.innerHTML = `
            <div class="orden-header ${claseHeader}">
                <div>
                    <div class="mesa-info">Mesa #${orden.mesa.numero}</div>
                    <div class="estado-general">${estadoGeneral}</div>
                </div>
                <div class="tiempo-transcurrido">‚è±Ô∏è ${tiempoTexto}</div>
            </div>
            <div class="orden-body">
                <div class="estado-resumen">
                    <div class="estado-item">
                        <span class="estado-numero">${orden.productos_listos_count}</span>
                        <div class="estado-label">Listos</div>
                    </div>
                    <div class="estado-item">
                        <span class="estado-numero">${orden.productos_pendientes_count}</span>
                        <div class="estado-label">Pendientes</div>
                    </div>
                    <div class="estado-item">
                        <span class="estado-numero">${orden.productos_agregados_count || 0}</span>
                        <div class="estado-label">Agregados</div>
                    </div>
                    <div class="estado-item">
                        <span class="estado-numero">${orden.total.toLocaleString()}</span>
                        <div class="estado-label">Total</div>
                    </div>
                </div>
                
                <div class="productos-existentes">
                    ${productosHtml}
                </div>
                
                ${alertaAtencionHtml}
                
                <div class="orden-footer">
                    <div class="orden-total">
                        Total: ${orden.total.toLocaleString()}
                    </div>
                    <div class="acciones-orden">
                        <button class="btn btn-peque√±o btn-modificar" 
                                onclick="modificarOrden(${orden.mesa.id})">
                            ‚úèÔ∏è Modificar
                        </button>
                        ${orden.necesita_atencion ? `
                            <button class="btn btn-peque√±o btn-entregar" 
                                    onclick="entregarOrden(${orden.orden_id})">
                                üçΩÔ∏è Entregar
                            </button>
                            <button class="btn btn-peque√±o btn-ver-cocina" 
                                    onclick="irAVistaCocina()">
                                üë®‚Äçüç≥ Ver Cocina
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        return ordenCard;
    }

    // === FUNCIONES DE ACCI√ìN ===
    window.modificarOrden = function(mesaId) {
        // Cambiar a pesta√±a de modificar orden y preseleccionar mesa
        document.querySelector('[data-tab="modificar-orden"]').click();
        
        // Dar tiempo para que la pesta√±a se cargue y luego seleccionar la mesa
        setTimeout(() => {
            const mesaBtn = document.querySelector(`[data-mesa-id="${mesaId}"]`);
            if (mesaBtn) {
                mesaBtn.click();
            }
        }, 500);
    };

    window.entregarOrden = async function(ordenId) {
        if (!confirm('¬øConfirmas que esta orden ha sido entregada al cliente?\n\nSe generar√° una factura pendiente de pago.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/mesero/orden/${ordenId}/entregar/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken
                }
            });
            
            const result = await response.json();
            
            if (response.ok) {
                window.mostrarNotificacion(
                    `‚úÖ ${result.mensaje}\nüí∞ Factura generada por ${result.total.toLocaleString()}`, 
                    'success'
                );
                
                // Recargar la lista
                cargarMisOrdenes();
                
            } else {
                window.mostrarNotificacion(`‚ùå Error: ${result.error}`, 'error');
            }
            
        } catch (error) {
            console.error('Error entregando orden:', error);
            window.mostrarNotificacion('üîå Error de conexi√≥n', 'error');
        }
    };

    window.irAVistaCocina = function() {
        document.querySelector('[data-tab="vista-cocina"]').click();
    };

    // === MOSTRAR ERROR ===
    function mostrarError(mensaje) {
        const container = document.getElementById('mis-ordenes-container');
        container.innerHTML = `
            <div class="estado-vacio">
                <h3>‚ùå ${mensaje}</h3>
                <p>Hubo un problema al cargar la informaci√≥n.</p>
                <button class="btn" onclick="window.inicializar_mis_ordenes()">üîÑ Reintentar</button>
            </div>
        `;
    }

    // === FILTROS ===
    document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Actualizar bot√≥n activo
            document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Cambiar filtro y renderizar
            filtroActual = btn.dataset.filtro;
            aplicarFiltroYRenderizar();
        });
    });

    // === INICIALIZACI√ìN ===
    cargarMisOrdenes(); // Carga inicial
    
    // Actualizaci√≥n autom√°tica cada 15 segundos
    const intervalId = setInterval(cargarMisOrdenes, 15000);
    
    console.log('‚úÖ Mis √≥rdenes inicializado');
    
    // Cleanup cuando se cambie de pesta√±a
    return function cleanup() {
        clearInterval(intervalId);
    };
};

// Funci√≥n de actualizaci√≥n (llamada por long polling)
window.actualizar_mis_ordenes = function() {
    // Recargar mis √≥rdenes cuando hay cambios
    if (document.getElementById('mis-ordenes-container')) {
        fetch('/api/mesero/ordenes/')
            .then(response => response.json())
            .then(ordenes => {
                console.log('üîÑ Mis √≥rdenes actualizadas por long polling');
                // Aqu√≠ podr√≠as implementar una actualizaci√≥n m√°s inteligente
                // comparando con los datos actuales
            })
            .catch(error => console.error('Error en actualizaci√≥n autom√°tica:', error));
    }
};
</script>