<!-- ARCHIVO COMPLETO: templates/mesero/modificar_orden.html -->

<style>
    /* Estilos espec√≠ficos para modificar orden */
    .mesa-selector { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 2rem; 
    }
    
    .mesa-btn { 
        padding: 1.2rem; 
        border: 2px solid var(--gris-piedra); 
        background: white; 
        border-radius: 8px; 
        cursor: pointer; 
        text-align: center; 
        transition: all 0.3s; 
        position: relative;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .mesa-btn:hover { 
        border-color: var(--naranja-tostado); 
        background-color: rgba(232, 119, 46, 0.1); 
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(232, 119, 46, 0.2);
    }
    
    .mesa-btn.ocupada { 
        border-color: var(--amarillo-modificado); 
        background-color: rgba(255, 193, 7, 0.1); 
    }
    
    .mesa-btn.domicilio { 
        border-color: #17a2b8; 
        background-color: rgba(23, 162, 184, 0.1); 
    }
    
    .mesa-btn.reserva { 
        border-color: #6f42c1; 
        background-color: rgba(111, 66, 193, 0.1); 
    }
    
    .mesa-btn.seleccionada { 
        border-color: var(--naranja-tostado); 
        background-color: var(--naranja-tostado); 
        color: white; 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(232, 119, 46, 0.4);
    }
    
    .mesa-numero { 
        font-size: 1.1em; 
        font-weight: 700; 
        margin-bottom: 0.5rem; 
    }
    
    .mesa-info { 
        font-size: 0.75em; 
        opacity: 0.8; 
        margin-bottom: 0.25rem; 
    }
    
    .cliente-info { 
        font-size: 0.7em; 
        font-weight: 600; 
        color: var(--naranja-tostado); 
        margin-top: 0.5rem; 
        line-height: 1.2;
    }
    
    .mesa-btn.seleccionada .cliente-info {
        color: white;
        opacity: 0.9;
    }
    
    .mesa-estado { 
        position: absolute; 
        top: 8px; 
        right: 8px; 
        background: var(--amarillo-modificado); 
        color: white; 
        border-radius: 50%; 
        width: 26px; 
        height: 26px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 12px; 
        font-weight: bold;
    }
    
    .estado-domicilio { background: #17a2b8; }
    .estado-reserva { background: #6f42c1; }
    
    .orden-existente { 
        background-color: rgba(23, 162, 184, 0.1); 
        border: 1px solid var(--azul-info); 
        border-radius: 8px; 
        padding: 1.5rem; 
        margin-bottom: 2rem; 
    }
    
    .orden-existente h3 { 
        color: var(--azul-info); 
        margin-bottom: 1rem; 
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .productos-existentes { font-size: 0.9em; }
    
    .producto-existente { 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 0.5rem 0; 
        border-bottom: 1px solid rgba(23, 162, 184, 0.2);
    }
    
    .producto-existente:last-child { border-bottom: none; }
    
    .producto-existente.listo { 
        color: var(--verde-listo); 
        font-weight: 600; 
    }
    
    .producto-existente.agregado-despues { 
        color: var(--amarillo-modificado); 
        font-weight: 600; 
        background-color: rgba(255, 193, 7, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.25rem 0;
        border-left: 4px solid var(--amarillo-modificado);
    }
    
    .dashboard-grid-modificar { 
        display: grid; 
        grid-template-columns: 2fr 1fr; 
        gap: 2rem; 
        margin-top: 1rem; 
    }
    
    .btn-agregar-disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
    }
    
    /* Estilos para categor√≠as y productos */
    .category-tabs { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        margin-bottom: 1.5rem; 
        border-bottom: 2px solid var(--gris-piedra); 
        padding-bottom: 1rem; 
    }
    
    .category-btn { 
        background-color: transparent; 
        border: 1px solid var(--naranja-tostado); 
        color: var(--naranja-tostado); 
        padding: 0.5rem 1rem; 
        border-radius: 20px; 
        cursor: pointer; 
        transition: all 0.2s; 
        font-size: 14px;
    }
    
    .category-btn:hover, .category-btn.active { 
        background-color: var(--naranja-tostado); 
        color: white; 
    }
    
    .product-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
        gap: 1.5rem; 
    }
    
    .product-item { 
        border: 1px solid var(--gris-piedra); 
        border-radius: 8px; 
        padding: 1rem; 
        text-align: center; 
        display: flex; 
        flex-direction: column; 
    }
    
    .product-item h4, .product-item p { margin: 0.25rem 0; }
    
    .quantity-selector { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        margin: 1rem 0; 
    }
    
    .quantity-btn { 
        width: 40px; 
        height: 40px; 
        border: 1px solid var(--gris-piedra); 
        background-color: #fff; 
        font-size: 24px; 
        font-weight: bold; 
        cursor: pointer; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 0; 
        line-height: 1; 
    }
    
    .quantity-value { 
        width: 50px; 
        font-size: 18px; 
        font-weight: 600; 
        text-align: center; 
    }
    
    .observaciones-input { 
        font-size: 12px; 
        padding: 5px; 
        margin-top: auto; 
        border: 1px solid var(--gris-piedra); 
        border-radius: 4px; 
        width: 100%; 
        box-sizing: border-box; 
    }
    
    .order-item { 
        display: grid; 
        grid-template-columns: 1fr 120px; 
        gap: 1rem; 
        align-items: center; 
        padding: 0.75rem 0; 
        border-bottom: 1px solid #eee; 
    }
    
    .order-item-info { font-weight: 600; }
    .order-item-obs { 
        font-size: 0.8em; 
        color: #666; 
        grid-column: 1 / 3; 
    }
    
    .order-total { 
        text-align: right; 
        font-size: 1.2rem; 
        font-family: var(--fuente-titulos); 
        margin: 1rem 0; 
    }
    
    @media (max-width: 900px) {
        .dashboard-grid-modificar { grid-template-columns: 1fr; }
        .mesa-selector { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        .product-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
</style>

<h2>üîß Modificar Orden Existente</h2>
<p>Selecciona una mesa, domicilio o reserva activa para agregar productos:</p>

<!-- Selector de mesas ocupadas -->
<div class="mesa-selector" id="mesas-ocupadas-container">
    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
        ‚è≥ Cargando mesas ocupadas...
    </div>
</div>

<!-- Informaci√≥n de la orden actual (oculto inicialmente) -->
<div id="orden-actual-info" style="display: none;"></div>

<!-- Contenedor para agregar productos (oculto inicialmente) -->
<div id="agregar-productos-container" style="display: none;">
    <hr>
    <h3>‚ûï Agregar Productos a la Orden</h3>
    
    <div class="dashboard-grid-modificar">
        <!-- Men√∫ de productos para modificar -->
        <div id="menu-productos-modificar">
            <div class="category-tabs">
                <button class="category-btn active" data-category-id="all" data-context="modificar">Todos</button>
                {% for categoria in categorias %}
                <button class="category-btn" data-category-id="{{ categoria.id }}" data-context="modificar">{{ categoria.nombre }}</button>
                {% endfor %}
            </div>
            
            <div class="product-grid" id="productos-modificar">
                <!-- Se llenar√°n din√°micamente -->
            </div>
        </div>
        
        <!-- Resumen de modificaci√≥n -->
        <div id="resumen-modificacion">
            <h3>üì¶ Productos a Agregar</h3>
            <div id="lista-productos-agregar">
                <p style="color: #888; text-align: center;">Selecciona productos para agregar.</p>
            </div>
            <hr>
            <div class="order-total">
                <strong>Adicional: $<span id="total-adicional">0</span></strong>
            </div>
            <button id="btn-agregar-productos" class="btn btn-agregar-disabled" style="width: 100%;" disabled>
                Agregar a la Orden
            </button>
        </div>
    </div>
</div>

<script>
// ‚úÖ DEFINIR LA FUNCI√ìN GLOBALMENTE PRIMERO
window.inicializar_modificar_orden = function() {
    console.log('üîß Inicializando modificar orden...');
    
    const ordenModificar = {}; // Para productos a agregar
    let ordenSeleccionadaId = null;
    let mesaSeleccionadaId = null;

    // === CARGAR MESAS OCUPADAS ===
    function cargarMesasOcupadas() {
        const container = document.getElementById('mesas-ocupadas-container');
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">‚è≥ Cargando mesas ocupadas...</div>';
        
        fetch('/api/mesero/mesas-ocupadas/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(mesas => {
                console.log('üè† Mesas cargadas:', mesas);
                
                if (mesas.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #888;">
                            <h3>üòä ¬°No hay √≥rdenes activas!</h3>
                            <p>No hay mesas, domicilios o reservas para modificar en este momento.</p>
                            <button class="btn" onclick="cargarMesasOcupadas()">üîÑ Actualizar</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                mesas.forEach(mesa => {
                    const mesaBtn = document.createElement('div');
                    let clases = 'mesa-btn ocupada';
                    let iconoEstado = 'üçΩÔ∏è';
                    let clienteInfo = '';
                    
                    // ‚úÖ DETERMINAR TIPO DE ORDEN
                    if (mesa.es_domicilio) {
                        clases += ' domicilio';
                        iconoEstado = 'üöö';
                        if (mesa.cliente_nombre) {
                            clienteInfo = `<div class="cliente-info">üë§ ${mesa.cliente_nombre}</div>`;
                            if (mesa.direccion && mesa.direccion.length > 0) {
                                const direccionCorta = mesa.direccion.length > 30 ? 
                                    mesa.direccion.substring(0, 30) + '...' : 
                                    mesa.direccion;
                                clienteInfo += `<div class="cliente-info">üìç ${direccionCorta}</div>`;
                            }
                            if (mesa.telefono) {
                                clienteInfo += `<div class="cliente-info">üìû ${mesa.telefono}</div>`;
                            }
                        }
                    } else if (mesa.es_reserva) {
                        clases += ' reserva';
                        iconoEstado = 'üìÖ';
                        if (mesa.cliente_nombre) {
                            clienteInfo = `<div class="cliente-info">üë§ ${mesa.cliente_nombre}</div>`;
                            if (mesa.telefono) {
                                clienteInfo += `<div class="cliente-info">üìû ${mesa.telefono}</div>`;
                            }
                            if (mesa.fecha_reserva) {
                                clienteInfo += `<div class="cliente-info">üìÖ ${mesa.fecha_reserva}</div>`;
                            }
                        }
                    }
                    
                    mesaBtn.className = clases;
                    mesaBtn.dataset.mesaId = mesa.mesa_real_id || mesa.id;
                    mesaBtn.dataset.ordenId = mesa.orden_id;
                    
                    mesaBtn.innerHTML = `
                        <div class="mesa-estado ${mesa.es_domicilio ? 'estado-domicilio' : (mesa.es_reserva ? 'estado-reserva' : '')}">${iconoEstado}</div>
                        <div class="mesa-numero">${mesa.numero}</div>
                        <div class="mesa-info">${mesa.ubicacion}</div>
                        <div class="mesa-info">${mesa.productos_count} productos</div>
                        ${clienteInfo}
                    `;
                    
                    mesaBtn.addEventListener('click', () => seleccionarMesaParaModificar(mesa.orden_id, mesa.mesa_real_id || mesa.id));
                    container.appendChild(mesaBtn);
                });
            })
            .catch(error => {
                console.error('‚ùå Error cargando mesas ocupadas:', error);
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <div class="error-message">
                            <strong>‚ùå Error al cargar mesas</strong><br>
                            ${error.message}<br>
                            <button class="btn" onclick="cargarMesasOcupadas()">üîÑ Reintentar</button>
                        </div>
                    </div>
                `;
            });
    }

    // === SELECCIONAR MESA PARA MODIFICAR ===
    function seleccionarMesaParaModificar(ordenId, mesaId) {
        console.log('üéØ Seleccionando orden:', ordenId, 'mesa:', mesaId);
        
        // Actualizar UI de selecci√≥n
        document.querySelectorAll('.mesa-btn').forEach(btn => btn.classList.remove('seleccionada'));
        document.querySelector(`[data-orden-id="${ordenId}"]`).classList.add('seleccionada');
        mesaSeleccionadaId = mesaId;
        ordenSeleccionadaId = ordenId;
        
        // Mostrar loading
        const infoContainer = document.getElementById('orden-actual-info');
        infoContainer.style.display = 'block';
        infoContainer.innerHTML = '<div style="text-align: center; padding: 1rem;">‚è≥ Cargando informaci√≥n de la orden...</div>';
        
        // Obtener orden actual de la mesa
        fetch(`/api/mesa/${mesaId}/orden/`)
            .then(response => response.json())
            .then(ordenData => {
                if (ordenData.error) {
                    throw new Error(ordenData.error);
                }
                console.log('üìã Orden cargada:', ordenData);
                mostrarOrdenActual(ordenData);
                prepararMenuModificacion();
                document.getElementById('agregar-productos-container').style.display = 'block';
            })
            .catch(error => {
                console.error('‚ùå Error obteniendo orden:', error);
                infoContainer.innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Error al cargar la orden</strong><br>
                        ${error.message}
                    </div>
                `;
            });
    }

    // === MOSTRAR ORDEN ACTUAL ===
    function mostrarOrdenActual(ordenData) {
        const container = document.getElementById('orden-actual-info');
        
        let productosHtml = '';
        let estadoGeneral = '';
        let totalOriginal = 0;
        let productosOriginales = 0;
        let productosAgregados = 0;
        
        // ‚úÖ DETERMINAR TIPO DE ORDEN Y EXTRAER INFO CLIENTE
        const esDomicilio = ordenData.mesa.numero === 0;
        const esReserva = ordenData.mesa.numero === 50;
        let tipoOrden = 'Mesa';
        let iconoTipo = 'üçΩÔ∏è';
        let infoCliente = '';
        
        if (esDomicilio) {
            tipoOrden = 'Domicilio';
            iconoTipo = 'üöö';
            // Extraer info del cliente de observaciones
            if (ordenData.observaciones) {
                const clienteMatch = ordenData.observaciones.match(/Cliente:\s*([^,]+)/i);
                const direccionMatch = ordenData.observaciones.match(/Dir(?:ecci√≥n)?:\s*([^,\n]+)/i);
                const telefonoMatch = ordenData.observaciones.match(/Tel(?:√©fono)?:\s*([^,]+)/i);
                
                if (clienteMatch) {
                    infoCliente = `<div style="background: rgba(23, 162, 184, 0.1); padding: 0.8rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #17a2b8;">
                        <strong>üöö Informaci√≥n del Domicilio</strong><br>
                        <strong>üë§ Cliente:</strong> ${clienteMatch[1].trim()}<br>
                        ${direccionMatch ? `<strong>üìç Direcci√≥n:</strong> ${direccionMatch[1].trim()}<br>` : ''}
                        ${telefonoMatch ? `<strong>üìû Tel√©fono:</strong> ${telefonoMatch[1].trim()}` : ''}
                    </div>`;
                }
            }
        } else if (esReserva) {
            tipoOrden = 'Reserva';
            iconoTipo = 'üìÖ';
            // Extraer info del cliente de observaciones
            if (ordenData.observaciones) {
                const clienteMatch = ordenData.observaciones.match(/(?:Reserva|Cliente):\s*([^,]+)/i);
                const personasMatch = ordenData.observaciones.match(/Personas?:\s*(\d+)/i);
                const fechaMatch = ordenData.observaciones.match(/Fecha:\s*([^,\n]+)/i);
                const telefonoMatch = ordenData.observaciones.match(/Tel(?:√©fono)?:\s*([^,]+)/i);
                
                if (clienteMatch) {
                    infoCliente = `<div style="background: rgba(111, 66, 193, 0.1); padding: 0.8rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #6f42c1;">
                        <strong>üìÖ Informaci√≥n de la Reserva</strong><br>
                        <strong>üë§ Cliente:</strong> ${clienteMatch[1].trim()}<br>
                        ${personasMatch ? `<strong>üë• Personas:</strong> ${personasMatch[1]}<br>` : ''}
                        ${fechaMatch ? `<strong>üìÖ Fecha:</strong> ${fechaMatch[1].trim()}<br>` : ''}
                        ${telefonoMatch ? `<strong>üìû Tel√©fono:</strong> ${telefonoMatch[1].trim()}` : ''}
                    </div>`;
                }
            }
        }
        
        // Procesar productos
        ordenData.productos.forEach(p => {
            const subtotal = p.cantidad * p.precio_unitario;
            totalOriginal += subtotal;
            
            let claseProducto = '';
            let iconoEstado = '';
            let tipoTexto = '';
            
            if (p.agregado_despues) {
                claseProducto = 'agregado-despues';
                tipoTexto = 'üÜï Agregado despu√©s';
                productosAgregados++;
            } else {
                productosOriginales++;
            }
            
            if (p.estado === 'LISTO') {
                claseProducto += ' listo';
                iconoEstado = '‚úÖ';
            } else {
                iconoEstado = '‚è≥';
            }
            
            productosHtml += `
                <div class="producto-existente ${claseProducto}">
                    <div>
                        <span>${iconoEstado} ${p.cantidad}x ${p.nombre}</span>
                        ${tipoTexto ? `<div style="font-size: 0.8em; margin-top: 2px;">${tipoTexto}</div>` : ''}
                        ${p.observaciones ? `<div style="font-size: 0.8em; color: var(--naranja-tostado); font-style: italic;">üìù ${p.observaciones}</div>` : ''}
                    </div>
                    <span>$${subtotal.toLocaleString()}</span>
                </div>
            `;
        });
        
        // Determinar estado general
        const productosListos = ordenData.productos.filter(p => p.estado === 'LISTO').length;
        const productosPendientes = ordenData.productos.length - productosListos;
        
        if (productosListos === 0) {
            estadoGeneral = '‚è≥ En preparaci√≥n';
        } else if (productosPendientes === 0) {
            estadoGeneral = '‚úÖ Lista para servir';
        } else {
            estadoGeneral = `üîÑ Parcial (${productosListos}/${ordenData.productos.length} listos)`;
        }
        
        container.innerHTML = `
            <div class="orden-existente">
                <h3>
                    ${iconoTipo} Orden Actual - ${tipoOrden} ${esDomicilio || esReserva ? '' : `#${ordenData.mesa.numero}`}
                    <span style="margin-left: auto; font-size: 0.8em; color: #666;">${estadoGeneral}</span>
                </h3>
                
                ${infoCliente}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem; margin-top: 1rem; font-size: 0.9em;">
                    <div><strong>Productos originales:</strong> ${productosOriginales}</div>
                    <div><strong>Agregados despu√©s:</strong> ${productosAgregados}</div>
                    <div><strong>Total productos:</strong> ${ordenData.productos.length}</div>
                </div>
                
                <div class="productos-existentes">
                    ${productosHtml}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(23, 162, 184, 0.2);">
                    <div><strong>Total actual: $${totalOriginal.toLocaleString()}</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Estado: ${ordenData.estado}</div>
                </div>
                
                ${ordenData.observaciones && !esDomicilio && !esReserva ? `
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 0.8rem; border-radius: 4px; margin-top: 1rem; border-left: 4px solid var(--amarillo-modificado);">
                        <strong>üìù Observaciones adicionales:</strong><br>
                        <em>${ordenData.observaciones}</em>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // === PREPARAR MEN√ö DE MODIFICACI√ìN ===
    function prepararMenuModificacion() {
        // Limpiar orden de modificaci√≥n
        Object.keys(ordenModificar).forEach(key => delete ordenModificar[key]);
        
        // Obtener productos originales y clonar al √°rea de modificaci√≥n
        const menuOriginal = document.querySelector('#menu-productos .product-grid');
        const menuModificar = document.getElementById('productos-modificar');
        
        if (menuOriginal) {
            menuModificar.innerHTML = menuOriginal.innerHTML;
            
            // Resetear cantidades en el men√∫ de modificaci√≥n
            menuModificar.querySelectorAll('.quantity-value').forEach(el => el.textContent = '0');
            menuModificar.querySelectorAll('.observaciones-input').forEach(el => el.value = '');
        } else {
            // Si no hay men√∫ original, crear mensaje de ayuda
            menuModificar.innerHTML = `
                <p style="color: #666; text-align: center; grid-column: 1 / -1; padding: 2rem;">
                    ‚ö†Ô∏è No se pudo cargar el men√∫ de productos.<br>
                    <button class="btn" onclick="window.recargarPestana('nuevo-pedido')" style="margin-top: 1rem;">üîÑ Cargar desde Nuevo Pedido</button>
                </p>
            `;
            return;
        }
        
        // Agregar event listeners para el men√∫ de modificaci√≥n
        menuModificar.addEventListener('click', e => {
            if (e.target.classList.contains('quantity-btn')) {
                const id = e.target.closest('.product-item').dataset.id;
                manejarCambioCantidad(id, e.target.dataset.action);
            }
        });
        
        menuModificar.addEventListener('input', e => {
            if (e.target.classList.contains('observaciones-input')) {
                const id = e.target.closest('.product-item').dataset.id;
                if (ordenModificar[id]) {
                    ordenModificar[id].observaciones = e.target.value;
                    actualizarResumenModificacion();
                }
            }
        });
        
        actualizarResumenModificacion();
    }

    // === MANEJAR CAMBIOS DE CANTIDAD ===
    function manejarCambioCantidad(id, accion) {
        const productItem = document.querySelector(`#productos-modificar .product-item[data-id="${id}"]`);
        if (!productItem) return;
        
        const stock = parseInt(productItem.dataset.stock, 10);
        let cantidadActual = ordenModificar[id] ? ordenModificar[id].cantidad : 0;

        if (accion === 'increment' && cantidadActual < stock) {
            cantidadActual++;
        } else if (accion === 'decrement' && cantidadActual > 0) {
            cantidadActual--;
        }

        if (cantidadActual > 0) {
            if (!ordenModificar[id]) {
                ordenModificar[id] = {
                    id: id,
                    nombre: productItem.dataset.nombre,
                    precio: parseFloat(productItem.dataset.precio),
                    observaciones: productItem.querySelector('.observaciones-input').value
                };
            }
            ordenModificar[id].cantidad = cantidadActual;
        } else {
            delete ordenModificar[id];
        }

        // Actualizar UI del producto
        productItem.querySelector('.quantity-value').textContent = cantidadActual;
        
        actualizarResumenModificacion();
    }

    // === ACTUALIZAR RESUMEN DE MODIFICACI√ìN ===
    function actualizarResumenModificacion() {
        const container = document.getElementById('lista-productos-agregar');
        const totalEl = document.getElementById('total-adicional');
        const btnAgregar = document.getElementById('btn-agregar-productos');
        
        container.innerHTML = '';
        let totalAdicional = 0;
        
        if (Object.keys(ordenModificar).length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center;">Selecciona productos para agregar.</p>';
            btnAgregar.disabled = true;
            btnAgregar.classList.add('btn-agregar-disabled');
        } else {
            btnAgregar.disabled = false;
            btnAgregar.classList.remove('btn-agregar-disabled');
            Object.values(ordenModificar).forEach(item => {
                const subtotal = item.cantidad * item.precio;
                totalAdicional += subtotal;
                container.innerHTML += `
                    <div class="order-item">
                        <span class="order-item-info">${item.cantidad}x ${item.nombre}</span>
                        <span>${subtotal.toLocaleString()}</span>
                        ${item.observaciones ? `<div class="order-item-obs">üìù ${item.observaciones}</div>` : ''}
                    </div>
                `;
            });
        }
        
        totalEl.textContent = totalAdicional.toLocaleString();
    }

    // === FILTROS DE CATEGOR√çAS PARA MODIFICACI√ìN ===
    document.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.context === 'modificar') {
            const selectedCategoryId = e.target.dataset.categoryId;
            const parentContainer = e.target.closest('#agregar-productos-container');
            const categoryButtons = parentContainer.querySelectorAll('[data-context="modificar"]');
            const productItems = parentContainer.querySelectorAll('.product-item');
            
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            productItems.forEach(item => {
                if (selectedCategoryId === 'all' || item.dataset.categoryId === selectedCategoryId) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    });

    // === ENVIAR PRODUCTOS ADICIONALES ===
    document.getElementById('btn-agregar-productos').addEventListener('click', async () => {
        if (!ordenSeleccionadaId || Object.keys(ordenModificar).length === 0) {
            alert('Selecciona productos para agregar');
            return;
        }
        
        const productosParaAgregar = Object.values(ordenModificar).map(p => ({
            id: p.id,
            cantidad: p.cantidad,
            observaciones: p.observaciones || ''
        }));
        
        const totalAdicional = productosParaAgregar.reduce((sum, p) => sum + (p.cantidad * p.precio), 0);
        
        // Confirmar antes de enviar
        const confirmacion = confirm(
            `¬øConfirmar agregar productos a la orden?\n\n` +
            `Productos a agregar: ${productosParaAgregar.length}\n` +
            `Costo adicional: ${totalAdicional.toLocaleString()}\n\n` +
            `¬øProceder?`
        );
        
        if (!confirmacion) return;
        
        // Deshabilitar bot√≥n mientras se procesa
        const btnAgregar = document.getElementById('btn-agregar-productos');
        const textoOriginal = btnAgregar.textContent;
        btnAgregar.disabled = true;
        btnAgregar.textContent = '‚è≥ Agregando productos...';
        
        try {
            const response = await fetch(`/api/orden/${ordenSeleccionadaId}/agregar-productos/`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': window.csrfToken 
                },
                body: JSON.stringify({ productos: productosParaAgregar })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                window.mostrarNotificacion(`‚úÖ ${result.mensaje}`, 'success');
                
                // Limpiar formulario
                Object.keys(ordenModificar).forEach(key => delete ordenModificar[key]);
                actualizarResumenModificacion();
                
                // Recargar la informaci√≥n de la orden
                if (ordenSeleccionadaId && mesaSeleccionadaId) {
                    seleccionarMesaParaModificar(ordenSeleccionadaId, mesaSeleccionadaId);
                }
                
                // Sugerir ir a vista de cocina
                setTimeout(() => {
                    if (confirm('¬øQuieres ver el estado actualizado de la orden en la cocina?')) {
                        document.querySelector('[data-tab="vista-cocina"]').click();
                    }
                }, 2000);
                
            } else {
                window.mostrarNotificacion(`‚ùå Error: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error('‚ùå Error agregando productos:', error);
            window.mostrarNotificacion('üîå Error de conexi√≥n al agregar productos', 'error');
        } finally {
            // Rehabilitar bot√≥n
            btnAgregar.disabled = false;
            btnAgregar.textContent = textoOriginal;
        }
    });

    // === HACER FUNCIONES DISPONIBLES GLOBALMENTE ===
    window.cargarMesasOcupadas = cargarMesasOcupadas;

    // === INICIALIZACI√ìN ===
    cargarMesasOcupadas();
    
    console.log('‚úÖ Modificar orden inicializado correctamente');
    
    // Retornar funci√≥n de cleanup
    return function cleanup() {
        console.log('üßπ Limpiando modificar orden');
        // Limpiar event listeners si es necesario
        const container = document.getElementById('agregar-productos-container');
        if (container) {
            container.style.display = 'none';
        }
    };
};

// Funci√≥n de actualizaci√≥n (llamada por long polling)
window.actualizar_modificar_orden = function() {
    // Recargar mesas ocupadas si hay cambios
    if (typeof window.cargarMesasOcupadas === 'function') {
        console.log('üîÑ Actualizando mesas ocupadas...');
        window.cargarMesasOcupadas();
    }
    console.log('üîÑ Actualizando modificar orden por long polling');
};

// Hacer la funci√≥n de inicializaci√≥n disponible globalmente antes de que se llame
console.log('‚úÖ Funci√≥n inicializar_modificar_orden definida globalmente');
</script>