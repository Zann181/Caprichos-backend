<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modificar √ìrdenes - Sistema Restaurante</title>
    <style>
        /* === VARIABLES CSS === */
        :root {
            --naranja-tostado: #e8772e;
            --azul-info: #17a2b8;
            --verde-listo: #28a745;
            --carbon-suave: #343a40;
            --gris-piedra: #dee2e6;
            --blanco-hueso: #f8f9fa;
            --rojo-error: #dc3545;
            --amarillo-warning: #ffc107;
        }

        /* === RESET Y BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: var(--carbon-suave);
            line-height: 1.6;
        }

        /* === CONTENEDOR PRINCIPAL === */
        .modificar-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--carbon-suave), #495057);
            color: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .page-header h2 {
            font-size: 2.5em;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .page-header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* === FILTROS PRINCIPALES === */
        .filtros-principales {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid var(--gris-piedra);
            border-radius: 12px;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filtro-grupo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 200px;
        }

        .filtro-label {
            font-weight: 700;
            color: var(--carbon-suave);
            font-size: 0.95em;
            white-space: nowrap;
            min-width: 60px;
        }

        .filtro-botones {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .filtro-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 600;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .filtro-btn:hover {
            border-color: var(--naranja-tostado);
            background: linear-gradient(135deg, rgba(232, 119, 46, 0.1), rgba(232, 119, 46, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 119, 46, 0.2);
        }

        .filtro-btn.active {
            background: linear-gradient(135deg, var(--naranja-tostado), #d9642a);
            color: white;
            border-color: var(--naranja-tostado);
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(232, 119, 46, 0.4);
        }

        .btn-actualizar {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--azul-info), #0e7bb8);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 700;
            transition: all 0.3s ease;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        .btn-actualizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(23, 162, 184, 0.4);
        }

        /* === TABLA DE √ìRDENES === */
        .ordenes-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 2rem;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }

        .ordenes-table-header {
            display: grid;
            grid-template-columns: 120px 1fr 200px 150px 120px 200px;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, var(--carbon-suave), #495057);
            color: white;
            font-weight: 700;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* === TARJETAS DE ORDEN === */
        .orden-item {
            display: grid;
            grid-template-columns: 120px 1fr 200px 150px 120px 200px;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
            align-items: center;
            min-height: 70px;
        }

        .orden-item:hover {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            transform: translateX(4px);
            box-shadow: 4px 0 0 0 var(--naranja-tostado);
        }

        .orden-item.seleccionada {
            background: linear-gradient(135deg, rgba(232, 119, 46, 0.05), rgba(232, 119, 46, 0.02));
            box-shadow: 4px 0 0 0 var(--naranja-tostado), 0 2px 8px rgba(232, 119, 46, 0.1);
            transform: translateX(4px);
        }

        .orden-item.expandida {
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #fff, #f8f9fa);
        }

        /* === INDICADORES DE ESTADO === */
        .orden-item.en-proceso::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ffc107, #e0a800);
        }

        .orden-item.lista::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #28a745, #20c997);
        }

        .orden-item.servida::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #6c757d, #5a6268);
        }

        .orden-item.factura-pendiente::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #dc3545, #c82333);
        }

        .orden-item.factura-pagada::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #20c997, #17a2b8);
        }

        /* === COLUMNAS DE LA TABLA === */
        .orden-mesa {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--carbon-suave);
        }

        .orden-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 0;
        }

        .orden-titulo {
            font-weight: 700;
            color: var(--carbon-suave);
            font-size: 1em;
            margin: 0;
        }

        .orden-descripcion {
            font-size: 0.85em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .productos-preview {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
            margin-top: 0.25rem;
        }

        .orden-estado {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .estado-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
            white-space: nowrap;
        }

        .estado-badge.en-proceso {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffc107;
        }

        .estado-badge.lista {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #28a745;
        }

        .estado-badge.servida {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 1px solid #6c757d;
        }

        .estado-badge.factura-pendiente {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .estado-badge.factura-pagada {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #17a2b8;
        }

        .orden-mesero, .orden-total {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .total-valor {
            font-size: 1.2em;
            font-weight: 800;
            color: var(--naranja-tostado);
        }

        .orden-acciones {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* === BOTONES DE ACCI√ìN === */
        .btn-accion {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            min-width: 80px;
            white-space: nowrap;
        }

        .btn-modificar {
            background: linear-gradient(135deg, var(--naranja-tostado), #d9642a);
            color: white;
            box-shadow: 0 2px 8px rgba(232, 119, 46, 0.3);
        }

        .btn-modificar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 119, 46, 0.4);
        }

        .btn-entregar {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-entregar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-ver-factura {
            background: linear-gradient(135deg, var(--azul-info), #0e7bb8);
            color: white;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        .btn-ver-factura:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
        }

        /* === DETALLES EXPANDIDOS === */
        .orden-detalles {
            grid-column: 1 / -1;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-top: 2px solid var(--gris-piedra);
            margin-top: 1rem;
            border-radius: 0 0 12px 12px;
            display: none;
            animation: expandirDetalles 0.3s ease-out;
        }

        .orden-detalles.visible {
            display: block;
        }

        @keyframes expandirDetalles {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detalles-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .detalle-seccion {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .detalle-titulo {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--carbon-suave);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gris-piedra);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .productos-lista {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .producto-detalle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #dee2e6;
        }

        .producto-detalle.listo {
            border-left-color: var(--verde-listo);
            background: rgba(40, 167, 69, 0.1);
        }

        .producto-detalle.pendiente {
            border-left-color: var(--amarillo-warning);
            background: rgba(255, 193, 7, 0.1);
        }

        .producto-info {
            flex: 1;
        }

        .producto-nombre {
            font-weight: 600;
            color: var(--carbon-suave);
        }

        .producto-observaciones {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
            margin-top: 0.25rem;
        }

        .producto-estado-icon {
            font-size: 1.2em;
            margin-left: 1rem;
        }

        /* === VENTANAS EMERGENTES (MODALS) === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.visible {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gris-piedra);
        }

        .modal-titulo {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--carbon-suave);
            margin: 0;
        }

        .btn-cerrar-modal {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-cerrar-modal:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #5a6268, #495057);
        }

        /* === MODAL DE MODIFICACI√ìN === */
        .modificacion-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            min-height: 500px;
        }

        .menu-productos {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .categorias-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .categoria-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--naranja-tostado);
            background: white;
            color: var(--naranja-tostado);
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .categoria-btn:hover,
        .categoria-btn.active {
            background: var(--naranja-tostado);
            color: white;
        }

        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .producto-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .producto-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .producto-card.selected {
            border-color: var(--naranja-tostado);
            background: rgba(232, 119, 46, 0.1);
        }

        .carrito-lateral {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .carrito-items {
            margin: 1rem 0;
        }

        .carrito-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .carrito-total {
            font-size: 1.2em;
            font-weight: 700;
            text-align: right;
            margin: 1rem 0;
            padding-top: 1rem;
            border-top: 2px solid var(--gris-piedra);
        }

        .btn-confirmar {
            width: 100%;
            background: var(--verde-listo);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-confirmar:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-confirmar:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* === MODAL DE FACTURA === */
        .factura-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .factura-header {
            background: linear-gradient(135deg, var(--azul-info), #0e7bb8);
            color: white;
            padding: 2rem;
            border-radius: 12px 12px 0 0;
            text-align: center;
            margin: -2rem -2rem 2rem -2rem;
        }

        .factura-numero {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .factura-fecha {
            opacity: 0.9;
        }

        .factura-detalle {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .factura-productos {
            margin: 1.5rem 0;
        }

        .factura-producto {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .factura-total-final {
            background: var(--carbon-suave);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* === ESTADOS ESPECIALES === */
        .estado-vacio {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            border: 3px dashed #dee2e6;
            color: #6c757d;
        }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem;
            color: #666;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .loading::after {
            content: '';
            width: 24px;
            height: 24px;
            border: 3px solid #f0f0f0;
            border-radius: 50%;
            border-top: 3px solid var(--naranja-tostado);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === RESPONSIVE === */
        @media (max-width: 1200px) {
            .ordenes-table-header,
            .orden-item {
                grid-template-columns: 80px 1fr 160px 120px 160px;
                gap: 0.5rem;
            }
            
            .orden-mesero {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .filtros-principales {
                flex-direction: column;
                align-items: stretch;
                gap: 1.5rem;
            }
            
            .filtro-grupo {
                flex-direction: column;
                align-items: stretch;
                min-width: unset;
            }
            
            .ordenes-table-header,
            .orden-item {
                grid-template-columns: 1fr auto;
                gap: 1rem;
                padding: 1rem;
            }
            
            .orden-estado,
            .orden-total,
            .orden-acciones {
                grid-column: 1 / -1;
                margin-top: 0.75rem;
            }
            
            .ordenes-table-header {
                display: none;
            }

            .modificacion-content {
                grid-template-columns: 1fr;
            }

            .detalles-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .modificar-container {
                padding: 0.5rem;
            }
            
            .modal-content {
                padding: 1rem;
                margin: 1rem;
            }
        }

/* === AGREGAR ESTOS ESTILOS AL CSS EXISTENTE === */

/* === BARRA DE B√öSQUEDA === */
.busqueda-container {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.busqueda-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid #dee2e6;
    border-radius: 25px;
    font-size: 1rem;
    transition: all 0.3s;
}

.busqueda-input:focus {
    outline: none;
    border-color: var(--naranja-tostado);
    box-shadow: 0 0 0 3px rgba(232, 119, 46, 0.1);
}

.btn-buscar, .btn-limpiar {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-buscar {
    background: var(--azul-info);
    color: white;
}

.btn-limpiar {
    background: #6c757d;
    color: white;
}

/* === INFORMACI√ìN DE RESULTADOS === */
.info-resultados {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    background: white;
    border-radius: 8px;
    font-size: 0.9em;
    color: #666;
}

/* === PAGINACI√ìN === */
.paginacion-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin: 2rem 0;
    padding: 1rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-wrap: wrap;
}

.btn-pagina {
    padding: 0.75rem 1rem;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    min-width: 45px;
    text-align: center;
}

.btn-pagina:hover:not(:disabled) {
    border-color: var(--naranja-tostado);
    background: rgba(232, 119, 46, 0.1);
    transform: translateY(-2px);
}

.btn-pagina.active {
    background: var(--naranja-tostado);
    color: white;
    border-color: var(--naranja-tostado);
}

.btn-pagina:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.page-size-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: 1rem;
    padding-left: 1rem;
    border-left: 2px solid #dee2e6;
}

.page-size-selector label {
    font-weight: 600;
    color: var(--carbon-suave);
}

.page-size-selector select {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: white;
}

/* === MODAL DE PAGO === */
.modal-pago {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(3px);
}

.modal-pago.visible {
    display: flex;
    animation: fadeInPago 0.3s ease-out;
}

@keyframes fadeInPago {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-pago-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideInPago 0.3s ease-out;
}

@keyframes slideInPago {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-pago-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--gris-piedra);
}

.modal-pago-titulo {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--carbon-suave);
    margin: 0;
}

.btn-cerrar-pago {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2em;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.btn-cerrar-pago:hover {
    transform: scale(1.1);
    background: #c82333;
}

/* === FORMULARIO DE PAGO === */
.form-pago {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-group-pago {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label-pago {
    font-weight: 600;
    color: var(--carbon-suave);
    font-size: 0.95em;
}

.form-input-pago, .form-select-pago, .form-textarea-pago {
    padding: 0.75rem 1rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
    background: white;
}

.form-input-pago:focus, .form-select-pago:focus, .form-textarea-pago:focus {
    outline: none;
    border-color: var(--naranja-tostado);
    box-shadow: 0 0 0 3px rgba(232, 119, 46, 0.1);
}

.form-textarea-pago {
    min-height: 80px;
    resize: vertical;
}

.monto-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    align-items: end;
}

.monto-info {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--azul-info);
}

.monto-total {
    font-size: 1.2em;
    font-weight: 700;
    color: var(--azul-info);
    margin-bottom: 0.5rem;
}

.monto-detalle {
    font-size: 0.9em;
    color: #666;
}

.cambio-info {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    font-weight: 600;
    text-align: center;
    display: none;
}

.cambio-info.positivo {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.cambio-info.negativo {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.botones-pago {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.btn-cancelar-pago {
    flex: 1;
    padding: 1rem;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-cancelar-pago:hover {
    background: #5a6268;
}

.btn-confirmar-pago {
    flex: 2;
    padding: 1rem;
    background: var(--verde-listo);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1.1em;
}

.btn-confirmar-pago:hover {
    background: #1e7e34;
    transform: translateY(-2px);
}

.btn-confirmar-pago:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* === RESPONSIVE PARA PAGINACI√ìN === */
@media (max-width: 768px) {
    .paginacion-container {
        flex-direction: column;
        gap: 1rem;
    }
    
    .page-size-selector {
        margin-left: 0;
        padding-left: 0;
        border-left: none;
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }
    
    .busqueda-container {
        flex-direction: column;
    }
    
    .info-resultados {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
    }
    
    .modal-pago-content {
        padding: 1rem;
        margin: 1rem;
    }
    
    .monto-container {
        grid-template-columns: 1fr;
    }
    
    .botones-pago {
        flex-direction: column;
    }
}
    </style>
</head>
<body>
    <div class="modificar-container">
        <!-- HEADER DE LA P√ÅGINA -->
        <div class="page-header">
            <h2>üîß Modificar √ìrdenes y Facturas</h2>
            <p>Gestiona tus √≥rdenes, agrega productos y maneja facturas de forma din√°mica</p>
        </div>

        <!-- FILTROS PRINCIPALES -->
        <div class="filtros-principales">
            <div class="filtro-grupo">
                <div class="filtro-label">Tipo:</div>
                <div class="filtro-botones">
                    <button class="filtro-btn active" data-tipo="todos">üìã Todos</button>
                    <button class="filtro-btn" data-tipo="ordenes">üçΩÔ∏è Solo √ìrdenes</button>
                    <button class="filtro-btn" data-tipo="facturas">üßæ Solo Facturas</button>
                </div>
            </div>

            <div class="filtro-grupo" id="filtro-estados">
                <div class="filtro-label" id="estados-label">Estado:</div>
                <div class="filtro-botones" id="estados-botones">
                    <button class="filtro-btn" data-estado="EN_PROCESO">‚è≥ En Preparaci√≥n</button>
                    <button class="filtro-btn" data-estado="LISTA">üçΩÔ∏è Lista para Servir</button>
                    <button class="filtro-btn" data-estado="SERVIDA">‚úÖ Servida</button>
                </div>
            </div>

            <button class="btn-actualizar" onclick="cargarOrdenes()">
                üîÑ Actualizar
            </button>
        </div>

        <!-- BARRA DE B√öSQUEDA -->
        <div class="busqueda-container">
            <input type="text" 
                id="busqueda-ordenes" 
                class="busqueda-input" 
                placeholder="üîç Buscar por ID de orden, mesa, productos, n√∫mero de factura...">
            <button class="btn-buscar" onclick="buscarOrdenes()">üîç Buscar</button>
            <button class="btn-limpiar" onclick="limpiarBusqueda()">‚úñÔ∏è Limpiar</button>
        </div>

        <!-- INFORMACI√ìN DE RESULTADOS -->
        <div class="info-resultados">
            <div id="info-resultados">Cargando...</div>
            <div>
                <span id="filtro-actual">Filtro: Todos</span>
            </div>
        </div>


        <!-- TABLA DE √ìRDENES -->
        <div class="ordenes-grid" id="ordenes-container">
            <div class="ordenes-table-header">
                <div>üçΩÔ∏è Mesa</div>
                <div>üìã Informaci√≥n</div>
                <div>üìä Estado</div>
                <div>üë®‚Äçüç≥ Mesero</div>
                <div>üí∞ Total</div>
                <div>‚ö° Acciones</div>
            </div>
            <div class="loading">Cargando √≥rdenes disponibles...</div>
        </div>
    </div>

    <!-- MODAL DE MODIFICACI√ìN -->
    <div class="modal-overlay" id="modal-modificacion">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-titulo" id="modificacion-titulo">Modificar Orden</h3>
                <button class="btn-cerrar-modal" onclick="cerrarModal('modal-modificacion')">‚úï</button>
            </div>
            
            <div class="modificacion-content">
                <div class="menu-productos">
                    <h4>üçΩÔ∏è Agregar Productos</h4>
                    
                    <div class="categorias-tabs">
                        <button class="categoria-btn active" data-categoria="all">Todos</button>
                        <button class="categoria-btn" data-categoria="entradas">ü•ó Entradas</button>
                        <button class="categoria-btn" data-categoria="principales">üçñ Principales</button>
                        <button class="categoria-btn" data-categoria="bebidas">ü•§ Bebidas</button>
                        <button class="categoria-btn" data-categoria="postres">üç∞ Postres</button>
                    </div>
                    
                    <div class="productos-grid" id="productos-grid">
                        <!-- Los productos se cargan din√°micamente -->
                    </div>
                </div>
                
                <div class="carrito-lateral">
                    <h4>üõí Productos a Agregar</h4>
                    <div class="carrito-items" id="carrito-items">
                        <p style="color: #888; text-align: center; font-style: italic;">
                            Selecciona productos del men√∫
                        </p>
                    </div>
                    <div class="carrito-total">
                        Total Adicional: $<span id="total-modificacion">0</span>
                    </div>
                    <button class="btn-confirmar" id="btn-confirmar-modificacion" disabled>
                        Agregar a la Orden
                    </button>
                </div>
            </div>

            <!-- Detalle de la orden actual -->
            <div id="orden-detalle-completo">
                <!-- Se carga din√°micamente -->
            </div>
        </div>
    </div>

    <!-- MODAL DE FACTURA -->
    <div class="modal-overlay" id="modal-factura">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-titulo" id="factura-titulo">Ver Factura</h3>
                <button class="btn-cerrar-modal" onclick="cerrarModal('modal-factura')">‚úï</button>
            </div>
            
            <div class="factura-content" id="factura-content">
                <!-- Se carga din√°micamente -->
            </div>
        </div>
    </div>

    <!-- TEMPLATE PARA ORDEN ITEM -->
    <template id="orden-item-template">
        <div class="orden-item" data-orden-id="" data-tipo="">
            <div class="orden-mesa">
                <span class="mesa-icono"></span>
                <span class="mesa-numero"></span>
            </div>
            
            <div class="orden-info">
                <h4 class="orden-titulo"></h4>
                <div class="orden-descripcion">
                    <span class="productos-count"></span>
                    <span class="tiempo-transcurrido"></span>
                </div>
                <div class="productos-preview"></div>
                <div class="factura-info" style="display: none;">
                    <small>üßæ <span class="factura-numero"></span> - <span class="factura-estado"></span></small>
                </div>
            </div>
            
            <div class="orden-estado">
                <div class="estado-badge"></div>
                <div class="progreso-productos"></div>
            </div>
            
            <div class="orden-mesero">
                <div class="mesero-nombre"></div>
                <div class="mesero-tiempo"></div>
            </div>
            
            <div class="orden-total">
                <div class="total-valor"></div>
                <div class="total-productos"></div>
            </div>
            
            <div class="orden-acciones">
                <!-- Los botones se agregan din√°micamente -->
            </div>

            <!-- DETALLES EXPANDIBLES -->
            <div class="orden-detalles">
                <div class="detalles-grid">
                    <div class="detalle-seccion">
                        <h5 class="detalle-titulo">üìä Informaci√≥n General</h5>
                        <div class="info-general">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="detalle-seccion">
                        <h5 class="detalle-titulo">üçΩÔ∏è Productos de la Orden</h5>
                        <div class="productos-lista">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <div class="detalle-seccion" style="grid-column: 1 / -1;">
                    <h5 class="detalle-titulo">üìù Observaciones</h5>
                    <div class="observaciones-content">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        
    </template>


// templates/mesero/modificar_orden.html - PARTE 3: JAVASCRIPT COMPLETO

<script>

        // Variables globales adicionales
let paginacionData = {
    currentPage: 1,
    totalPages: 1,
    totalCount: 0,
    pageSize: 20,
    hasNext: false,
    hasPrevious: false
};

let busquedaActual = '';
let timeoutBusqueda = null;

/**
 * Cargar √≥rdenes con paginaci√≥n
 */
async function cargarOrdenes(page = 1, mantenerFiltros = true) {
    const container = document.getElementById('ordenes-container');
    const header = container.querySelector('.ordenes-table-header');
    
    // Mostrar loading solo si es p√°gina nueva
    if (page === 1) {
        container.innerHTML = '';
        if (header) container.appendChild(header);
        
        const loading = document.createElement('div');
        loading.className = 'loading';
        loading.textContent = 'Cargando √≥rdenes disponibles...';
        container.appendChild(loading);
    }
    
    try {
        // Construir URL con par√°metros
        const params = new URLSearchParams({
            page: page,
            page_size: paginacionData.pageSize,
            filtro: filtrosActivos.tipo || 'todas'
        });
        
        if (busquedaActual) {
            params.append('search', busquedaActual);
        }
        
        if (filtrosActivos.estado) {
            params.append('estado', filtrosActivos.estado);
        }
        
        const url = `/api/mesero/todas-ordenes/?${params.toString()}`;
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìã Datos paginados recibidos:', data);
        
        // Actualizar datos globales
        ordenesData = data.ordenes || [];
        paginacionData = data.pagination || paginacionData;
        
        // Cargar productos si es necesario
        if (productosDisponibles.length === 0) {
            await cargarProductosDisponibles();
        }
        
        // Renderizar √≥rdenes
        renderizarOrdenes(ordenesData);
        
        // Renderizar controles de paginaci√≥n
        renderizarPaginacion();
        
        // Actualizar info de resultados
        actualizarInfoResultados();
        
    } catch (error) {
        console.error('‚ùå Error cargando √≥rdenes:', error);
        mostrarError(error.message);
    }
}

/**
 * Renderizar controles de paginaci√≥n
 */
function renderizarPaginacion() {
    const container = document.getElementById('paginacion-container');
    if (!container) return;
    
    const { currentPage, totalPages, hasNext, hasPrevious } = paginacionData;
    
    if (totalPages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    
    let html = '';
    
    // Bot√≥n anterior
    html += `
        <button class="btn-pagina" 
                onclick="cambiarPagina(${currentPage - 1})" 
                ${!hasPrevious ? 'disabled' : ''}>
            ‚¨ÖÔ∏è Anterior
        </button>
    `;
    
    // N√∫meros de p√°gina (con l√≥gica inteligente)
    const rangoPaginas = generarRangoPaginas(currentPage, totalPages);
    
    rangoPaginas.forEach(page => {
        if (page === '...') {
            html += '<span style="padding: 0.75rem;">...</span>';
        } else {
            const isActive = page === currentPage;
            html += `
                <button class="btn-pagina ${isActive ? 'active' : ''}" 
                        onclick="cambiarPagina(${page})">
                    ${page}
                </button>
            `;
        }
    });
    
    // Bot√≥n siguiente
    html += `
        <button class="btn-pagina" 
                onclick="cambiarPagina(${currentPage + 1})" 
                ${!hasNext ? 'disabled' : ''}>
            Siguiente ‚û°Ô∏è
        </button>
    `;
    
    // Selector de tama√±o de p√°gina
    html += `
        <div class="page-size-selector">
            <label>Mostrar:</label>
            <select onchange="cambiarTama√±oPagina(this.value)">
                <option value="10" ${paginacionData.pageSize === 10 ? 'selected' : ''}>10</option>
                <option value="20" ${paginacionData.pageSize === 20 ? 'selected' : ''}>20</option>
                <option value="50" ${paginacionData.pageSize === 50 ? 'selected' : ''}>50</option>
                <option value="100" ${paginacionData.pageSize === 100 ? 'selected' : ''}>100</option>
            </select>
        </div>
    `;
    
    container.innerHTML = html;
}

/**
 * Generar rango inteligente de p√°ginas
 */
function generarRangoPaginas(currentPage, totalPages) {
    const rango = [];
    
    if (totalPages <= 7) {
        // Mostrar todas las p√°ginas
        for (let i = 1; i <= totalPages; i++) {
            rango.push(i);
        }
    } else {
        // L√≥gica inteligente
        rango.push(1);
        
        if (currentPage > 4) {
            rango.push('...');
        }
        
        const start = Math.max(2, currentPage - 1);
        const end = Math.min(totalPages - 1, currentPage + 1);
        
        for (let i = start; i <= end; i++) {
            if (!rango.includes(i)) {
                rango.push(i);
            }
        }
        
        if (currentPage < totalPages - 3) {
            rango.push('...');
        }
        
        if (!rango.includes(totalPages)) {
            rango.push(totalPages);
        }
    }
    
    return rango;
}

/**
 * Cambiar p√°gina
 */
function cambiarPagina(page) {
    if (page < 1 || page > paginacionData.totalPages || page === paginacionData.currentPage) {
        return;
    }
    
    cargarOrdenes(page);
    
    // Scroll al top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Cambiar tama√±o de p√°gina
 */
function cambiarTama√±oPagina(newSize) {
    paginacionData.pageSize = parseInt(newSize);
    cargarOrdenes(1); // Volver a p√°gina 1
}

/**
 * Actualizar informaci√≥n de resultados
 */
function actualizarInfoResultados() {
    const infoElement = document.getElementById('info-resultados');
    if (!infoElement) return;
    
    const { currentPage, totalCount, pageSize } = paginacionData;
    const inicio = (currentPage - 1) * pageSize + 1;
    const fin = Math.min(currentPage * pageSize, totalCount);
    
    if (totalCount === 0) {
        infoElement.textContent = 'No se encontraron resultados';
    } else {
        infoElement.textContent = `Mostrando ${inicio}-${fin} de ${totalCount} √≥rdenes`;
    }
}

/**
 * Funciones de b√∫squeda
 */
function buscarOrdenes() {
    const input = document.getElementById('busqueda-ordenes');
    busquedaActual = input.value.trim();
    cargarOrdenes(1); // Buscar desde p√°gina 1
}

function limpiarBusqueda() {
    const input = document.getElementById('busqueda-ordenes');
    input.value = '';
    busquedaActual = '';
    cargarOrdenes(1);
}

// B√∫squeda en tiempo real con debounce
document.addEventListener('DOMContentLoaded', () => {
    const inputBusqueda = document.getElementById('busqueda-ordenes');
    if (inputBusqueda) {
        inputBusqueda.addEventListener('input', (e) => {
            clearTimeout(timeoutBusqueda);
            timeoutBusqueda = setTimeout(() => {
                busquedaActual = e.target.value.trim();
                cargarOrdenes(1);
            }, 500); // Esperar 500ms despu√©s de que el usuario deje de escribir
        });
        
        // Buscar con Enter
        inputBusqueda.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(timeoutBusqueda);
                buscarOrdenes();
            }
        });
    }
});

// Exponer funciones globalmente
window.cambiarPagina = cambiarPagina;
window.cambiarTama√±oPagina = cambiarTama√±oPagina;
window.buscarOrdenes = buscarOrdenes;
window.limpiarBusqueda = limpiarBusqueda;

        // === VARIABLES GLOBALES ===
        let filtrosActivos = {
            tipo: 'todos',
            estado: null
        };
        
        let ordenesData = [];
        let ordenSeleccionada = null;
        let carritoModificacion = {};
        let productosDisponibles = [];
        let intervalId = null;

        // === FUNCIONES PRINCIPALES ===
        
        /**
         * Cargar √≥rdenes desde el servidor
         */
        async function cargarOrdenes() {
            const container = document.getElementById('ordenes-container');
            const header = container.querySelector('.ordenes-table-header');
            
            container.innerHTML = '';
            if (header) {
                container.appendChild(header);
            } else {
                container.appendChild(crearHeaderTabla());
            }
            
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.textContent = 'Cargando √≥rdenes disponibles...';
            container.appendChild(loading);
            
            try {
                // Conectar al backend - API de todas las √≥rdenes del mesero
                const response = await fetch('/api/mesero/todas-ordenes/?filtro=todas', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const ordenes = await response.json();
                console.log('üìã √ìrdenes cargadas desde backend:', ordenes.length);
                
                ordenesData = ordenes;
                
                // Cargar productos disponibles para modificaci√≥n
                await cargarProductosDisponibles();
                
                aplicarFiltrosYRenderizar();
                
            } catch (error) {
                console.error('‚ùå Error cargando √≥rdenes:', error);
                mostrarError(error.message);
            }
        }

        /**
         * Cargar productos disponibles desde el backend
         */
        async function cargarProductosDisponibles() {
            try {
                const response = await fetch('/api/productos/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error cargando productos: ${response.status}`);
                }
                
                const productos = await response.json();
                productosDisponibles = productos.map(p => ({
                    id: p.id,
                    nombre: p.nombre,
                    precio: p.precio,
                    categoria: p.id_categoria__nombre || 'Sin categor√≠a',
                    stock: p.cantidad
                }));
                
                console.log('üõí Productos disponibles cargados:', productosDisponibles.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando productos:', error);
                productosDisponibles = [];
            }
        }

        /**
         * Obtener token CSRF
         */
        function getCsrfToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                return token.value;
            }
            // Buscar en cookies como alternativa
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }

        /**
         * Crear header de la tabla
         */
        function crearHeaderTabla() {
            const header = document.createElement('div');
            header.className = 'ordenes-table-header';
            header.innerHTML = `
                <div>üçΩÔ∏è Mesa</div>
                <div>üìã Informaci√≥n</div>
                <div>üìä Estado</div>
                <div>üë®‚Äçüç≥ Mesero</div>
                <div>üí∞ Total</div>
                <div>‚ö° Acciones</div>
            `;
            return header;
        }

        /**
         * Mostrar error en el container
         */
        function mostrarError(mensaje) {
            const container = document.getElementById('ordenes-container');
            const header = container.querySelector('.ordenes-table-header');
            
            container.innerHTML = '';
            if (header) container.appendChild(header);
            
            const estadoError = document.createElement('div');
            estadoError.className = 'estado-vacio';
            estadoError.innerHTML = `
                <h3>‚ùå Error al cargar √≥rdenes</h3>
                <p>${mensaje}</p>
                <button class="btn-actualizar" onclick="cargarOrdenes()">üîÑ Reintentar</button>
            `;
            container.appendChild(estadoError);
        }

        /**
         * Aplicar filtros y renderizar √≥rdenes
         */
        function aplicarFiltrosYRenderizar() {
            let ordenesFiltradas = ordenesData.filter(orden => {
                // Filtro por tipo
                if (filtrosActivos.tipo === 'ordenes' && !puedeModificarOrden(orden)) {
                    return false;
                }
                if (filtrosActivos.tipo === 'facturas' && !tieneFactura(orden)) {
                    return false;
                }
                
                // Filtro por estado
                if (filtrosActivos.estado) {
                    if (filtrosActivos.tipo === 'facturas') {
                        if (!orden.factura_info || orden.factura_info.estado_pago !== filtrosActivos.estado) {
                            return false;
                        }
                    } else {
                        if (orden.estado !== filtrosActivos.estado) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            console.log(`üîç Filtros aplicados: ${ordenesFiltradas.length} de ${ordenesData.length} √≥rdenes`);
            renderizarOrdenes(ordenesFiltradas);
        }

        /**
         * Renderizar lista de √≥rdenes
         */
        function renderizarOrdenes(ordenes) {
            const container = document.getElementById('ordenes-container');
            const header = container.querySelector('.ordenes-table-header');
            
            container.innerHTML = '';
            if (header) container.appendChild(header);
            
            if (ordenes.length === 0) {
                const estadoVacio = document.createElement('div');
                estadoVacio.className = 'estado-vacio';
                estadoVacio.innerHTML = `
                    <h3>üòä No hay √≥rdenes que coincidan</h3>
                    <p>No se encontraron √≥rdenes con los filtros seleccionados.</p>
                    <button class="btn-actualizar" onclick="cargarOrdenes()">üîÑ Actualizar</button>
                `;
                container.appendChild(estadoVacio);
                return;
            }
            
            ordenes.forEach(orden => {
                const tarjeta = crearTarjetaOrden(orden);
                container.appendChild(tarjeta);
            });
        }

        /**
         * Crear tarjeta individual de orden
         */
        function crearTarjetaOrden(orden) {
            const template = document.getElementById('orden-item-template');
            const clone = document.importNode(template.content, true);
            const tarjeta = clone.querySelector('.orden-item');
            
            // Configurar datos b√°sicos
            tarjeta.dataset.ordenId = orden.orden_id;
            tarjeta.dataset.tipo = determinarTipoOrden(orden);
            
            // Configurar clases CSS seg√∫n estado
            const estadoCSS = determinarEstadoCSS(orden);
            tarjeta.classList.add(estadoCSS.clase);
            
            // Llenar informaci√≥n
            llenarInformacionBasica(tarjeta, orden);
            llenarInformacionFactura(tarjeta, orden);
            llenarDetallesExpandibles(tarjeta, orden);
            configurarBotonesAccion(tarjeta, orden);
            
            // Event listeners
            configurarEventListeners(tarjeta, orden);
            
            return tarjeta;
        }

        /**
         * Llenar informaci√≥n b√°sica de la tarjeta
         */
        function llenarInformacionBasica(tarjeta, orden) {
            // Mesa con icono
            const mesaIcono = tarjeta.querySelector('.mesa-icono');
            const mesaNumero = tarjeta.querySelector('.mesa-numero');
            
            if (orden.es_domicilio) {
                mesaIcono.textContent = 'üè†';
                mesaNumero.textContent = 'Domicilio';
            } else if (orden.es_reserva) {
                mesaIcono.textContent = 'üìÖ';
                mesaNumero.textContent = 'Reserva';
            } else {
                mesaIcono.textContent = 'üçΩÔ∏è';
                mesaNumero.textContent = `Mesa ${orden.mesa.numero}`;
            }
            
            // T√≠tulo de la orden
            tarjeta.querySelector('.orden-titulo').textContent = `Orden #${orden.orden_id}`;
            
            // Descripci√≥n con productos y tiempo
            tarjeta.querySelector('.productos-count').textContent = `${orden.productos?.length || 0} productos`;
            tarjeta.querySelector('.tiempo-transcurrido').textContent = `‚è±Ô∏è ${orden.tiempo_transcurrido || 'N/A'}`;
            
            // Preview de productos
            const productosPreview = tarjeta.querySelector('.productos-preview');
            if (orden.productos && orden.productos.length > 0) {
                const primeros = orden.productos.slice(0, 2).map(p => 
                    `${p.cantidad}x ${p.nombre}`
                ).join(', ');
                const extra = orden.productos.length > 2 ? ` y ${orden.productos.length - 2} m√°s...` : '';
                productosPreview.textContent = primeros + extra;
            } else {
                productosPreview.textContent = 'Sin productos';
            }
            
            // Estado badge
            const estadoBadge = tarjeta.querySelector('.estado-badge');
            const estadoTexto = obtenerTextoEstado(orden);
            const estadoCSS = determinarEstadoCSS(orden);
            
            estadoBadge.textContent = estadoTexto;
            estadoBadge.className = `estado-badge ${estadoCSS.clase}`;
            
            // Progreso de productos
            const progresoProductos = tarjeta.querySelector('.progreso-productos');
            if (orden.estado === 'EN_PROCESO' && orden.productos_listos_count > 0) {
                progresoProductos.textContent = `${orden.productos_listos_count}/${orden.productos.length} listos`;
            } else {
                progresoProductos.textContent = '';
            }
            
            // Mesero
            tarjeta.querySelector('.mesero-nombre').textContent = orden.mesero?.nombre || 'No asignado';
            tarjeta.querySelector('.mesero-tiempo').textContent = `‚è±Ô∏è ${orden.tiempo_transcurrido || 'N/A'}`;
            
            // Total
            tarjeta.querySelector('.total-valor').textContent = `${(orden.total || 0).toLocaleString()}`;
            tarjeta.querySelector('.total-productos').textContent = `${orden.productos?.length || 0} items`;
        }

        /**
         * Llenar informaci√≥n de factura
         */
        function llenarInformacionFactura(tarjeta, orden) {
            const facturaInfo = tarjeta.querySelector('.factura-info');
            
            if (orden.factura_info) {
                facturaInfo.style.display = 'block';
                tarjeta.querySelector('.factura-numero').textContent = 
                    orden.factura_info.numero || `FAC-${orden.factura_info.id}`;
                tarjeta.querySelector('.factura-estado').textContent = 
                    orden.factura_info.estado_pago === 'PAGADA' ? 'Pagada' : 'Pendiente';
            } else {
                facturaInfo.style.display = 'none';
            }
        }

        /**
         * Llenar detalles expandibles
         */
        function llenarDetallesExpandibles(tarjeta, orden) {
            const detalles = tarjeta.querySelector('.orden-detalles');
            
            // Informaci√≥n general
            const infoGeneral = detalles.querySelector('.info-general');
            infoGeneral.innerHTML = `
                <p><strong>üÜî ID:</strong> ${orden.orden_id}</p>
                <p><strong>üë®‚Äçüç≥ Mesero:</strong> ${orden.mesero?.nombre || 'No asignado'}</p>
                <p><strong>‚è∞ Tiempo:</strong> ${orden.tiempo_transcurrido || 'N/A'}</p>
                <p><strong>üìä Estado:</strong> ${obtenerTextoEstado(orden)}</p>
                ${orden.cliente_info ? `
                    <p><strong>üë§ Cliente:</strong> ${orden.cliente_info.nombre}</p>
                    <p><strong>üìû Tel√©fono:</strong> ${orden.cliente_info.telefono}</p>
                    ${orden.cliente_info.direccion ? `<p><strong>üìç Direcci√≥n:</strong> ${orden.cliente_info.direccion}</p>` : ''}
                ` : ''}
            `;
            
            // Lista de productos
            const productosLista = detalles.querySelector('.productos-lista');
            productosLista.innerHTML = '';
            
            if (orden.productos && orden.productos.length > 0) {
                orden.productos.forEach(producto => {
                    const productoDiv = document.createElement('div');
                    productoDiv.className = `producto-detalle ${producto.estado.toLowerCase()}`;
                    
                    const iconoEstado = producto.estado === 'LISTO' ? '‚úÖ' : '‚è≥';
                    const subtotal = producto.cantidad * producto.precio_unitario;
                    
                    productoDiv.innerHTML = `
                        <div class="producto-info">
                            <div class="producto-nombre">${producto.cantidad}x ${producto.nombre}</div>
                            ${producto.observaciones ? `<div class="producto-observaciones">üìù ${producto.observaciones}</div>` : ''}
                            <div style="font-size: 0.8em; color: #666;">Subtotal: ${subtotal.toLocaleString()}</div>
                        </div>
                        <div class="producto-estado-icon">${iconoEstado}</div>
                    `;
                    
                    productosLista.appendChild(productoDiv);
                });
            } else {
                productosLista.innerHTML = '<p style="color: #888; font-style: italic;">Sin productos</p>';
            }
            
            // Observaciones
            const observacionesContent = detalles.querySelector('.observaciones-content');
            if (orden.observaciones) {
                observacionesContent.innerHTML = `<p>${orden.observaciones}</p>`;
            } else {
                observacionesContent.innerHTML = '<p style="color: #888; font-style: italic;">Sin observaciones</p>';
            }
        }

        /**
         * Configurar botones de acci√≥n
         */
        function configurarBotonesAccion(tarjeta, orden) {
            const container = tarjeta.querySelector('.orden-acciones');
            container.innerHTML = '';
            
            // Bot√≥n modificar
            if (puedeModificarOrden(orden)) {
                const btnModificar = crearBotonAccion(
                    'btn-modificar', 
                    tieneFactura(orden) ? '‚úèÔ∏èüí∞' : '‚úèÔ∏è',
                    tieneFactura(orden) ? 'Modificar + Factura' : 'Modificar Orden',
                    () => abrirModalModificacion(orden)
                );
                container.appendChild(btnModificar);
            }
            
            // Bot√≥n entregar
            if (orden.puede_entregar) {
                const btnEntregar = crearBotonAccion(
                    'btn-entregar', 
                    'üçΩÔ∏è',
                    'Entregar',
                    () => entregarOrden(orden.orden_id)
                );
                container.appendChild(btnEntregar);
            }
            
            // Bot√≥n ver factura
            if (orden.factura_info) {
                const btnFactura = crearBotonAccion(
                    'btn-ver-factura', 
                    'üßæ',
                    'Ver Factura',
                    () => abrirModalFactura(orden)
                );
                container.appendChild(btnFactura);
            }
        }

        /**
         * Crear bot√≥n de acci√≥n reutilizable
         */
        function crearBotonAccion(className, texto, titulo, callback) {
            const btn = document.createElement('button');
            btn.className = `btn-accion ${className}`;
            btn.innerHTML = texto;
            btn.title = titulo;
            btn.onclick = (e) => {
                e.stopPropagation();
                callback();
            };
            return btn;
        }

        /**
         * Configurar event listeners de la tarjeta
         */
        function configurarEventListeners(tarjeta, orden) {
            // Click en la tarjeta para expandir/contraer detalles
            tarjeta.addEventListener('click', (e) => {
                // No expandir si se hizo click en un bot√≥n
                if (e.target.classList.contains('btn-accion')) {
                    return;
                }
                
                toggleDetallesOrden(tarjeta);
            });
        }

        /**
         * Alternar detalles de orden
         */
        function toggleDetallesOrden(tarjeta) {
            const detalles = tarjeta.querySelector('.orden-detalles');
            const isVisible = detalles.classList.contains('visible');
            
            // Cerrar todos los detalles abiertos
            document.querySelectorAll('.orden-detalles.visible').forEach(d => {
                d.classList.remove('visible');
                d.parentElement.classList.remove('expandida');
            });
            
            // Si no estaba visible, abrirlo
            if (!isVisible) {
                detalles.classList.add('visible');
                tarjeta.classList.add('expandida');
                
                // Scroll suave para mostrar los detalles
                setTimeout(() => {
                    detalles.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 300);
            }
        }

        // === FUNCIONES DE UTILIDAD ===
        
        function determinarTipoOrden(orden) {
            if (orden.factura_info) {
                return orden.factura_info.estado_pago === 'PAGADA' ? 'factura-pagada' : 'factura-pendiente';
            }
            return 'orden-sin-factura';
        }
        
        function determinarEstadoCSS(orden) {
            if (orden.factura_info) {
                return { clase: orden.factura_info.estado_pago === 'PAGADA' ? 'factura-pagada' : 'factura-pendiente' };
            }
            
            const estados = {
                'EN_PROCESO': 'en-proceso',
                'LISTA': 'lista',
                'SERVIDA': 'servida'
            };
            
            return { clase: estados[orden.estado] || 'en-proceso' };
        }
        
        function obtenerTextoEstado(orden) {
            if (orden.factura_info) {
                return orden.factura_info.estado_pago === 'PAGADA' ? 
                    '‚úÖ Facturada y Pagada' : 'üßæ Factura Pendiente';
            }
            
            const estados = {
                'EN_PROCESO': orden.productos_listos_count > 0 ? 
                    `üîÑ Parcial (${orden.productos_listos_count}/${orden.productos.length})` : 
                    '‚è≥ En Preparaci√≥n',
                'LISTA': 'üçΩÔ∏è Lista para Servir',
                'SERVIDA': '‚úÖ Servida'
            };
            
            return estados[orden.estado] || '‚è≥ En Preparaci√≥n';
        }
        
        function puedeModificarOrden(orden) {
            return orden.puede_modificar || (orden.estado !== 'SERVIDA' || orden.tiene_factura_pendiente);
        }
        
        function tieneFactura(orden) {
            return !!orden.factura_info;
        }

        // === FUNCIONES DE MODALES ===

        /**
         * Abrir modal de modificaci√≥n
         */
        function abrirModalModificacion(orden) {
            console.log('üîß Abriendo modal de modificaci√≥n para orden:', orden.orden_id);
            
            ordenSeleccionada = orden;
            carritoModificacion = {};
            
            // Configurar t√≠tulo del modal
            const titulo = document.getElementById('modificacion-titulo');
            const tipoTexto = tieneFactura(orden) ? 
                `Modificar Orden con Factura #${orden.factura_info?.numero || orden.factura_info?.id}` :
                `Modificar Orden #${orden.orden_id}`;
            titulo.textContent = tipoTexto;
            
            // Cargar productos disponibles
            cargarProductosModificacion();
            
            // Cargar detalle completo de la orden
            cargarDetalleOrdenCompleto(orden);
            
            // Mostrar modal
            mostrarModal('modal-modificacion');
        }

        /**
         * Cargar productos para modificaci√≥n
         */
        function cargarProductosModificacion() {
            const productosGrid = document.getElementById('productos-grid');
            productosGrid.innerHTML = '';
            
            // Agrupar productos por categor√≠a
            const categorias = [...new Set(productosDisponibles.map(p => p.categoria))];
            
            productosDisponibles.forEach(producto => {
                const productoCard = document.createElement('div');
                productoCard.className = 'producto-card';
                productoCard.dataset.productoId = producto.id;
                productoCard.dataset.categoria = producto.categoria;
                
                const sinStock = producto.stock <= 0;
                if (sinStock) {
                    productoCard.style.opacity = '0.5';
                    productoCard.style.pointerEvents = 'none';
                }
                
                productoCard.innerHTML = `
                    <h6>${producto.nombre}</h6>
                    <div style="color: var(--naranja-tostado); font-weight: 700; margin: 0.5rem 0;">
                        ${producto.precio.toLocaleString()}
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-bottom: 1rem;">
                        Stock: ${sinStock ? 'AGOTADO' : producto.stock}
                    </div>
                    ${!sinStock ? `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <button onclick="cambiarCantidadProducto(${producto.id}, -1)" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 50%; cursor: pointer;">-</button>
                            <span id="qty-${producto.id}" style="min-width: 30px; text-align: center; font-weight: 600;">0</span>
                            <button onclick="cambiarCantidadProducto(${producto.id}, 1)" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 50%; cursor: pointer;">+</button>
                        </div>
                        <input type="text" id="obs-${producto.id}" placeholder="Observaciones..." style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em;" maxlength="100">
                    ` : '<div style="color: #cc0000; font-weight: 600;">‚ùå No Disponible</div>'}
                `;
                
                productosGrid.appendChild(productoCard);
            });
            
            // Configurar filtros de categor√≠as
            configurarFiltrosCategorias();
        }

        /**
         * Configurar filtros de categor√≠as
         */
        function configurarFiltrosCategorias() {
            document.querySelectorAll('.categoria-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remover active de todos
                    document.querySelectorAll('.categoria-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const categoria = btn.dataset.categoria;
                    filtrarProductosPorCategoria(categoria);
                });
            });
        }

        /**
         * Filtrar productos por categor√≠a
         */
        function filtrarProductosPorCategoria(categoria) {
            document.querySelectorAll('.producto-card').forEach(card => {
                const cardCategoria = card.dataset.categoria;
                if (categoria === 'all' || cardCategoria === categoria) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        /**
         * Cambiar cantidad de producto en el carrito
         */
        function cambiarCantidadProducto(productoId, cambio) {
            const producto = productosDisponibles.find(p => p.id === productoId);
            if (!producto) return;
            
            let cantidadActual = carritoModificacion[productoId] ? carritoModificacion[productoId].cantidad : 0;
            const nuevaCantidad = Math.max(0, cantidadActual + cambio);
            
            // Verificar stock
            if (cambio > 0 && nuevaCantidad > producto.stock) {
                alert('‚ùå No hay stock suficiente');
                return;
            }
            
            // Actualizar carrito
            if (nuevaCantidad > 0) {
                if (!carritoModificacion[productoId]) {
                    carritoModificacion[productoId] = {
                        id: productoId,
                        nombre: producto.nombre,
                        precio: producto.precio,
                        observaciones: ''
                    };
                }
                carritoModificacion[productoId].cantidad = nuevaCantidad;
            } else {
                delete carritoModificacion[productoId];
            }
            
            // Actualizar UI
            document.getElementById(`qty-${productoId}`).textContent = nuevaCantidad;
            actualizarCarritoUI();
            
            // Marcar producto como seleccionado
            const card = document.querySelector(`[data-producto-id="${productoId}"]`);
            if (card) {
                if (nuevaCantidad > 0) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            }
        }

        /**
         * Actualizar UI del carrito
         */
        function actualizarCarritoUI() {
            const carritoItems = document.getElementById('carrito-items');
            const totalEl = document.getElementById('total-modificacion');
            const btnConfirmar = document.getElementById('btn-confirmar-modificacion');
            
            const items = Object.values(carritoModificacion);
            let total = 0;
            
            if (items.length === 0) {
                carritoItems.innerHTML = '<p style="color: #888; text-align: center; font-style: italic;">Selecciona productos del men√∫</p>';
                btnConfirmar.disabled = true;
            } else {
                carritoItems.innerHTML = items.map(item => {
                    const subtotal = item.cantidad * item.precio;
                    total += subtotal;
                    
                    // Obtener observaciones del input
                    const obsInput = document.getElementById(`obs-${item.id}`);
                    if (obsInput) {
                        item.observaciones = obsInput.value;
                    }
                    
                    return `
                        <div class="carrito-item">
                            <div>
                                <strong>${item.cantidad}x ${item.nombre}</strong>
                                ${item.observaciones ? `<div style="font-size: 0.8em; color: #666;">üìù ${item.observaciones}</div>` : ''}
                            </div>
                            <div>${subtotal.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
                
                btnConfirmar.disabled = false;
            }
            
            totalEl.textContent = total.toLocaleString();
        }

        /**
         * Cargar detalle completo de la orden
         */
        function cargarDetalleOrdenCompleto(orden) {
            const container = document.getElementById('orden-detalle-completo');
            
            // Informaci√≥n b√°sica de la orden
            const mesaTexto = orden.es_domicilio ? 'üè† Domicilio' : 
                             orden.es_reserva ? 'üìÖ Reserva' : 
                             `üçΩÔ∏è Mesa #${orden.mesa.numero}`;
            
            const estadoTexto = obtenerTextoEstado(orden);
            
            // Informaci√≥n de cliente si es domicilio o reserva
            let infoCliente = '';
            if (orden.cliente_info && (orden.es_domicilio || orden.es_reserva)) {
                infoCliente = `
                    <div style="background: rgba(23, 162, 184, 0.05); border-left: 4px solid #17a2b8; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #17a2b8;">
                            ${orden.es_domicilio ? 'üöö Informaci√≥n del Domicilio' : 'üìÖ Informaci√≥n de la Reserva'}
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.9em;">
                            <div><strong>üë§ Cliente:</strong> ${orden.cliente_info.nombre || 'No especificado'}</div>
                            <div><strong>üìû Tel√©fono:</strong> ${orden.cliente_info.telefono || 'No especificado'}</div>
                            ${orden.cliente_info.direccion ? `<div style="grid-column: 1 / -1;"><strong>üìç Direcci√≥n:</strong> ${orden.cliente_info.direccion}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Informaci√≥n de factura si existe
            let infoFactura = '';
            if (orden.factura_info) {
                const estadoPago = orden.factura_info.estado_pago;
                const colorFactura = estadoPago === 'PAGADA' ? '#28a745' : '#dc3545';
                const iconoFactura = estadoPago === 'PAGADA' ? '‚úÖ' : '‚ö†Ô∏è';
                
                infoFactura = `
                    <div style="background: rgba(${estadoPago === 'PAGADA' ? '40, 167, 69' : '220, 53, 69'}, 0.05); border-left: 4px solid ${colorFactura}; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
                        <h5 style="margin: 0 0 0.75rem 0; color: ${colorFactura};">${iconoFactura} Informaci√≥n de Factura</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.9em;">
                            <div><strong>üßæ N√∫mero:</strong> ${orden.factura_info.numero || `FAC-${orden.factura_info.id}`}</div>
                            <div><strong>üí∞ Total:</strong> ${(orden.factura_info.total || 0).toLocaleString()}</div>
                            <div><strong>üìä Estado:</strong> ${estadoPago === 'PAGADA' ? 'Pagada' : 'Pendiente de Pago'}</div>
                            ${orden.factura_info.metodo_pago ? `<div><strong>üí≥ M√©todo:</strong> ${orden.factura_info.metodo_pago}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Productos de la orden
            const productosHTML = renderizarProductosDetalle(orden.productos || []);
            
            container.innerHTML = `
                <div style="margin-top: 2rem; background: white; border: 1px solid #dee2e6; border-radius: 12px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 1.3em;">üìã Orden #${orden.orden_id}</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9em; opacity: 0.95;">
                                    <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 12px;">${mesaTexto}</span>
                                    <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 12px;">${estadoTexto}</span>
                                    <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 12px;">‚è±Ô∏è ${orden.tiempo_transcurrido}</span>
                                    <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 12px;">üë®‚Äçüç≥ ${orden.mesero?.nombre || 'No asignado'}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: 700; margin-bottom: 0.25rem;">üí∞ Total Actual: ${(orden.total || 0).toLocaleString()}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">${(orden.productos || []).length} productos</div>
                            </div>
                        </div>
                    </div>
                    
                    ${infoCliente}
                    ${infoFactura}
                    
                    <div style="padding: 1.5rem;">
                        <h5 style="margin: 0 0 1rem 0; color: var(--carbon-suave); border-bottom: 2px solid var(--gris-piedra); padding-bottom: 0.5rem;">üçΩÔ∏è Productos de la Orden (${(orden.productos || []).length})</h5>
                        ${productosHTML}
                    </div>
                    
                    ${orden.observaciones ? `
                        <div style="padding: 1rem 1.5rem; background: rgba(255, 193, 7, 0.1); border-top: 1px solid #eee;">
                            <h5 style="margin: 0 0 0.5rem 0; color: #856404;">üìù Observaciones de la Orden</h5>
                            <div style="background: white; padding: 0.75rem; border-radius: 4px; border-left: 3px solid #ffc107; font-style: italic;">${orden.observaciones}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Renderizar productos con detalle
         */
        function renderizarProductosDetalle(productos) {
            if (!productos || productos.length === 0) {
                return '<div style="text-align: center; padding: 2rem; color: #666; font-style: italic; background: #f8f9fa; border-radius: 6px;">üòï No hay productos en esta orden</div>';
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            
            productos.forEach(producto => {
                const estadoClass = producto.estado === 'LISTO' ? 'producto-listo' : 'producto-pendiente';
                const iconoEstado = producto.estado === 'LISTO' ? '‚úÖ' : '‚è≥';
                const subtotal = producto.cantidad * producto.precio_unitario;
                
                const bgColor = producto.estado === 'LISTO' ? '#f8fff8' : '#fafafa';
                const borderColor = producto.estado === 'LISTO' ? '#d4edda' : '#eee';
                
                html += `
                    <div style="padding: 0.75rem; border: 1px solid ${borderColor}; border-radius: 6px; background: ${bgColor};">
                        <div style="display: flex; align-items: center; gap: 0.75rem; font-weight: 600;">
                            <span style="font-size: 1.1em;">${iconoEstado}</span>
                            <span style="flex: 1;">${producto.cantidad}x ${producto.nombre}</span>
                            <span style="color: #666; font-size: 0.9em;">${(producto.precio_unitario || 0).toLocaleString()} c/u</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: #666; margin-top: 0.25rem;">
                            <span>Subtotal: ${subtotal.toLocaleString()}</span>
                        </div>
                        ${producto.observaciones ? `<div style="font-size: 0.85em; color: var(--naranja-tostado); font-style: italic; padding: 0.25rem 0.5rem; background: rgba(232, 119, 46, 0.1); border-radius: 4px; margin-top: 0.25rem;">üìù ${producto.observaciones}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Resumen de estados
            const productosListos = productos.filter(p => p.estado === 'LISTO').length;
            const productosPendientes = productos.filter(p => p.estado === 'PENDIENTE').length;
            
            html += `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div style="text-align: center; padding: 0.75rem; border-radius: 6px; background: #d4edda; color: #155724;">
                            <span style="display: block; font-size: 1.5em; font-weight: 700; margin-bottom: 0.25rem;">${productosListos}</span>
                            <span style="font-size: 0.85em; font-weight: 600;">‚úÖ Listos</span>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; border-radius: 6px; background: #fff3cd; color: #856404;">
                            <span style="display: block; font-size: 1.5em; font-weight: 700; margin-bottom: 0.25rem;">${productosPendientes}</span>
                            <span style="font-size: 0.85em; font-weight: 600;">‚è≥ Pendientes</span>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; border-radius: 6px; background: #d1ecf1; color: #0c5460;">
                            <span style="display: block; font-size: 1.5em; font-weight: 700; margin-bottom: 0.25rem;">${productos.length}</span>
                            <span style="font-size: 0.85em; font-weight: 600;">üì¶ Total</span>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        /**
         * Abrir modal de factura
         */
        function abrirModalFactura(orden) {
            console.log('üßæ Abriendo modal de factura para orden:', orden.orden_id);
            
            const titulo = document.getElementById('factura-titulo');
            titulo.textContent = `Factura #${orden.factura_info.numero || orden.factura_info.id}`;
            
            cargarContenidoFactura(orden);
            mostrarModal('modal-factura');
        }

        /**
         * Cargar contenido de factura
         */
        function cargarContenidoFactura(orden) {
            const container = document.getElementById('factura-content');
            const factura = orden.factura_info;
            
            const estadoPago = factura.estado_pago;
            const colorEstado = estadoPago === 'PAGADA' ? '#28a745' : '#dc3545';
            const iconoEstado = estadoPago === 'PAGADA' ? '‚úÖ' : '‚ö†Ô∏è';
            
            // Calcular totales
            const subtotal = orden.productos.reduce((sum, p) => sum + (p.cantidad * p.precio_unitario), 0);
            const iva = Math.round(subtotal * 0.19);
            const total = subtotal + iva;
            
            container.innerHTML = `
                <div class="factura-header" style="background: linear-gradient(135deg, ${colorEstado}, ${estadoPago === 'PAGADA' ? '#1e7e34' : '#bd2130'});">
                    <div class="factura-numero">${factura.numero || `FAC-${factura.id}`}</div>
                    <div class="factura-fecha">üìÖ Fecha: ${factura.fecha || new Date().toLocaleDateString()}</div>
                    <div style="margin-top: 1rem; font-size: 1.2em;">${iconoEstado} ${estadoPago === 'PAGADA' ? 'PAGADA' : 'PENDIENTE DE PAGO'}</div>
                </div>
                
                <div class="factura-detalle">
                    <h5 style="margin: 0 0 1rem 0;">üìã Informaci√≥n de la Orden</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div><strong>üÜî Orden:</strong> #${orden.orden_id}</div>
                        <div><strong>üçΩÔ∏è Mesa:</strong> ${orden.es_domicilio ? 'üè† Domicilio' : orden.es_reserva ? 'üìÖ Reserva' : `Mesa ${orden.mesa.numero}`}</div>
                        <div><strong>üë®‚Äçüç≥ Mesero:</strong> ${orden.mesero?.nombre || 'No asignado'}</div>
                        <div><strong>‚è∞ Tiempo:</strong> ${orden.tiempo_transcurrido || 'N/A'}</div>
                    </div>
                    
                    ${orden.cliente_info ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            <h6 style="margin: 0 0 0.5rem 0;">üë§ Informaci√≥n del Cliente</h6>
                            <div><strong>Nombre:</strong> ${orden.cliente_info.nombre}</div>
                            <div><strong>Tel√©fono:</strong> ${orden.cliente_info.telefono}</div>
                            ${orden.cliente_info.direccion ? `<div><strong>Direcci√≥n:</strong> ${orden.cliente_info.direccion}</div>` : ''}
                        </div>
                    ` : ''}
                </div>
                
                <div class="factura-productos">
                    <h5 style="margin: 0 0 1rem 0; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem;">üçΩÔ∏è Productos Facturados</h5>
                    ${orden.productos.map(producto => {
                        const subtotalProducto = producto.cantidad * producto.precio_unitario;
                        return `
                            <div class="factura-producto">
                                <div>
                                    <strong>${producto.cantidad}x ${producto.nombre}</strong>
                                    ${producto.observaciones ? `<div style="font-size: 0.85em; color: #666; font-style: italic;">üìù ${producto.observaciones}</div>` : ''}
                                    <div style="font-size: 0.85em; color: #666;">${producto.precio_unitario.toLocaleString()} c/u</div>
                                </div>
                                <div style="font-weight: 600;">${subtotalProducto.toLocaleString()}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Subtotal:</span>
                        <span>${subtotal.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>IVA (19%):</span>
                        <span>${iva.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.1em; padding-top: 0.5rem; border-top: 1px solid #dee2e6;">
                        <span>TOTAL:</span>
                        <span>${total.toLocaleString()}</span>
                    </div>
                </div>
                
                ${factura.metodo_pago ? `
                    <div style="text-align: center; padding: 1rem; background: #d4edda; border-radius: 8px; color: #155724;">
                        <strong>üí≥ M√©todo de Pago:</strong> ${factura.metodo_pago}
                    </div>
                ` : ''}
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button onclick="imprimirFactura()" style="background: var(--azul-info); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 1rem;">
                        üñ®Ô∏è Imprimir Factura
                    </button>
                    ${estadoPago !== 'PAGADA' ? `
                        <button onclick="marcarComoPagada(${orden.orden_id})" style="background: var(--verde-listo); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üí∞ Marcar como Pagada
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // === FUNCIONES DE MODAL ===

        /**
         * Mostrar modal
         */
        function mostrarModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Cerrar modal
         */
        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('visible');
            document.body.style.overflow = 'auto';
            
            // Limpiar datos si es modal de modificaci√≥n
            if (modalId === 'modal-modificacion') {
                carritoModificacion = {};
                ordenSeleccionada = null;
            }
        }

        /**
         * Confirmar modificaci√≥n de orden
         */
        async function confirmarModificacion() {
            const items = Object.values(carritoModificacion);
            if (items.length === 0) return;
            
            const tieneFactura = !!ordenSeleccionada.factura_info;
            const mensaje = tieneFactura ? 
                `¬øAgregar ${items.length} productos a la orden con factura?\nSe actualizar√° el total de la factura.` :
                `¬øAgregar ${items.length} productos a la orden?`;
            
            if (!confirm(mensaje)) return;
            
            const btnConfirmar = document.getElementById('btn-confirmar-modificacion');
            btnConfirmar.disabled = true;
            btnConfirmar.textContent = '‚è≥ Agregando...';
            
            try {
                const productosParaAgregar = items.map(item => ({
                    id: item.id,
                    cantidad: item.cantidad,
                    observaciones: item.observaciones || ''
                }));
                
                const url = `/api/orden/${ordenSeleccionada.orden_id}/agregar-productos/`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        productos: productosParaAgregar,
                        es_orden_facturada: tieneFactura
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error en el servidor');
                }
                
                alert(`‚úÖ ${result.mensaje || 'Productos agregados exitosamente'}`);
                
                // Cerrar modal y recargar
                cerrarModal('modal-modificacion');
                cargarOrdenes();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = 'Agregar a la Orden';
            }
        }

        // === FUNCIONES DE ACCI√ìN ===

        /**
         * Entregar orden
         */
        async function entregarOrden(ordenId) {
            if (!confirm('¬øConfirmas que esta orden ha sido entregada?\nSe generar√° una factura pendiente.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/mesero/orden/${ordenId}/entregar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error en el servidor');
                }
                
                alert(`‚úÖ Orden #${ordenId} entregada exitosamente`);
                cargarOrdenes();
                
            } catch (error) {
                console.error('‚ùå Error entregando orden:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        /**
         * Imprimir factura
         */
        function imprimirFactura() {
            alert('üñ®Ô∏è Funci√≥n de impresi√≥n en desarrollo');
        }

        /**
         * Marcar factura como pagada
         */
        async function marcarComoPagada(ordenId) {
            if (!confirm('¬øConfirmas que esta factura ha sido pagada?')) {
                return;
            }
            
            try {
                // Esta funcionalidad requiere implementaci√≥n en el backend
                console.log('üí∞ Marcando factura como pagada para orden:', ordenId);
                alert('‚úÖ Funcionalidad en desarrollo - implementar endpoint de pago');
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // === MANEJO DE FILTROS ===

        /**
         * Actualizar filtros de estado seg√∫n el tipo seleccionado
         */
        function actualizarFiltrosEstado(tipo) {
            const estadosContainer = document.getElementById('estados-botones');
            const estadosLabel = document.getElementById('estados-label');
            
            filtrosActivos.estado = null;
            
            const filtrosConfig = {
                'facturas': {
                    label: 'Estado de Pago:',
                    botones: [
                        { estado: 'NO_PAGADA', texto: '‚ùå No Pagada' },
                        { estado: 'PAGADA', texto: '‚úÖ Pagada' }
                    ]
                },
                'ordenes': {
                    label: 'Estado de Orden:',
                    botones: [
                        { estado: 'EN_PROCESO', texto: '‚è≥ En Preparaci√≥n' },
                        { estado: 'LISTA', texto: 'üçΩÔ∏è Lista para Servir' },
                        { estado: 'SERVIDA', texto: '‚úÖ Servida' }
                    ]
                },
                'todos': {
                    label: 'Estado:',
                    botones: [
                        { estado: 'EN_PROCESO', texto: '‚è≥ En Preparaci√≥n' },
                        { estado: 'LISTA', texto: 'üçΩÔ∏è Lista para Servir' },
                        { estado: 'SERVIDA', texto: '‚úÖ Servida' },
                        { estado: 'NO_PAGADA', texto: 'üßæ Factura Pendiente' },
                        { estado: 'PAGADA', texto: 'üí∞ Factura Pagada' }
                    ]
                }
            };
            
            const config = filtrosConfig[tipo] || filtrosConfig['todos'];
            estadosLabel.textContent = config.label;
            
            estadosContainer.innerHTML = config.botones.map(btn => 
                `<button class="filtro-btn" data-estado="${btn.estado}">${btn.texto}</button>`
            ).join('');
            
            configurarFiltrosEstado();
        }

        /**
         * Configurar event listeners para filtros de estado
         */
        function configurarFiltrosEstado() {
            document.querySelectorAll('#estados-botones [data-estado]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        filtrosActivos.estado = null;
                    } else {
                        document.querySelectorAll('#estados-botones [data-estado]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        filtrosActivos.estado = btn.dataset.estado;
                    }
                    
                    console.log('üîç Filtro de estado actualizado:', filtrosActivos.estado);
                    aplicarFiltrosYRenderizar();
                });
            });
        }

        /**
         * Configurar event listeners para filtros
         */
        function configurarFiltros() {
            document.querySelectorAll('[data-tipo]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-tipo]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const nuevoTipo = btn.dataset.tipo;
                    filtrosActivos.tipo = nuevoTipo;
                    
                    console.log('üîç Filtro de tipo actualizado:', nuevoTipo);
                    actualizarFiltrosEstado(nuevoTipo);
                    aplicarFiltrosYRenderizar();
                });
            });
            
            configurarFiltrosEstado();
        }

        // === EVENT LISTENERS GLOBALES ===

        /**
         * Cerrar modales con ESC
         */
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modalesAbiertos = document.querySelectorAll('.modal-overlay.visible');
                modalesAbiertos.forEach(modal => {
                    modal.classList.remove('visible');
                });
                document.body.style.overflow = 'auto';
            }
        });

        /**
         * Cerrar modales clickeando fuera
         */
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('visible');
                    document.body.style.overflow = 'auto';
                }
            });
        });

        /**
         * Actualizar observaciones en tiempo real
         */
        document.addEventListener('input', (e) => {
            if (e.target.id && e.target.id.startsWith('obs-')) {
                const productoId = e.target.id.replace('obs-', '');
                if (carritoModificacion[productoId]) {
                    carritoModificacion[productoId].observaciones = e.target.value;
                    actualizarCarritoUI();
                }
            }
        });

        /**
         * Configurar bot√≥n de confirmar modificaci√≥n
         */
        document.getElementById('btn-confirmar-modificacion').addEventListener('click', confirmarModificacion);

        // === INICIALIZACI√ìN ===

        /**
         * Inicializar aplicaci√≥n
         */
        function inicializarApp() {
            console.log('üöÄ Inicializando sistema de modificar √≥rdenes...');
            
            // Configurar filtros
            configurarFiltros();
            
            // Cargar √≥rdenes iniciales
            cargarOrdenes();
            
            // Auto-actualizaci√≥n cada 30 segundos
            intervalId = setInterval(cargarOrdenes, 30000);
            
            console.log('‚úÖ Sistema inicializado correctamente');
        }

        // === AUTO-INICIALIZACI√ìN ===
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarApp);
        } else {
            inicializarApp();
        }

        // === FUNCIONES GLOBALES EXPUESTAS ===
        window.cargarOrdenes = cargarOrdenes;
        window.cerrarModal = cerrarModal;
        window.cambiarCantidadProducto = cambiarCantidadProducto;
        window.confirmarModificacion = confirmarModificacion;
        window.imprimirFactura = imprimirFactura;
        window.marcarComoPagada = marcarComoPagada;

        console.log('üìù Script de modificar √≥rdenes conectado al backend');
    </script>

<script>
    // === AGREGAR ESTAS VARIABLES GLOBALES AL INICIO ===
let paginacionData = {
    currentPage: 1,
    totalPages: 1,
    totalCount: 0,
    pageSize: 20,
    hasNext: false,
    hasPrevious: false
};

let busquedaActual = '';
let timeoutBusqueda = null;

// === MODIFICAR LA FUNCI√ìN cargarOrdenes EXISTENTE ===
async function cargarOrdenes(page = 1, mantenerFiltros = true) {
    const container = document.getElementById('ordenes-container');
    const header = container.querySelector('.ordenes-table-header');
    
    // Mostrar loading solo si es p√°gina nueva
    if (page === 1) {
        container.innerHTML = '';
        if (header) container.appendChild(header);
        
        const loading = document.createElement('div');
        loading.className = 'loading';
        loading.textContent = 'Cargando √≥rdenes disponibles...';
        container.appendChild(loading);
    }
    
    try {
        // Construir URL con par√°metros
        const params = new URLSearchParams({
            page: page,
            page_size: paginacionData.pageSize,
            filtro: filtrosActivos.tipo || 'todas'
        });
        
        if (busquedaActual) {
            params.append('search', busquedaActual);
        }
        
        if (filtrosActivos.estado) {
            params.append('estado', filtrosActivos.estado);
        }
        
        const url = `/api/mesero/todas-ordenes/?${params.toString()}`;
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìã Datos paginados recibidos:', data);
        
        // Actualizar datos globales
        ordenesData = data.ordenes || [];
        paginacionData = data.pagination || paginacionData;
        
        // Cargar productos si es necesario
        if (productosDisponibles.length === 0) {
            await cargarProductosDisponibles();
        }
        
        // Renderizar √≥rdenes
        renderizarOrdenes(ordenesData);
        
        // Renderizar controles de paginaci√≥n
        renderizarPaginacion();
        
        // Actualizar info de resultados
        actualizarInfoResultados();
        
    } catch (error) {
        console.error('‚ùå Error cargando √≥rdenes:', error);
        mostrarError(error.message);
    }
}

// === NUEVA FUNCI√ìN: RENDERIZAR PAGINACI√ìN ===
function renderizarPaginacion() {
    let container = document.getElementById('paginacion-container');
    
    // Crear contenedor si no existe
    if (!container) {
        container = document.createElement('div');
        container.id = 'paginacion-container';
        container.className = 'paginacion-container';
        
        // Insertar despu√©s del container de √≥rdenes
        const ordenesContainer = document.getElementById('ordenes-container');
        ordenesContainer.parentNode.insertBefore(container, ordenesContainer.nextSibling);
    }
    
    const { currentPage, totalPages, hasNext, hasPrevious } = paginacionData;
    
    if (totalPages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    
    let html = '';
    
    // Bot√≥n anterior
    html += `
        <button class="btn-pagina" 
                onclick="cambiarPagina(${currentPage - 1})" 
                ${!hasPrevious ? 'disabled' : ''}>
            ‚¨ÖÔ∏è Anterior
        </button>
    `;
    
    // N√∫meros de p√°gina (con l√≥gica inteligente)
    const rangoPaginas = generarRangoPaginas(currentPage, totalPages);
    
    rangoPaginas.forEach(page => {
        if (page === '...') {
            html += '<span style="padding: 0.75rem;">...</span>';
        } else {
            const isActive = page === currentPage;
            html += `
                <button class="btn-pagina ${isActive ? 'active' : ''}" 
                        onclick="cambiarPagina(${page})">
                    ${page}
                </button>
            `;
        }
    });
    
    // Bot√≥n siguiente
    html += `
        <button class="btn-pagina" 
                onclick="cambiarPagina(${currentPage + 1})" 
                ${!hasNext ? 'disabled' : ''}>
            Siguiente ‚û°Ô∏è
        </button>
    `;
    
    // Selector de tama√±o de p√°gina
    html += `
        <div class="page-size-selector">
            <label>Mostrar:</label>
            <select onchange="cambiarTama√±oPagina(this.value)">
                <option value="10" ${paginacionData.pageSize === 10 ? 'selected' : ''}>10</option>
                <option value="20" ${paginacionData.pageSize === 20 ? 'selected' : ''}>20</option>
                <option value="50" ${paginacionData.pageSize === 50 ? 'selected' : ''}>50</option>
                <option value="100" ${paginacionData.pageSize === 100 ? 'selected' : ''}>100</option>
            </select>
        </div>
    `;
    
    container.innerHTML = html;
}

// === NUEVA FUNCI√ìN: GENERAR RANGO INTELIGENTE DE P√ÅGINAS ===
function generarRangoPaginas(currentPage, totalPages) {
    const rango = [];
    
    if (totalPages <= 7) {
        // Mostrar todas las p√°ginas
        for (let i = 1; i <= totalPages; i++) {
            rango.push(i);
        }
    } else {
        // L√≥gica inteligente
        rango.push(1);
        
        if (currentPage > 4) {
            rango.push('...');
        }
        
        const start = Math.max(2, currentPage - 1);
        const end = Math.min(totalPages - 1, currentPage + 1);
        
        for (let i = start; i <= end; i++) {
            if (!rango.includes(i)) {
                rango.push(i);
            }
        }
        
        if (currentPage < totalPages - 3) {
            rango.push('...');
        }
        
        if (!rango.includes(totalPages)) {
            rango.push(totalPages);
        }
    }
    
    return rango;
}

// === NUEVA FUNCI√ìN: CAMBIAR P√ÅGINA ===
function cambiarPagina(page) {
    if (page < 1 || page > paginacionData.totalPages || page === paginacionData.currentPage) {
        return;
    }
    
    cargarOrdenes(page);
    
    // Scroll al top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// === NUEVA FUNCI√ìN: CAMBIAR TAMA√ëO DE P√ÅGINA ===
function cambiarTama√±oPagina(newSize) {
    paginacionData.pageSize = parseInt(newSize);
    cargarOrdenes(1); // Volver a p√°gina 1
}

// === NUEVA FUNCI√ìN: ACTUALIZAR INFO DE RESULTADOS ===
function actualizarInfoResultados() {
    let infoElement = document.getElementById('info-resultados');
    
    // Crear elemento si no existe
    if (!infoElement) {
        const infoContainer = document.querySelector('.info-resultados');
        if (infoContainer) {
            infoElement = infoContainer.querySelector('#info-resultados');
        }
    }
    
    if (!infoElement) return;
    
    const { currentPage, totalCount, pageSize } = paginacionData;
    const inicio = (currentPage - 1) * pageSize + 1;
    const fin = Math.min(currentPage * pageSize, totalCount);
    
    if (totalCount === 0) {
        infoElement.textContent = 'No se encontraron resultados';
    } else {
        infoElement.textContent = `Mostrando ${inicio}-${fin} de ${totalCount} √≥rdenes`;
    }
    
    // Actualizar filtro actual
    const filtroActualElement = document.getElementById('filtro-actual');
    if (filtroActualElement) {
        let textoFiltro = `Filtro: ${filtrosActivos.tipo || 'Todos'}`;
        if (filtrosActivos.estado) {
            textoFiltro += ` - ${filtrosActivos.estado}`;
        }
        if (busquedaActual) {
            textoFiltro += ` - B√∫squeda: "${busquedaActual}"`;
        }
        filtroActualElement.textContent = textoFiltro;
    }
}

// === NUEVAS FUNCIONES DE B√öSQUEDA ===
function buscarOrdenes() {
    const input = document.getElementById('busqueda-ordenes');
    busquedaActual = input.value.trim();
    cargarOrdenes(1); // Buscar desde p√°gina 1
}

function limpiarBusqueda() {
    const input = document.getElementById('busqueda-ordenes');
    input.value = '';
    busquedaActual = '';
    cargarOrdenes(1);
}

// === NUEVA FUNCI√ìN: ABRIR MODAL DE PAGO ===
function abrirModalPago(orden) {
    console.log('üí∞ Abriendo modal de pago para orden:', orden.orden_id);
    
    const modal = document.getElementById('modal-pago');
    const titulo = document.getElementById('modal-pago-titulo');
    const content = document.getElementById('modal-pago-content');
    
    if (!modal || !titulo || !content) {
        console.error('‚ùå Modal de pago no encontrado en el DOM');
        return;
    }
    
    // Configurar t√≠tulo
    titulo.textContent = `Procesar Pago - Factura #${orden.factura_info.numero || orden.factura_info.id}`;
    
    // Cargar formulario de pago
    cargarFormularioPago(orden);
    
    // Mostrar modal
    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

// === NUEVA FUNCI√ìN: CARGAR FORMULARIO DE PAGO ===
function cargarFormularioPago(orden) {
    const content = document.getElementById('modal-pago-content');
    const factura = orden.factura_info;
    const total = factura.total || 0;
    
    content.innerHTML = `
        <form class="form-pago" id="form-pago">
            <div class="monto-container">
                <div class="monto-info">
                    <div class="monto-total">Total a Pagar: $${total.toLocaleString()}</div>
                    <div class="monto-detalle">Factura #${factura.numero || factura.id}</div>
                    <div class="monto-detalle">Mesa: ${orden.es_domicilio ? 'üè† Domicilio' : orden.es_reserva ? 'üìÖ Reserva' : `üçΩÔ∏è Mesa ${orden.mesa.numero}`}</div>
                </div>
                
                <div class="form-group-pago">
                    <label class="form-label-pago" for="monto-pagado">Monto Recibido *</label>
                    <input type="number" 
                           id="monto-pagado" 
                           class="form-input-pago" 
                           placeholder="Ingrese el monto recibido"
                           step="0.01"
                           min="0"
                           required
                           oninput="calcularCambio(${total})">
                </div>
            </div>
            
            <div class="cambio-info" id="cambio-info">
                <!-- Se actualiza din√°micamente -->
            </div>
            
            <div class="form-group-pago">
                <label class="form-label-pago" for="metodo-pago">M√©todo de Pago *</label>
                <select id="metodo-pago" class="form-select-pago" required>
                    <option value="">-- Seleccione m√©todo --</option>
                    <option value="EFECTIVO">üíµ Efectivo</option>
                    <option value="TARJETA_CREDITO">üí≥ Tarjeta de Cr√©dito</option>
                    <option value="TARJETA_DEBITO">üí≥ Tarjeta de D√©bito</option>
                    <option value="TRANSFERENCIA">üè¶ Transferencia</option>
                    <option value="DIGITAL">üì± Pago Digital</option>
                    <option value="MIXTO">üîÑ Pago Mixto</option>
                </select>
            </div>
            
            <div class="form-group-pago">
                <label class="form-label-pago" for="cliente-nombre">Nombre del Cliente</label>
                <input type="text" 
                       id="cliente-nombre" 
                       class="form-input-pago" 
                       placeholder="Nombre del cliente (opcional)"
                       value="${orden.cliente_info?.nombre || ''}">
            </div>
            
            <div class="form-group-pago">
                <label class="form-label-pago" for="cliente-identificacion">Identificaci√≥n del Cliente</label>
                <input type="text" 
                       id="cliente-identificacion" 
                       class="form-input-pago" 
                       placeholder="C√©dula o documento (opcional)">
            </div>
            
            <div class="form-group-pago">
                <label class="form-label-pago" for="observaciones-pago">Observaciones del Pago</label>
                <textarea id="observaciones-pago" 
                          class="form-textarea-pago" 
                          placeholder="Observaciones adicionales (opcional)"></textarea>
            </div>
            
            <div class="botones-pago">
                <button type="button" class="btn-cancelar-pago" onclick="cerrarModal('modal-pago')">
                    ‚ùå Cancelar
                </button>
                <button type="submit" class="btn-confirmar-pago" id="btn-confirmar-pago">
                    üí∞ Confirmar Pago
                </button>
            </div>
        </form>
    `;
    
    // Configurar event listener del formulario
    document.getElementById('form-pago').addEventListener('submit', (e) => {
        e.preventDefault();
        confirmarPago(orden);
    });
}

// === NUEVA FUNCI√ìN: CALCULAR CAMBIO ===
function calcularCambio(totalFactura) {
    const montoInput = document.getElementById('monto-pagado');
    const cambioInfo = document.getElementById('cambio-info');
    
    if (!montoInput || !cambioInfo) return;
    
    const montoPagado = parseFloat(montoInput.value) || 0;
    const cambio = montoPagado - totalFactura;
    
    cambioInfo.style.display = 'block';
    cambioInfo.classList.remove('positivo', 'negativo');
    
    if (cambio > 0) {
        cambioInfo.classList.add('positivo');
        cambioInfo.innerHTML = `üí∞ Cambio a entregar: <strong>$${cambio.toLocaleString()}</strong>`;
    } else if (cambio < 0) {
        cambioInfo.classList.add('negativo');
        cambioInfo.innerHTML = `‚ö†Ô∏è Falta por pagar: <strong>$${Math.abs(cambio).toLocaleString()}</strong>`;
    } else {
        cambioInfo.classList.add('positivo');
        cambioInfo.innerHTML = `‚úÖ Pago exacto - Sin cambio`;
    }
}

// === NUEVA FUNCI√ìN: CONFIRMAR PAGO ===
async function confirmarPago(orden) {
    const btnConfirmar = document.getElementById('btn-confirmar-pago');
    const form = document.getElementById('form-pago');
    
    // Validar formulario
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Obtener datos del formulario
    const montoPagado = parseFloat(document.getElementById('monto-pagado').value);
    const metodoPago = document.getElementById('metodo-pago').value;
    const clienteNombre = document.getElementById('cliente-nombre').value.trim();
    const clienteIdentificacion = document.getElementById('cliente-identificacion').value.trim();
    const observacionesPago = document.getElementById('observaciones-pago').value.trim();
    
    const totalFactura = orden.factura_info.total;
    
    // Validaciones adicionales
    if (montoPagado <= 0) {
        alert('‚ùå El monto pagado debe ser mayor a 0');
        return;
    }
    
    if (montoPagado < totalFactura) {
        const confirmarParcial = confirm(`‚ö†Ô∏è El monto recibido (${montoPagado.toLocaleString()}) es menor al total de la factura (${totalFactura.toLocaleString()}).\n\n¬øDeseas procesar un pago parcial?`);
        if (!confirmarParcial) return;
    }
    
    // Confirmar operaci√≥n
    const cambio = montoPagado - totalFactura;
    let mensajeConfirmacion = `üí∞ Confirmar pago de $${montoPagado.toLocaleString()}`;
    if (cambio > 0) {
        mensajeConfirmacion += `\nüíµ Cambio a entregar: $${cambio.toLocaleString()}`;
    }
    mensajeConfirmacion += `\n\n¬øProceder con el pago?`;
    
    if (!confirm(mensajeConfirmacion)) return;
    
    // Deshabilitar bot√≥n y mostrar loading
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = '‚è≥ Procesando...';
    
    try {
        const response = await fetch(`/api/factura/${orden.factura_info.id}/pagar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                monto_pagado: montoPagado,
                metodo_pago: metodoPago,
                cliente_nombre: clienteNombre,
                cliente_identificacion: clienteIdentificacion,
                observaciones_pago: observacionesPago
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || `Error ${response.status}`);
        }
        
        // Mostrar resultado exitoso
        let mensaje = `‚úÖ Pago procesado exitosamente!\n\n`;
        mensaje += `üí∞ Total factura: $${totalFactura.toLocaleString()}\n`;
        mensaje += `üíµ Monto recibido: $${montoPagado.toLocaleString()}\n`;
        
        if (result.pago.cambio > 0) {
            mensaje += `üîÑ Cambio: $${result.pago.cambio.toLocaleString()}\n`;
        }
        
        mensaje += `üìä Estado: ${result.pago.estado_pago}\n`;
        mensaje += `üí≥ M√©todo: ${metodoPago}`;
        
        alert(mensaje);
        
        // Cerrar modal y recargar
        cerrarModal('modal-pago');
        cargarOrdenes();
        
    } catch (error) {
        console.error('‚ùå Error procesando pago:', error);
        alert(`‚ùå Error procesando pago: ${error.message}`);
    } finally {
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = 'üí∞ Confirmar Pago';
    }
}

// === MODIFICAR LA FUNCI√ìN marcarComoPagada EXISTENTE ===
async function marcarComoPagada(ordenId) {
    const orden = ordenesData.find(o => o.orden_id === ordenId);
    if (!orden || !orden.factura_info) {
        alert('‚ùå No se encontr√≥ la orden o factura');
        return;
    }
    
    // Abrir modal de pago en lugar de confirmaci√≥n simple
    abrirModalPago(orden);
}

// === B√öSQUEDA EN TIEMPO REAL CON DEBOUNCE ===
document.addEventListener('DOMContentLoaded', () => {
    const inputBusqueda = document.getElementById('busqueda-ordenes');
    if (inputBusqueda) {
        inputBusqueda.addEventListener('input', (e) => {
            clearTimeout(timeoutBusqueda);
            timeoutBusqueda = setTimeout(() => {
                busquedaActual = e.target.value.trim();
                cargarOrdenes(1);
            }, 500); // Esperar 500ms despu√©s de que el usuario deje de escribir
        });
        
        // Buscar con Enter
        inputBusqueda.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(timeoutBusqueda);
                buscarOrdenes();
            }
        });
    }
});

// === EXPONER FUNCIONES GLOBALMENTE ===
window.cambiarPagina = cambiarPagina;
window.cambiarTama√±oPagina = cambiarTama√±oPagina;
window.buscarOrdenes = buscarOrdenes;
window.limpiarBusqueda = limpiarBusqueda;
window.abrirModalPago = abrirModalPago;
window.calcularCambio = calcularCambio;
window.confirmarPago = confirmarPago;

// === AGREGAR AL FINAL DEL SCRIPT EXISTENTE ===
console.log('‚úÖ Funcionalidades de paginaci√≥n y pago agregadas correctamente');
</script>