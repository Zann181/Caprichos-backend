<style>
    /* Estilos específicos para modificar orden */
    .mesa-selector { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 2rem; 
    }
    
    .mesa-btn { 
        padding: 1.2rem; 
        border: 2px solid var(--gris-piedra); 
        background: white; 
        border-radius: 8px; 
        cursor: pointer; 
        text-align: center; 
        transition: all 0.3s; 
        position: relative;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .mesa-btn:hover { 
        border-color: var(--naranja-tostado); 
        background-color: rgba(232, 119, 46, 0.1); 
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(232, 119, 46, 0.2);
    }
    
    .mesa-btn.ocupada { 
        border-color: var(--amarillo-modificado); 
        background-color: rgba(255, 193, 7, 0.1); 
    }
    
    .mesa-btn.domicilio { 
        border-color: #17a2b8; 
        background-color: rgba(23, 162, 184, 0.1); 
    }
    
    .mesa-btn.reserva { 
        border-color: #6f42c1; 
        background-color: rgba(111, 66, 193, 0.1); 
    }
    
    .mesa-btn.seleccionada { 
        border-color: var(--naranja-tostado); 
        background-color: var(--naranja-tostado); 
        color: white; 
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(232, 119, 46, 0.4);
    }
    
    .mesa-numero { 
        font-size: 1.1em; 
        font-weight: 700; 
        margin-bottom: 0.5rem; 
    }
    
    .mesa-info { 
        font-size: 0.75em; 
        opacity: 0.8; 
        margin-bottom: 0.25rem; 
    }
    
    .cliente-info { 
        font-size: 0.7em; 
        font-weight: 600; 
        color: var(--naranja-tostado); 
        margin-top: 0.5rem; 
        line-height: 1.2;
    }
    
    .mesa-btn.seleccionada .cliente-info {
        color: white;
        opacity: 0.9;
    }
    
    .mesa-estado { 
        position: absolute; 
        top: 8px; 
        right: 8px; 
        background: var(--amarillo-modificado); 
        color: white; 
        border-radius: 50%; 
        width: 26px; 
        height: 26px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 12px; 
        font-weight: bold;
    }
    
    .estado-domicilio { background: #17a2b8; }
    .estado-reserva { background: #6f42c1; }
    
    .orden-existente { 
        background-color: rgba(23, 162, 184, 0.1); 
        border: 1px solid var(--azul-info); 
        border-radius: 8px; 
        padding: 1.5rem; 
        margin-bottom: 2rem; 
    }
    
    .orden-existente h3 { 
        color: var(--azul-info); 
        margin-bottom: 1rem; 
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .productos-existentes { font-size: 0.9em; }
    
    .producto-existente { 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 0.5rem 0; 
        border-bottom: 1px solid rgba(23, 162, 184, 0.2);
    }
    
    .producto-existente:last-child { border-bottom: none; }
    
    .producto-existente.listo { 
        color: var(--verde-listo); 
        font-weight: 600; 
    }
    
    .producto-existente.agregado-despues { 
        color: var(--amarillo-modificado); 
        font-weight: 600; 
        background-color: rgba(255, 193, 7, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.25rem 0;
        border-left: 4px solid var(--amarillo-modificado);
    }
    
    .dashboard-grid-modificar { 
        display: grid; 
        grid-template-columns: 2fr 1fr; 
        gap: 2rem; 
        margin-top: 1rem; 
    }
    
    .btn-agregar-disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
    }
    
    /* Estilos para categorías y productos */
    .category-tabs { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        margin-bottom: 1.5rem; 
        border-bottom: 2px solid var(--gris-piedra); 
        padding-bottom: 1rem; 
    }
    
    .category-btn { 
        background-color: transparent; 
        border: 1px solid var(--naranja-tostado); 
        color: var(--naranja-tostado); 
        padding: 0.5rem 1rem; 
        border-radius: 20px; 
        cursor: pointer; 
        transition: all 0.2s; 
        font-size: 14px;
    }
    
    .category-btn:hover, .category-btn.active { 
        background-color: var(--naranja-tostado); 
        color: white; 
    }
    
    .product-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
        gap: 1.5rem; 
    }
    
    .product-item { 
        border: 1px solid var(--gris-piedra); 
        border-radius: 8px; 
        padding: 1rem; 
        text-align: center; 
        display: flex; 
        flex-direction: column; 
    }
    
    .product-item h4, .product-item p { margin: 0.25rem 0; }
    
    .quantity-selector { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        margin: 1rem 0; 
    }
    
    .quantity-btn { 
        width: 40px; 
        height: 40px; 
        border: 1px solid var(--gris-piedra); 
        background-color: #fff; 
        font-size: 24px; 
        font-weight: bold; 
        cursor: pointer; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 0; 
        line-height: 1; 
    }
    
    .quantity-value { 
        width: 50px; 
        font-size: 18px; 
        font-weight: 600; 
        text-align: center; 
    }
    
    .observaciones-input { 
        font-size: 12px; 
        padding: 5px; 
        margin-top: auto; 
        border: 1px solid var(--gris-piedra); 
        border-radius: 4px; 
        width: 100%; 
        box-sizing: border-box; 
    }
    
    .order-item { 
        display: grid; 
        grid-template-columns: 1fr 120px; 
        gap: 1rem; 
        align-items: center; 
        padding: 0.75rem 0; 
        border-bottom: 1px solid #eee; 
    }
    
    .order-item-info { font-weight: 600; }
    .order-item-obs { 
        font-size: 0.8em; 
        color: #666; 
        grid-column: 1 / 3; 
    }
    
    .order-total { 
        text-align: right; 
        font-size: 1.2rem; 
        font-family: var(--fuente-titulos); 
        margin: 1rem 0; 
    }

    .stock-indicator {
        font-size: 0.8em;
        color: #666;
        margin-top: 0.5rem;
    }

    .stock-low {
        color: #ff6b6b;
        font-weight: 600;
    }

    .stock-out {
        color: #ff0000;
        font-weight: 700;
    }
    
    @media (max-width: 900px) {
        .dashboard-grid-modificar { grid-template-columns: 1fr; }
        .mesa-selector { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        .product-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
</style>

<h2>🔧 Modificar Orden Existente</h2>
<p>Selecciona una mesa, domicilio o reserva activa para agregar productos:</p>

<div class="mesa-selector" id="mesas-ocupadas-container">
    <div class="loading">Cargando mesas ocupadas...</div>
</div>

<div id="orden-actual-info" style="display: none;"></div>

<div id="agregar-productos-container" style="display: none;">
    <hr>
    <h3>➕ Agregar Productos a la Orden</h3>
    
    <div class="dashboard-grid-modificar">
        <div id="menu-productos-modificar">
            <div class="category-tabs">
                <button class="category-btn active" data-category-id="all" data-context="modificar">Todos</button>
                {% for categoria in categorias %}
                <button class="category-btn" data-category-id="{{ categoria.id }}" data-context="modificar">{{ categoria.nombre }}</button>
                {% endfor %}
            </div>
            <div class="product-grid" id="productos-modificar"></div>
        </div>
        
        <div id="resumen-modificacion">
            <h3>📦 Productos a Agregar</h3>
            <div id="lista-productos-agregar">
                <p style="color: #888; text-align: center;">Selecciona productos para agregar.</p>
            </div>
            <hr>
            <div class="order-total">
                <strong>Adicional: $<span id="total-adicional">0</span></strong>
            </div>
            <button id="btn-agregar-productos" class="btn btn-agregar-disabled" style="width: 100%;" disabled>
                Agregar a la Orden
            </button>
        </div>
    </div>
</div>

<script>
window.inicializar_modificar_orden = function() {
    console.log('🔧 Inicializando modificar orden...');
    
    const ordenModificar = {};
    const stockVirtual = {}; // ✅ NUEVO: Seguimiento del stock virtual
    let ordenSeleccionadaId = null;
    let mesaSeleccionadaId = null;
    let ordenTieneFacturaPendiente = false;

    // === GESTIÓN DE STOCK VIRTUAL ===
    function inicializarStockVirtual() {
        // Copiar el stock actual de todos los productos
        document.querySelectorAll('#productos-modificar .product-item').forEach(item => {
            const id = item.dataset.id;
            const stockOriginal = parseInt(item.dataset.stock, 10);
            stockVirtual[id] = stockOriginal;
        });
    }

    function actualizarStockVirtual(productoId, cantidadUsada) {
        if (stockVirtual[productoId] !== undefined) {
            stockVirtual[productoId] -= cantidadUsada;
            actualizarIndicadorStock(productoId);
        }
    }

    function restaurarStockVirtual(productoId, cantidadARestaurar) {
        if (stockVirtual[productoId] !== undefined) {
            const stockOriginal = parseInt(
                document.querySelector(`[data-id="${productoId}"]`)?.dataset.stock || '0'
            );
            stockVirtual[productoId] = Math.min(
                stockVirtual[productoId] + cantidadARestaurar,
                stockOriginal
            );
            actualizarIndicadorStock(productoId);
        }
    }

    function actualizarIndicadorStock(productoId) {
        const productItem = document.querySelector(`#productos-modificar .product-item[data-id="${productoId}"]`);
        if (!productItem) return;

        let indicador = productItem.querySelector('.stock-indicator');
        if (!indicador) {
            indicador = document.createElement('div');
            indicador.className = 'stock-indicator';
            productItem.appendChild(indicador);
        }

        const stockActual = stockVirtual[productoId];
        const stockOriginal = parseInt(productItem.dataset.stock, 10);

        indicador.className = 'stock-indicator';
        
        if (stockActual <= 0) {
            indicador.className += ' stock-out';
            indicador.textContent = '❌ Sin stock';
        } else if (stockActual <= 3) {
            indicador.className += ' stock-low';
            indicador.textContent = `⚠️ Stock: ${stockActual}`;
        } else {
            indicador.textContent = `📦 Stock: ${stockActual}`;
        }
    }

    // === SELECCIONAR MESA PARA MODIFICAR ===
    function seleccionarMesaParaModificar(ordenId, mesaId) {
        console.log('🎯 Seleccionando orden:', ordenId, 'mesa:', mesaId);
        
        const mesaButtons = document.querySelectorAll('.mesa-btn');
        mesaButtons.forEach(btn => btn.classList.remove('seleccionada'));
        
        const targetButton = document.querySelector(`[data-orden-id="${ordenId}"][data-mesa-id="${mesaId}"]`) || 
                           document.querySelector(`[data-orden-id="${ordenId}"]`);
        
        if (targetButton) {
            targetButton.classList.add('seleccionada');
        } else {
            console.warn(`⚠️ No se encontró el botón para orden ${ordenId}, mesa ${mesaId}`);
        }
        
        mesaSeleccionadaId = mesaId;
        ordenSeleccionadaId = ordenId;
        
        const infoContainer = document.getElementById('orden-actual-info');
        infoContainer.style.display = 'block';
        infoContainer.innerHTML = '<div class="loading">⏳ Cargando información de la orden...</div>';
        
        fetch(`/api/mesa/${mesaId}/orden/`)
            .then(response => response.json())
            .then(ordenData => {
                if (ordenData.error) throw new Error(ordenData.error);
                console.log('📋 Orden cargada:', ordenData);
                
                ordenTieneFacturaPendiente = ordenData.tiene_factura_pendiente || false;
                console.log('💰 Tiene factura pendiente:', ordenTieneFacturaPendiente);
                
                mostrarOrdenActual(ordenData);
                prepararMenuModificacion();
                document.getElementById('agregar-productos-container').style.display = 'block';
            })
            .catch(error => {
                console.error('❌ Error obteniendo orden:', error);
                infoContainer.innerHTML = `<div class="error-message"><strong>❌ Error:</strong> ${error.message}</div>`;
            });
    }

    // === CARGAR MESAS OCUPADAS ===
    function cargarMesasOcupadas() {
        const container = document.getElementById('mesas-ocupadas-container');
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">⏳ Cargando mesas ocupadas...</div>';
        
        fetch('/api/mesero/mesas-ocupadas/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(mesas => {
                console.log('🏠 Mesas cargadas:', mesas);
                
                if (mesas.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #888;">
                            <h3>😊 ¡No hay órdenes activas!</h3>
                            <p>No hay mesas, domicilios o reservas para modificar en este momento.</p>
                            <button class="btn" onclick="cargarMesasOcupadas()">🔄 Actualizar</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                mesas.forEach(mesa => {
                    const mesaBtn = document.createElement('div');
                    let clases = 'mesa-btn ocupada';
                    let iconoEstado = '🍽️';
                    let clienteInfo = '';
                    
                    if (mesa.es_domicilio) {
                        clases += ' domicilio';
                        iconoEstado = '🚚';
                        if (mesa.cliente_nombre) {
                            clienteInfo = `<div class="cliente-info">👤 ${mesa.cliente_nombre}</div>`;
                            if (mesa.direccion && mesa.direccion.length > 0) {
                                const direccionCorta = mesa.direccion.length > 30 ? 
                                    mesa.direccion.substring(0, 30) + '...' : 
                                    mesa.direccion;
                                clienteInfo += `<div class="cliente-info">📍 ${direccionCorta}</div>`;
                            }
                            if (mesa.telefono) {
                                clienteInfo += `<div class="cliente-info">📞 ${mesa.telefono}</div>`;
                            }
                        }
                    } else if (mesa.es_reserva) {
                        clases += ' reserva';
                        iconoEstado = '📅';
                        if (mesa.cliente_nombre) {
                            clienteInfo = `<div class="cliente-info">👤 ${mesa.cliente_nombre}</div>`;
                            if (mesa.telefono) {
                                clienteInfo += `<div class="cliente-info">📞 ${mesa.telefono}</div>`;
                            }
                            if (mesa.fecha_reserva) {
                                clienteInfo += `<div class="cliente-info">📅 ${mesa.fecha_reserva}</div>`;
                            }
                        }
                    }
                    
                    mesaBtn.className = clases;
                    mesaBtn.dataset.mesaId = mesa.mesa_real_id || mesa.id;
                    mesaBtn.dataset.ordenId = mesa.orden_id;
                    
                    mesaBtn.innerHTML = `
                        <div class="mesa-estado ${mesa.es_domicilio ? 'estado-domicilio' : (mesa.es_reserva ? 'estado-reserva' : '')}">${iconoEstado}</div>
                        <div class="mesa-numero">${mesa.numero}</div>
                        <div class="mesa-info">${mesa.ubicacion}</div>
                        <div class="mesa-info">${mesa.productos_count} productos</div>
                        ${clienteInfo}
                    `;
                    
                    mesaBtn.addEventListener('click', () => seleccionarMesaParaModificar(mesa.orden_id, mesa.mesa_real_id || mesa.id));
                    container.appendChild(mesaBtn);
                });
            })
            .catch(error => {
                console.error('❌ Error cargando mesas ocupadas:', error);
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <div class="error-message">
                            <strong>❌ Error al cargar mesas</strong><br>
                            ${error.message}<br>
                            <button class="btn" onclick="cargarMesasOcupadas()">🔄 Reintentar</button>
                        </div>
                    </div>
                `;
            });
    }

    // === MOSTRAR ORDEN ACTUAL ===
    function mostrarOrdenActual(ordenData) {
        const container = document.getElementById('orden-actual-info');
        
        let productosHtml = '';
        let estadoGeneral = '';
        let totalOriginal = 0;
        let productosOriginales = 0;
        let productosAgregados = 0;
        
        // ✅ DETERMINAR TIPO DE ORDEN Y EXTRAER INFO CLIENTE
        const esDomicilio = ordenData.mesa.numero === 0;
        const esReserva = ordenData.mesa.numero === 50;
        let tipoOrden = 'Mesa';
        let iconoTipo = '🍽️';
        let infoCliente = '';
        
        if (esDomicilio) {
            tipoOrden = 'Domicilio';
            iconoTipo = '🚚';
            if (ordenData.observaciones) {
                const clienteMatch = ordenData.observaciones.match(/Cliente:\s*([^,]+)/i);
                const direccionMatch = ordenData.observaciones.match(/Dir(?:ección)?:\s*([^,\n]+)/i);
                const telefonoMatch = ordenData.observaciones.match(/Tel(?:éfono)?:\s*([^,]+)/i);
                
                if (clienteMatch) {
                    infoCliente = `<div style="background: rgba(23, 162, 184, 0.1); padding: 0.8rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #17a2b8;">
                        <strong>🚚 Información del Domicilio</strong><br>
                        <strong>👤 Cliente:</strong> ${clienteMatch[1].trim()}<br>
                        ${direccionMatch ? `<strong>📍 Dirección:</strong> ${direccionMatch[1].trim()}<br>` : ''}
                        ${telefonoMatch ? `<strong>📞 Teléfono:</strong> ${telefonoMatch[1].trim()}` : ''}
                    </div>`;
                }
            }
        } else if (esReserva) {
            tipoOrden = 'Reserva';
            iconoTipo = '📅';
            if (ordenData.observaciones) {
                const clienteMatch = ordenData.observaciones.match(/(?:Reserva|Cliente):\s*([^,]+)/i);
                const personasMatch = ordenData.observaciones.match(/Personas?:\s*(\d+)/i);
                const fechaMatch = ordenData.observaciones.match(/Fecha:\s*([^,\n]+)/i);
                const telefonoMatch = ordenData.observaciones.match(/Tel(?:éfono)?:\s*([^,]+)/i);
                
                if (clienteMatch) {
                    infoCliente = `<div style="background: rgba(111, 66, 193, 0.1); padding: 0.8rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #6f42c1;">
                        <strong>📅 Información de la Reserva</strong><br>
                        <strong>👤 Cliente:</strong> ${clienteMatch[1].trim()}<br>
                        ${personasMatch ? `<strong>👥 Personas:</strong> ${personasMatch[1]}<br>` : ''}
                        ${fechaMatch ? `<strong>📅 Fecha:</strong> ${fechaMatch[1].trim()}<br>` : ''}
                        ${telefonoMatch ? `<strong>📞 Teléfono:</strong> ${telefonoMatch[1].trim()}` : ''}
                    </div>`;
                }
            }
        }
        
        // Procesar productos
        ordenData.productos.forEach(p => {
            const subtotal = p.cantidad * p.precio_unitario;
            totalOriginal += subtotal;
            
            let claseProducto = '';
            let iconoEstado = '';
            let tipoTexto = '';
            
            if (p.agregado_despues) {
                claseProducto = 'agregado-despues';
                tipoTexto = '🆕 Agregado después';
                productosAgregados++;
            } else {
                productosOriginales++;
            }
            
            if (p.estado === 'LISTO') {
                claseProducto += ' listo';
                iconoEstado = '✅';
            } else {
                iconoEstado = '⏳';
            }
            
            productosHtml += `
                <div class="producto-existente ${claseProducto}">
                    <div>
                        <span>${iconoEstado} ${p.cantidad}x ${p.nombre}</span>
                        ${tipoTexto ? `<div style="font-size: 0.8em; margin-top: 2px;">${tipoTexto}</div>` : ''}
                        ${p.observaciones ? `<div style="font-size: 0.8em; color: var(--naranja-tostado); font-style: italic;">📝 ${p.observaciones}</div>` : ''}
                    </div>
                    <span>$${subtotal.toLocaleString()}</span>
                </div>
            `;
        });
        
        // Determinar estado general
        const productosListos = ordenData.productos.filter(p => p.estado === 'LISTO').length;
        const productosPendientes = ordenData.productos.length - productosListos;
        
        if (productosListos === 0) {
            estadoGeneral = '⏳ En preparación';
        } else if (productosPendientes === 0) {
            estadoGeneral = '✅ Lista para servir';
        } else {
            estadoGeneral = `🔄 Parcial (${productosListos}/${ordenData.productos.length} listos)`;
        }
        
        container.innerHTML = `
            <div class="orden-existente">
                <h3>
                    ${iconoTipo} Orden Actual - ${tipoOrden} ${esDomicilio || esReserva ? '' : `#${ordenData.mesa.numero}`}
                    <span style="margin-left: auto; font-size: 0.8em; color: #666;">${estadoGeneral}</span>
                </h3>
                
                ${infoCliente}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem; margin-top: 1rem; font-size: 0.9em;">
                    <div><strong>Productos originales:</strong> ${productosOriginales}</div>
                    <div><strong>Agregados después:</strong> ${productosAgregados}</div>
                    <div><strong>Total productos:</strong> ${ordenData.productos.length}</div>
                </div>
                
                <div class="productos-existentes">
                    ${productosHtml}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(23, 162, 184, 0.2);">
                    <div><strong>Total actual: $${totalOriginal.toLocaleString()}</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Estado: ${ordenData.estado}</div>
                </div>
                
                ${ordenData.observaciones && !esDomicilio && !esReserva ? `
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 0.8rem; border-radius: 4px; margin-top: 1rem; border-left: 4px solid var(--amarillo-modificado);">
                        <strong>📝 Observaciones adicionales:</strong><br>
                        <em>${ordenData.observaciones}</em>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // === PREPARAR MENÚ DE MODIFICACIÓN ===
    function prepararMenuModificacion() {
        // Limpiar orden de modificación
        Object.keys(ordenModificar).forEach(key => delete ordenModificar[key]);
        
        // Obtener productos originales y clonar al área de modificación
        const menuOriginal = document.querySelector('#menu-productos .product-grid');
        const menuModificar = document.getElementById('productos-modificar');
        
        if (menuOriginal) {
            menuModificar.innerHTML = menuOriginal.innerHTML;
            
            // Resetear cantidades en el menú de modificación
            menuModificar.querySelectorAll('.quantity-value').forEach(el => el.textContent = '0');
            menuModificar.querySelectorAll('.observaciones-input').forEach(el => el.value = '');
            
            // ✅ NUEVO: Inicializar stock virtual
            inicializarStockVirtual();
            
            // Mostrar indicadores de stock iniciales
            document.querySelectorAll('#productos-modificar .product-item').forEach(item => {
                const id = item.dataset.id;
                actualizarIndicadorStock(id);
            });
            
        } else {
            // Si no hay menú original, crear mensaje de ayuda
            menuModificar.innerHTML = `
                <p style="color: #666; text-align: center; grid-column: 1 / -1; padding: 2rem;">
                    ⚠️ No se pudo cargar el menú de productos.<br>
                    <button class="btn" onclick="window.recargarPestana('nuevo-pedido')" style="margin-top: 1rem;">🔄 Cargar desde Nuevo Pedido</button>
                </p>
            `;
            return;
        }
        
        // Agregar event listeners para el menú de modificación
        menuModificar.addEventListener('click', e => {
            if (e.target.classList.contains('quantity-btn')) {
                const id = e.target.closest('.product-item').dataset.id;
                manejarCambioCantidad(id, e.target.dataset.action);
            }
        });
        
        menuModificar.addEventListener('input', e => {
            if (e.target.classList.contains('observaciones-input')) {
                const id = e.target.closest('.product-item').dataset.id;
                if (ordenModificar[id]) {
                    ordenModificar[id].observaciones = e.target.value;
                    actualizarResumenModificacion();
                }
            }
        });
        
        actualizarResumenModificacion();
    }

    // === MANEJAR CAMBIOS DE CANTIDAD (MEJORADO) ===
    function manejarCambioCantidad(id, accion) {
        const productItem = document.querySelector(`#productos-modificar .product-item[data-id="${id}"]`);
        if (!productItem) return;
        
        const stockDisponible = stockVirtual[id] || 0;
        let cantidadActual = ordenModificar[id] ? ordenModificar[id].cantidad : 0;
        let cantidadAnterior = cantidadActual;

        if (accion === 'increment' && stockDisponible > 0) {
            cantidadActual++;
            // ✅ NUEVO: Reducir stock virtual inmediatamente
            actualizarStockVirtual(id, 1);
        } else if (accion === 'decrement' && cantidadActual > 0) {
            cantidadActual--;
            // ✅ NUEVO: Restaurar stock virtual inmediatamente
            restaurarStockVirtual(id, 1);
        } else if (accion === 'increment' && stockDisponible <= 0) {
            window.mostrarNotificacion('❌ No hay suficiente stock disponible', 'error');
            return;
        }

        if (cantidadActual > 0) {
            if (!ordenModificar[id]) {
                ordenModificar[id] = {
                    id: id,
                    nombre: productItem.dataset.nombre,
                    precio: parseFloat(productItem.dataset.precio),
                    observaciones: productItem.querySelector('.observaciones-input').value
                };
            }
            ordenModificar[id].cantidad = cantidadActual;
        } else {
            delete ordenModificar[id];
        }

        // Actualizar UI del producto
        productItem.querySelector('.quantity-value').textContent = cantidadActual;
        
        // ✅ NUEVO: Actualizar botones según stock disponible
        const incrementBtn = productItem.querySelector('[data-action="increment"]');
        const decrementBtn = productItem.querySelector('[data-action="decrement"]');
        
        if (stockVirtual[id] <= 0) {
            incrementBtn.disabled = true;
            incrementBtn.style.opacity = '0.3';
            incrementBtn.style.cursor = 'not-allowed';
        } else {
            incrementBtn.disabled = false;
            incrementBtn.style.opacity = '1';
            incrementBtn.style.cursor = 'pointer';
        }
        
        if (cantidadActual <= 0) {
            decrementBtn.disabled = true;
            decrementBtn.style.opacity = '0.3';
            decrementBtn.style.cursor = 'not-allowed';
        } else {
            decrementBtn.disabled = false;
            decrementBtn.style.opacity = '1';
            decrementBtn.style.cursor = 'pointer';
        }
        
        actualizarResumenModificacion();
    }

    // === ACTUALIZAR RESUMEN DE MODIFICACIÓN ===
    function actualizarResumenModificacion() {
        const container = document.getElementById('lista-productos-agregar');
        const totalEl = document.getElementById('total-adicional');
        const btnAgregar = document.getElementById('btn-agregar-productos');
        
        container.innerHTML = '';
        let totalAdicional = 0;
        
        if (Object.keys(ordenModificar).length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center;">Selecciona productos para agregar.</p>';
            btnAgregar.disabled = true;
            btnAgregar.classList.add('btn-agregar-disabled');
        } else {
            btnAgregar.disabled = false;
            btnAgregar.classList.remove('btn-agregar-disabled');
            Object.values(ordenModificar).forEach(item => {
                const subtotal = item.cantidad * item.precio;
                totalAdicional += subtotal;
                container.innerHTML += `
                    <div class="order-item">
                        <span class="order-item-info">${item.cantidad}x ${item.nombre}</span>
                        <span>${subtotal.toLocaleString()}</span>
                        ${item.observaciones ? `<div class="order-item-obs">📝 ${item.observaciones}</div>` : ''}
                    </div>
                `;
            });
        }
        
        totalEl.textContent = totalAdicional.toLocaleString();
    }

    // === RESTAURAR STOCK EN CASO DE ERROR ===
    function restaurarTodoElStock() {
        console.log('🔄 Restaurando todo el stock virtual por error...');
        Object.keys(ordenModificar).forEach(id => {
            const cantidad = ordenModificar[id].cantidad;
            restaurarStockVirtual(id, cantidad);
        });
        
        // Limpiar orden y UI
        Object.keys(ordenModificar).forEach(key => delete ordenModificar[key]);
        
        // Resetear UI
        document.querySelectorAll('#productos-modificar .quantity-value').forEach(el => el.textContent = '0');
        document.querySelectorAll('#productos-modificar .quantity-btn').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        });
        
        actualizarResumenModificacion();
    }

    // === FILTROS DE CATEGORÍAS PARA MODIFICACIÓN ===
    document.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.context === 'modificar') {
            const selectedCategoryId = e.target.dataset.categoryId;
            const parentContainer = e.target.closest('#agregar-productos-container');
            const categoryButtons = parentContainer.querySelectorAll('[data-context="modificar"]');
            const productItems = parentContainer.querySelectorAll('.product-item');
            
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            productItems.forEach(item => {
                if (selectedCategoryId === 'all' || item.dataset.categoryId === selectedCategoryId) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    });

    // === ENVIAR PRODUCTOS ADICIONALES (LÓGICA CORREGIDA) ===
    document.getElementById('btn-agregar-productos').addEventListener('click', async () => {
        if (!ordenSeleccionadaId || Object.keys(ordenModificar).length === 0) return;
        
        const productosParaAgregar = Object.values(ordenModificar).map(p => ({
            id: p.id,
            cantidad: p.cantidad,
            observaciones: p.observaciones || ''
        }));
        
        // ✅ CORRECCIÓN: Mensaje más específico según el tipo de orden
        const tipoAccion = ordenTieneFacturaPendiente ? 
            'agregar productos a la orden facturada (se actualizará el total)' : 
            'agregar productos a la orden';
            
        if (!confirm(`¿Confirmar ${tipoAccion}?`)) return;
        
        const btnAgregar = document.getElementById('btn-agregar-productos');
        btnAgregar.disabled = true;
        btnAgregar.textContent = '⏳ Agregando...';
        
        // ✅ CORRECCIÓN: URL corregida con manejo de errores
        let apiUrl;
        if (ordenTieneFacturaPendiente) {
            // Usar la URL estándar de agregar productos y manejar en el backend
            apiUrl = `/api/orden/${ordenSeleccionadaId}/agregar-productos/`;
        } else {
            apiUrl = `/api/orden/${ordenSeleccionadaId}/agregar-productos/`;
        }
            
        console.log(`📡 Enviando a: ${apiUrl}`);
        console.log(`💰 Orden tiene factura pendiente: ${ordenTieneFacturaPendiente}`);

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': window.csrfToken 
                },
                body: JSON.stringify({ 
                    productos: productosParaAgregar,
                    es_orden_facturada: ordenTieneFacturaPendiente // ✅ NUEVO: Flag para el backend
                })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || `Error ${response.status}: ${response.statusText}`);
            }
            
            window.mostrarNotificacion(`✅ ${result.mensaje}`, 'success');
            
            // ✅ ÉXITO: Limpiar orden sin restaurar stock (ya fue usado)
            Object.keys(ordenModificar).forEach(key => delete ordenModificar[key]);
            
            // Resetear UI
            document.querySelectorAll('#productos-modificar .quantity-value').forEach(el => el.textContent = '0');
            
            actualizarResumenModificacion();
            seleccionarMesaParaModificar(ordenSeleccionadaId, mesaSeleccionadaId); // Recargar
            
        } catch (error) {
            console.error('❌ Error agregando productos:', error);
            window.mostrarNotificacion(`❌ Error: ${error.message}`, 'error');
            
            // ✅ ERROR: Restaurar todo el stock virtual
            restaurarTodoElStock();
            
        } finally {
            btnAgregar.disabled = false;
            btnAgregar.textContent = 'Agregar a la Orden';
        }
    });

    // === HACER FUNCIONES DISPONIBLES GLOBALMENTE ===
    window.cargarMesasOcupadas = cargarMesasOcupadas;

    // === INICIALIZACIÓN ===
    cargarMesasOcupadas();
    
    console.log('✅ Modificar orden inicializado correctamente');
    
    return function cleanup() {
        console.log('🧹 Limpiando modificar orden');
        const container = document.getElementById('agregar-productos-container');
        if (container) {
            container.style.display = 'none';
        }
        
        // ✅ NUEVO: Restaurar todo el stock al limpiar
        if (Object.keys(ordenModificar).length > 0) {
            console.log('🔄 Restaurando stock virtual al limpiar...');
            restaurarTodoElStock();
        }
    };
};

// === FUNCIONES GLOBALES ===
window.actualizar_modificar_orden = function() {
    if (typeof window.cargarMesasOcupadas === 'function') {
        console.log('🔄 Actualizando mesas ocupadas...');
        window.cargarMesasOcupadas();
    }
    console.log('🔄 Actualizando modificar orden por long polling');
};

// Hacer la función de inicialización disponible globalmente antes de que se llame
console.log('✅ Función inicializar_modificar_orden definida globalmente');
</script>