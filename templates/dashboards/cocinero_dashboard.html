<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Cocina - Caprichos Criollos</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Inter:wght@400;600&display=swap');
        :root {
            --naranja-tostado: #E8772E; --naranja-oscuro: #C0581B; --crema-palido: #FDF6E3;
            --carbon-suave: #4F4A45; --gris-piedra: #D4C5A3; --blanco-hueso: #FEFBF3;
            --verde-listo: #28a745; --rojo-error: #dc3545; --azul-info: #17a2b8;
            --fuente-titulos: 'DM Sans', sans-serif; --fuente-cuerpo: 'Inter', sans-serif;
        }
        
        body { font-family: var(--fuente-cuerpo); background-color: var(--crema-palido); color: var(--carbon-suave); margin: 0; padding: 1rem; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background-color: var(--blanco-hueso); border: 1px solid var(--gris-piedra); border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-top: 1rem; }
        .btn { background-color: var(--naranja-tostado); color: white; padding: 10px 20px; border: none; border-radius: 5px; font-family: var(--fuente-titulos); font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn:hover { opacity: 0.85; }
        .btn:active { background-color: var(--naranja-oscuro); transform: translateY(1px); }
        .btn:disabled {
            background-color: var(--gris-piedra);
            opacity: 0.7;
            cursor: wait;
            transform: none;
        }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; }
        .dashboard-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 2rem; margin-top: 2rem; }
        .ordenes-columna h2 { border-bottom: 2px solid var(--gris-piedra); padding-bottom: 0.5rem; }
        .orden-card { border: 1px solid var(--gris-piedra); border-radius: 8px; margin-bottom: 1.5rem; background: #fff; }
        .orden-header { background-color: var(--carbon-suave); color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .orden-body { padding: 1rem; }
        .lista-productos { list-style: none; padding: 0; margin: 0; }
        .producto-item { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #eee; gap: 1rem; }
        .producto-item:last-child { border-bottom: none; }
        .producto-info strong { font-size: 1.1em; }
        .producto-info .obs { font-size: 0.9em; color: var(--naranja-tostado); font-style: italic; font-weight: 600; margin-top: 5px; }
        .producto-item.listo .producto-info { text-decoration: line-through; color: #888; }
        .orden-card.lista { border-left: 4px solid #28a745; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15); }
        .orden-card.lista .orden-header { background: linear-gradient(135deg, #28a745, #20c997); }
        .controles-producto { display: flex; gap: 5px; align-items: center; }
        .btn-confirmar-producto { background-color: var(--azul-info); font-size: 12px; padding: 8px 12px; }
        .btn-decremento { font-size: 12px; padding: 8px 12px; }

        /* === TOAST Y MODAL === */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--carbon-suave); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: var(--fuente-cuerpo); font-size: 15px; opacity: 0; animation: toast-fade-in 0.5s forwards; display: flex; align-items: center; gap: 10px; }
        .toast.hiding { animation: toast-fade-out 0.5s forwards; }
        .toast.toast-success { background-color: var(--verde-listo); }
        .toast.toast-error { background-color: var(--rojo-error); }
        .toast.toast-info { background-color: var(--azul-info); }
        @keyframes toast-fade-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toast-fade-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        
        #confirm-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1040; display: none; justify-content: center; align-items: center; animation: fade-in 0.3s; }
        #confirm-modal { background-color: var(--blanco-hueso); padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center; transform: scale(0.9); animation: slide-up 0.3s forwards; }
        #confirm-message { font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.5; }
        #confirm-buttons { display: flex; justify-content: center; gap: 1rem; }
        .confirm-btn { background-color: #ccc; color: var(--carbon-suave); padding: 10px 20px; }
        .confirm-btn.ok { background-color: var(--naranja-tostado); color: white; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    
    <div id="confirm-overlay">
        <div id="confirm-modal">
            <p id="confirm-message"></p>
            <div id="confirm-buttons">
                <button id="confirm-btn-cancel" class="btn confirm-btn">Cancelar</button>
                <button id="confirm-btn-ok" class="btn confirm-btn ok">Aceptar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="dashboard-header">
                <div>
                    <h1>Panel de Cocina</h1>
                    <p style="margin: 0;">Operador: <strong>{{ user.nombre }}</strong></p>
                </div>
                <a href="{% url 'logout' %}" class="btn">Cerrar Sesión</a>
            </div>
        </div>

        <div class="dashboard-grid">
            <div id="ordenes-pendientes" class="ordenes-columna">
                <h2>Órdenes Pendientes</h2>
            </div>
            <div id="ordenes-listas" class="ordenes-columna">
                <h2>Listas para Servir</h2>
            </div>
        </div>
    </div>

    <template id="order-card-template">
        <div class="orden-card">
            <div class="orden-header">
                <div>
                    <span class="mesa">Mesa #</span>
                    <div class="mesero-info">Mesero: <span class="mesero-nombre"></span></div>
                </div>
                <div>
                    <span class="productos-count" style="font-weight: 600;">0/0 Listos</span>
                    <span class="hora" style="display: block; font-size: 12px; text-align: right;"></span>
                </div>
            </div>
            <div class="orden-body">
                <ul class="lista-productos"></ul>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const csrfToken = '{{ csrf_token }}';
            const pendientesContainer = document.getElementById('ordenes-pendientes');
            const listasContainer = document.getElementById('ordenes-listas');
            const orderTemplate = document.getElementById('order-card-template');
            const buttonsOnCooldown = new Set(); 

            // === SISTEMA DE NOTIFICACIONES Y MODAL ===
            const toastContainer = document.getElementById('toast-container');
            const confirmOverlay = document.getElementById('confirm-overlay');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmBtnOk = document.getElementById('confirm-btn-ok');
            const confirmBtnCancel = document.getElementById('confirm-btn-cancel');
            let confirmResolve = null;

            window.showToast = function(message, type = 'info', duration = 4000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `<span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('hiding');
                    toast.addEventListener('animationend', () => toast.remove());
                }, duration);
            };

            window.showConfirm = function(message) {
                return new Promise((resolve) => {
                    confirmResolve = resolve;
                    confirmMessage.innerHTML = message;
                    confirmOverlay.style.display = 'flex';
                });
            };

            confirmBtnOk.addEventListener('click', () => { if (confirmResolve) confirmResolve(true); confirmOverlay.style.display = 'none'; });
            confirmBtnCancel.addEventListener('click', () => { if (confirmResolve) confirmResolve(false); confirmOverlay.style.display = 'none'; });
            window.alert = (message) => window.showToast(message, 'info');
            window.confirm = (message) => window.showConfirm(message);

            // === LÓGICA DE LA APLICACIÓN ===

            function renderizarOrdenes(ordenes) {
                pendientesContainer.innerHTML = '<h2>Órdenes Pendientes</h2>';
                listasContainer.innerHTML = '<h2>Listas para Servir</h2>';

                if (!ordenes || ordenes.length === 0) {
                    pendientesContainer.innerHTML += '<p>No hay órdenes pendientes.</p>';
                    listasContainer.innerHTML += '<p>No hay órdenes listas.</p>';
                    return;
                }

                let hayPendientes = false, hayListas = false;

                ordenes.forEach(orden => {
                    const card = document.importNode(orderTemplate.content, true);
                    const ordenCard = card.querySelector('.orden-card');
                    ordenCard.dataset.ordenId = orden.id;
                    
                    card.querySelector('.mesa').textContent = `Mesa #${orden.mesa}`;
                    card.querySelector('.mesero-nombre').textContent = orden.mesero;
                    card.querySelector('.hora').textContent = orden.creado_en;

                    const listaProductosEl = card.querySelector('.lista-productos');
                    let productosListosCount = 0;
                    const totalProductos = orden.productos.length;

                    orden.productos.forEach(p => {
                        if (p.estado === 'LISTO') productosListosCount++;

                        const li = document.createElement('li');
                        li.className = 'producto-item';
                        if (p.estado === 'LISTO') li.classList.add('listo');

                        const observacionesHTML = p.observaciones ? `<div class="obs">📝 ${p.observaciones}</div>` : '';
                        
                        let controlesHTML = '';
                        if (orden.completada || p.estado === 'LISTO') {
                            controlesHTML = `<div class="controles-producto"><span style="color: var(--verde-listo); font-weight: 600;">✅ Listo</span></div>`;
                        } else {
                            const confirmarId = `c-${p.id}`;
                            const enCooldownC = buttonsOnCooldown.has(confirmarId);
                            
                            // ✅ CAMBIO CLAVE: Lógica condicional para los botones
                            if (p.cantidad === 1) {
                                // Si solo queda 1, mostrar solo "Confirmar"
                                controlesHTML = `
                                    <div class="controles-producto">
                                        <button class="btn btn-confirmar-producto" data-producto-orden-id="${p.id}" data-cooldown-id="${confirmarId}" ${enCooldownC ? 'disabled' : ''}>Confirmar</button>
                                    </div>`;
                            } else {
                                // Si hay más de 1, mostrar ambos botones
                                const decrementoId = `d-${p.id}`;
                                const enCooldownD = buttonsOnCooldown.has(decrementoId);
                                controlesHTML = `
                                    <div class="controles-producto">
                                        <button class="btn btn-confirmar-producto" data-producto-orden-id="${p.id}" data-cooldown-id="${confirmarId}" ${enCooldownC ? 'disabled' : ''}>Confirmar</button>
                                        <button class="btn btn-decremento" data-producto-orden-id="${p.id}" data-cooldown-id="${decrementoId}" ${enCooldownD ? 'disabled' : ''}>Entregar 1</button>
                                    </div>`;
                            }
                        }

                        li.innerHTML = `
                            <div class="producto-info">
                                <strong>${p.cantidad}x ${p.nombre}</strong>
                                ${observacionesHTML}
                            </div>
                            ${controlesHTML}`;
                        listaProductosEl.appendChild(li);
                    });
                    
                    card.querySelector('.productos-count').textContent = `${productosListosCount} / ${totalProductos} Listos`;

                    if (orden.completada) {
                        ordenCard.classList.add('lista');
                        const ordenBody = card.querySelector('.orden-body');
                        const botonServido = document.createElement('div');
                        botonServido.style.textAlign = 'center';
                        botonServido.style.marginTop = '15px';
                        const servidoId = `s-${orden.id}`;
                        const enCooldown = buttonsOnCooldown.has(servidoId);
                        botonServido.innerHTML = `<button class="btn btn-servido" data-orden-id="${orden.id}" data-cooldown-id="${servidoId}" ${enCooldown ? 'disabled' : ''}>🍽️ Marcar como Servido</button>`;
                        ordenBody.appendChild(botonServido);
                        listasContainer.appendChild(card);
                        hayListas = true;
                    } else {
                        pendientesContainer.appendChild(card);
                        hayPendientes = true;
                    }
                });

                if (!hayPendientes) pendientesContainer.innerHTML += '<p style="color: #888; text-align: center; padding: 2rem;">No hay órdenes pendientes.</p>';
                if (!hayListas) listasContainer.innerHTML += '<p style="color: #888; text-align: center; padding: 2rem;">No hay órdenes listas para servir.</p>';
            }

            async function fetchOrdenes() {
                try {
                    const response = await fetch("{% url 'api_get_ordenes_cocina' %}");
                    if (!response.ok) throw new Error('No se pudo conectar al servidor');
                    const data = await response.json();
                    renderizarOrdenes(data);
                } catch (error) {
                    console.error("Error al obtener órdenes:", error);
                    showToast('Error al cargar las órdenes.', 'error');
                }
            }

            async function manejarAccionProducto(url, successMessage, errorMessage) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
                    const result = await response.json();
                    if (result.success) {
                        showToast(result.mensaje || successMessage, 'success');
                    } else {
                        showToast(result.error || errorMessage, 'error');
                    }
                } catch (error) {
                    console.error("Error en la acción:", error);
                    showToast('Error de conexión.', 'error');
                } finally {
                    fetchOrdenes();
                }
            }

            document.body.addEventListener('click', async (e) => {
                const target = e.target;
                const cooldownId = target.dataset.cooldownId;

                if (cooldownId && buttonsOnCooldown.has(cooldownId)) {
                    e.preventDefault();
                    return;
                }

                const productoItem = target.closest('.producto-item');
                const productoName = productoItem ? productoItem.querySelector('strong').textContent : '';

                if (target.classList.contains('btn-decremento')) {
                    const confirmed = await showConfirm(`¿Confirmas que YA ENTREGASTE 1 unidad de "<b>${productoName}</b>" al mesero?`);
                    if (confirmed) {
                        buttonsOnCooldown.add(cooldownId);
                        target.disabled = true;
                        const productoOrdenId = target.dataset.productoOrdenId;
                        await manejarAccionProducto(`/api/cocina/producto/${productoOrdenId}/decrementar/`, 'Producto entregado.', 'No se pudo entregar.');
                        setTimeout(() => buttonsOnCooldown.delete(cooldownId), 3000);
                    }
                }
                else if (target.classList.contains('btn-confirmar-producto')) {
                    const confirmed = await showConfirm(`¿Marcar "<b>${productoName}</b>" como completado y listo para servir?`);
                    if (confirmed) {
                        buttonsOnCooldown.add(cooldownId);
                        target.disabled = true;
                        const productoOrdenId = target.dataset.productoOrdenId;
                        await manejarAccionProducto(`/api/cocina/producto/${productoOrdenId}/listo/`, 'Producto confirmado.', 'No se pudo confirmar.');
                        setTimeout(() => buttonsOnCooldown.delete(cooldownId), 3000);
                    }
                }
                
                else if (target.classList.contains('btn-servido')) {
                    const confirmed = await showConfirm('¿Confirmas que la orden completa fue servida? Esta acción no se puede deshacer.');
                     if (confirmed) {
                        buttonsOnCooldown.add(cooldownId);
                        target.disabled = true;
                        const ordenId = target.dataset.ordenId;
                        await manejarAccionProducto(`/api/cocina/orden/${ordenId}/servida/`, '¡Orden servida!', 'No se pudo marcar como servida.');
                        setTimeout(() => buttonsOnCooldown.delete(cooldownId), 3000);
                     }
                }
            });

            fetchOrdenes();
            setInterval(fetchOrdenes, 5000);
        });
    </script>
</body>
</html>