<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Cocina Completo - Caprichos Criollos</title>
    
<!-- FASE 1: CSS CORREGIDO -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Inter:wght@400;600&display=swap');
    :root {
        --naranja-tostado: #E8772E; 
        --naranja-oscuro: #C0581B; 
        --crema-palido: #FDF6E3;
        --carbon-suave: #4F4A45; 
        --gris-piedra: #D4C5A3; 
        --blanco-hueso: #FEFBF3;
        --verde-listo: #28a745; 
        --rojo-error: #dc3545; 
        --azul-info: #17a2b8;
        --morado-reserva: #6f42c1; 
        --turquesa-domicilio: #20c997; 
        --amarillo-especial: #ffc107;
        --fuente-titulos: 'DM Sans', sans-serif; 
        --fuente-cuerpo: 'Inter', sans-serif;
    }
    
    body { 
        font-family: var(--fuente-cuerpo); 
        background-color: var(--crema-palido); 
        color: var(--carbon-suave); 
        margin: 0; 
        padding: 1rem; 
    }
    
    .container { 
        max-width: 1600px; 
        margin: 0 auto; 
    }
    
    .card { 
        background-color: var(--blanco-hueso); 
        border: 1px solid var(--gris-piedra); 
        border-radius: 8px; 
        padding: 1.5rem; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
        margin-top: 1rem; 
    }
    
    .btn { 
        background-color: var(--naranja-tostado); 
        color: white; 
        padding: 10px 20px; 
        border: none; 
        border-radius: 5px; 
        font-family: var(--fuente-titulos); 
        font-size: 14px; 
        font-weight: 700; 
        cursor: pointer; 
        transition: all 0.2s; 
    }
    
    .btn:hover { opacity: 0.85; }
    .btn:active { background-color: var(--naranja-oscuro); transform: translateY(1px); }
    .btn:disabled { background-color: var(--gris-piedra); opacity: 0.7; cursor: wait; transform: none; }
    
    .dashboard-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }

    /* === CONTROLES SUPERIORES === */
    .controles-superiores {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
        flex-wrap: wrap;
        background: var(--blanco-hueso);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--gris-piedra);
    }

    .filtros-cocina {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .filtro-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gris-piedra);
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85em;
        white-space: nowrap;
    }

    .filtro-btn:hover { border-color: var(--naranja-tostado); }
    .filtro-btn.active { 
        background-color: var(--naranja-tostado); 
        color: white; 
        border-color: var(--naranja-tostado); 
    }

    .btn-especiales {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
    }

    .btn-domicilios {
        background: var(--turquesa-domicilio);
        color: white;
        position: relative;
    }

    .btn-reservas {
        background: var(--morado-reserva);
        color: white;
        position: relative;
    }

    .contador-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    /* === GRID PRINCIPAL === */
    .dashboard-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); 
        gap: 2rem; 
        margin-top: 2rem; 
    }

    .ordenes-columna h2 { 
        border-bottom: 2px solid var(--gris-piedra); 
        padding-bottom: 0.5rem; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 1rem;
    }

    .contador-columna { 
        background: var(--naranja-tostado); 
        color: white; 
        padding: 0.25rem 0.75rem; 
        border-radius: 15px; 
        font-size: 0.9em; 
    }

    /* === ORDEN CARDS === */
    .orden-card { 
        border: 1px solid var(--gris-piedra); 
        border-radius: 8px; 
        margin-bottom: 1.5rem; 
        background: #fff; 
        transition: all 0.3s ease; 
    }

    .orden-card:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    }

    /* 🔧 CORRECCIÓN: Estados de orden mejorados */
    .orden-card.mesa-normal { border-left: 4px solid var(--azul-info); }

    .orden-card.domicilio { 
        border-left: 4px solid var(--turquesa-domicilio); 
        background: linear-gradient(90deg, rgba(32, 201, 151, 0.05) 0%, #fff 10%); 
    }

    .orden-card.reserva { 
        border-left: 4px solid var(--morado-reserva); 
        background: linear-gradient(90deg, rgba(111, 66, 193, 0.05) 0%, #fff 10%); 
    }

    /* 🔧 CORRECCIÓN CLAVE: Orden lista debe tener prioridad visual */
    .orden-card.lista { 
        border-left: 4px solid #28a745 !important;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15) !important;
        background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, #fff 10%) !important;
    }

    /* 🔧 NUEVO: Estado especial para reservas activas */
    .orden-card.reserva-activa {
        border-left: 4px solid var(--morado-reserva);
        background: linear-gradient(90deg, rgba(111, 66, 193, 0.1) 0%, #fff 15%);
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.1);
    }

    .orden-header { 
        background-color: var(--carbon-suave); 
        color: white; 
        padding: 1rem; 
        border-radius: 8px 8px 0 0; 
        display: flex; 
        justify-content: space-between; 
        align-items: flex-start;
        gap: 1rem;
    }

    /* 🔧 CORRECCIÓN: Headers con prioridad correcta */
    .orden-card.lista .orden-header { 
        background: linear-gradient(135deg, #28a745, #20c997) !important;
    }

    .orden-card.domicilio .orden-header { 
        background: linear-gradient(135deg, var(--turquesa-domicilio), #17a2b8); 
    }

    .orden-card.reserva .orden-header,
    .orden-card.reserva-activa .orden-header { 
        background: linear-gradient(135deg, var(--morado-reserva), #5a32a3); 
    }

    .orden-info-principal { flex: 1; }
    .orden-meta { text-align: right; font-size: 0.85em; min-width: 100px; }

    .mesa-numero { 
        font-size: 1.3em; 
        font-weight: 700; 
        margin-bottom: 0.25rem; 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
    }

    .tipo-orden-badge { 
        font-size: 0.7em; 
        padding: 0.2rem 0.5rem; 
        border-radius: 10px; 
        background: rgba(255,255,255,0.2); 
    }

    .numero-orden { font-size: 0.9em; opacity: 0.9; margin-bottom: 0.25rem; }
    .mesero-info { font-size: 0.85em; opacity: 0.8; }

    /* === OBSERVACIONES MEJORADAS === */
    .observacion-general { 
        font-size: 0.8em; 
        opacity: 0.9; 
        margin-top: 0.5rem; 
        padding: 0.5rem; 
        background: rgba(255,255,255,0.15); 
        border-radius: 4px;
        border-left: 3px solid rgba(255,255,255,0.3);
        max-width: 250px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        line-height: 1.3;
    }

    .observacion-general.mesa-normal {
        border-left-color: var(--azul-info);
    }

    .observacion-general.domicilio {
        border-left-color: var(--turquesa-domicilio);
    }

    .observacion-general.reserva {
        border-left-color: var(--morado-reserva);
    }

    .tiempo-transcurrido { font-weight: 600; margin-bottom: 0.25rem; }
    .productos-count { font-size: 0.9em; }

    /* === PRODUCTOS === */
    .orden-body { padding: 1rem; }
    .lista-productos { list-style: none; padding: 0; margin: 0; }

    .producto-item { 
        display: grid; 
        grid-template-columns: 1fr auto; 
        align-items: center; 
        padding: 0.75rem 0; 
        border-bottom: 1px solid #eee; 
        gap: 1rem; 
    }

    .producto-item:last-child { border-bottom: none; }
    .producto-info strong { font-size: 1.1em; }

    .producto-info .obs { 
        font-size: 0.9em; 
        color: var(--naranja-tostado); 
        font-style: italic; 
        font-weight: 600; 
        margin-top: 5px; 
    }

    .producto-item.listo .producto-info { 
        text-decoration: line-through; 
        color: #888; 
    }

    .producto-item.agregado-despues { 
        background: rgba(255, 193, 7, 0.1); 
        padding: 0.75rem; 
        border-radius: 4px; 
        margin: 0.25rem 0;
        border-left: 3px solid var(--amarillo-especial);
    }

    .controles-producto { display: flex; gap: 5px; align-items: center; }
    .btn-confirmar-producto { background-color: var(--azul-info); font-size: 12px; padding: 8px 12px; }
    .btn-decremento { font-size: 12px; padding: 8px 12px; }

    /* 🔧 CORRECCIÓN: Botones de acción de orden mejorados */
    .orden-acciones {
        text-align: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #eee;
    }

    .btn-servido {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 700;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }

    .btn-servido:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-servido:disabled {
        background: var(--gris-piedra);
        transform: none;
        box-shadow: none;
        cursor: wait;
    }

    /* === TOAST Y MODAL === */
    #toast-container { 
        position: fixed; 
        top: 20px; 
        right: 20px; 
        z-index: 1070;
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
    }

    .toast { 
        background-color: var(--carbon-suave); 
        color: white; 
        padding: 15px 20px; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        font-family: var(--fuente-cuerpo); 
        font-size: 15px; 
        opacity: 0; 
        animation: toast-fade-in 0.5s forwards; 
        display: flex; 
        align-items: center; 
        gap: 10px; 
    }

    .toast.hiding { animation: toast-fade-out 0.5s forwards; }
    .toast.toast-success { background-color: var(--verde-listo); }
    .toast.toast-error { background-color: var(--rojo-error); }
    .toast.toast-info { background-color: var(--azul-info); }

    @keyframes toast-fade-in { 
        from { opacity: 0; transform: translateX(100%); } 
        to { opacity: 1; transform: translateX(0); } 
    }

    @keyframes toast-fade-out { 
        from { opacity: 1; transform: translateX(0); } 
        to { opacity: 0; transform: translateX(100%); } 
    }

    #confirm-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.5); 
        z-index: 1060;
        display: none; 
        justify-content: center; 
        align-items: center; 
        animation: fade-in 0.3s; 
    }

    #confirm-modal { 
        background-color: var(--blanco-hueso); 
        padding: 2rem; 
        border-radius: 8px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        width: 90%; 
        max-width: 450px; 
        text-align: center; 
        transform: scale(0.9); 
        animation: slide-up 0.3s forwards;
        z-index: 1061;
    }

    #confirm-message { font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.5; }
    #confirm-buttons { display: flex; justify-content: center; gap: 1rem; }
    .confirm-btn { background-color: #ccc; color: var(--carbon-suave); padding: 10px 20px; }
    .confirm-btn.ok { background-color: var(--naranja-tostado); color: white; }

    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slide-up { 
        from { opacity: 0; transform: translateY(20px) scale(0.95); } 
        to { opacity: 1; transform: translateY(0) scale(1); } 
    }

    /* === MODAL ESPECIALES === */
    .modal-especiales {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1050;
        display: none;
        justify-content: center;
        align-items: center;
    }

    .modal-content-especiales {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-header-especiales {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gris-piedra);
    }

    .btn-cerrar-modal {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
    }

    .ordenes-especiales-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .loading { 
        text-align: center; 
        padding: 2rem; 
        color: #666; 
    }

    .loading::after {
        content: '';
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--gris-piedra);
        border-radius: 50%;
        border-top: 2px solid var(--naranja-tostado);
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }

    @keyframes spin { 
        0% { transform: rotate(0deg); } 
        100% { transform: rotate(360deg); } 
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) { 
        .dashboard-grid { grid-template-columns: 1fr; }
        .controles-superiores { flex-direction: column; align-items: stretch; }
        .btn-especiales { margin-left: 0; justify-content: center; }
        
        .observacion-general {
            max-width: 100%;
        }
    }
</style>
</head>
<body>
    <div id="toast-container"></div>
    
    <div id="confirm-overlay">
        <div id="confirm-modal">
            <p id="confirm-message"></p>
            <div id="confirm-buttons">
                <button id="confirm-btn-cancel" class="btn confirm-btn">Cancelar</button>
                <button id="confirm-btn-ok" class="btn confirm-btn ok">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal para órdenes especiales -->
    <div id="modal-domicilios" class="modal-especiales">
        <div class="modal-content-especiales">
            <div class="modal-header-especiales">
                <h3>🏠 Vista Detallada: Solo Domicilios</h3>
                <button class="btn-cerrar-modal" onclick="cerrarModalEspeciales('domicilios')">✕ Cerrar</button>
            </div>
            <p style="margin-bottom: 1rem; color: #666; font-style: italic;">
                Vista enfocada solo en órdenes de domicilio. También aparecen en la vista principal junto con las demás órdenes.
            </p>
            <div id="contenido-domicilios" class="ordenes-especiales-grid">
                <div class="loading">Cargando domicilios...</div>
            </div>
        </div>
    </div>

    <div id="modal-reservas" class="modal-especiales">
        <div class="modal-content-especiales">
            <div class="modal-header-especiales">
                <h3>📅 Reservas Futuras</h3>
                <button class="btn-cerrar-modal" onclick="cerrarModalEspeciales('reservas')">✕ Cerrar</button>
            </div>
            <p style="margin-bottom: 1rem; color: #666; font-style: italic;">
                <strong>🕐 Reservas programadas:</strong> Estas órdenes NO aparecen en pendientes normales. 
                Se preparan según la fecha y hora programada de la reserva.
            </p>
            <div id="contenido-reservas" class="ordenes-especiales-grid">
                <div class="loading">Cargando reservas...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="dashboard-header">
                <div>
                    <h1>Panel de Cocina Completo</h1>
                    <p style="margin: 0;">Operador: <strong>{{ user.nombre }}</strong></p>
                </div>
                <a href="{% url 'logout' %}" class="btn">Cerrar Sesión</a>
            </div>
        </div>

        <!-- Controles superiores -->
        <div class="controles-superiores">
            <div>
                <strong>Filtros:</strong>
                <div class="filtros-cocina">
                    <button class="filtro-btn active" data-filtro="todas">📋 Mesas + Domicilios</button>
                    <button class="filtro-btn" data-filtro="mesas">🪑 Solo Mesas</button>
                    <button class="filtro-btn" data-filtro="urgentes">⚡ Urgentes (+30min)</button>
                    <button class="filtro-btn" data-filtro="listas">✅ Listas</button>
                </div>
            </div>

            <div class="btn-especiales">
                <button class="btn btn-domicilios" onclick="abrirModalEspeciales('domicilios')" title="Ver solo domicilios en modal">
                    🏠 Ver Domicilios
                    <span class="contador-badge" id="contador-domicilios">0</span>
                </button>
                <button class="btn btn-reservas" onclick="abrirModalEspeciales('reservas')" title="Reservas futuras - no van a cocina inmediatamente">
                    📅 Reservas Futuras
                    <span class="contador-badge" id="contador-reservas">0</span>
                </button>
                <button class="btn" onclick="actualizarOrdenes()">🔄 Actualizar</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div id="ordenes-pendientes" class="ordenes-columna">
                <h2>
                    🍳 Órdenes Pendientes
                    <span class="contador-columna" id="contador-pendientes">0</span>
                </h2>
                <div class="loading">Cargando órdenes...</div>
            </div>
            <div id="ordenes-listas" class="ordenes-columna">
                <h2>
                    🍽️ Listas para Servir
                    <span class="contador-columna" id="contador-listas">0</span>
                </h2>
                <div class="loading">Cargando órdenes...</div>
            </div>
        </div>
    </div>

    <template id="order-card-template">
        <div class="orden-card">
            <div class="orden-header">
                <div class="orden-info-principal">
                    <div class="mesa-numero">
                        <span class="mesa-texto"></span>
                        <span class="tipo-orden-badge"></span>
                    </div>
                    <div class="numero-orden"></div>
                    <div class="mesero-info"></div>
                    <div class="observacion-general" style="display: none;"></div>
                </div>
                <div class="orden-meta">
                    <div class="tiempo-transcurrido"></div>
                    <div class="productos-count"></div>
                </div>
            </div>
            <div class="orden-body">
                <ul class="lista-productos"></ul>
                <div class="orden-acciones" style="display: none; text-align: center; margin-top: 15px;">
                    <button class="btn btn-servido">🍽️ Marcar como Servido</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard de cocina iniciando...');
            
            // Variables globales
            const csrfToken = '{{ csrf_token }}';
            const buttonsOnCooldown = new Set();
            let ordenes = [];
            let filtroActual = 'todas';
            let currentHash = null;
            
            // === SISTEMA DE NOTIFICACIONES ===
            const toastContainer = document.getElementById('toast-container');
            const confirmOverlay = document.getElementById('confirm-overlay');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmBtnOk = document.getElementById('confirm-btn-ok');
            const confirmBtnCancel = document.getElementById('confirm-btn-cancel');
            let confirmResolve = null;

            window.showToast = function(message, type = 'info', duration = 4000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `<span>${message}</span>`;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('hiding');
                    toast.addEventListener('animationend', () => toast.remove());
                }, duration);
            };

            window.showConfirm = function(message) {
                return new Promise((resolve) => {
                    confirmResolve = resolve;
                    confirmMessage.innerHTML = message;
                    confirmOverlay.style.display = 'flex';
                });
            };

            confirmBtnOk.addEventListener('click', () => { 
                if (confirmResolve) confirmResolve(true); 
                confirmOverlay.style.display = 'none'; 
            });
            
            confirmBtnCancel.addEventListener('click', () => { 
                if (confirmResolve) confirmResolve(false); 
                confirmOverlay.style.display = 'none'; 
            });

            // === FUNCIONES DE UTILIDAD CORREGIDAS ===
            function calcularTiempoTranscurrido(fechaCreacion) {
                try {
                    const ahora = new Date();
                    
                    // 🔧 CORRECCIÓN: Manejar diferentes formatos de fecha
                    let fecha;
                    
                    if (typeof fechaCreacion === 'string') {
                        // Si viene como string ISO
                        fecha = new Date(fechaCreacion);
                    } else if (fechaCreacion instanceof Date) {
                        fecha = fechaCreacion;
                    } else {
                        fecha = new Date(fechaCreacion);
                    }
                    
                    // Verificar que la fecha sea válida
                    if (isNaN(fecha.getTime())) {
                        console.error('⚠️ Fecha inválida:', fechaCreacion);
                        return '0min';
                    }
                    
                    const diffMs = ahora - fecha;
                    
                    // Verificar que la diferencia sea positiva
                    if (diffMs < 0) {
                        console.warn('⚠️ Fecha en el futuro:', fechaCreacion);
                        return '0min';
                    }
                    
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (diffMins < 60) {
                        return `${diffMins}min`;
                    } else {
                        const horas = Math.floor(diffMins / 60);
                        const mins = diffMins % 60;
                        return `${horas}h ${mins}m`;
                    }
                    
                } catch (error) {
                    console.error('❌ Error calculando tiempo transcurrido:', error, 'Fecha:', fechaCreacion);
                    return '0min';
                }
            }

            function determinarTipoOrden(orden) {
                if (orden.mesa === 0) return 'domicilio';
                if (orden.mesa === 50) return 'reserva';
                return 'mesa-normal';
            }

            // 🔧 FUNCIÓN CORREGIDA para extraer información completa
            function extraerInformacionCompleta(observaciones, tipoOrden) {
                if (!observaciones || !observaciones.trim()) return '';
                
                const obs = observaciones.trim();
                
                if (tipoOrden === 'domicilio') {
                    // Para domicilios, extraer nombre del cliente si tiene formato específico
                    const clienteMatch = obs.match(/Cliente:\s*([^,\n]+)/i);
                    const telefonoMatch = obs.match(/Tel(?:éfono)?:\s*([^,\n]+)/i);
                    
                    if (clienteMatch) {
                        const nombre = clienteMatch[1].trim();
                        const telefono = telefonoMatch ? ` - ${telefonoMatch[1].trim()}` : '';
                        return `🏠 ${nombre}${telefono}`;
                    } else {
                        // Si no tiene formato específico, mostrar las primeras palabras
                        const palabras = obs.split(/[,\n]/).filter(p => p.trim());
                        return palabras[0] ? `🏠 ${palabras[0].trim()}` : obs.substring(0, 40) + '...';
                    }
                    
                } else if (tipoOrden === 'reserva') {
                    // Para reservas, extraer información de la reserva
                    const reservaMatch = obs.match(/(?:Reserva|Cliente):\s*([^,\n]+)/i);
                    const personasMatch = obs.match(/Personas?:\s*(\d+)/i);
                    
                    if (reservaMatch) {
                        const nombre = reservaMatch[1].trim();
                        const personas = personasMatch ? ` (${personasMatch[1]} pers.)` : '';
                        return `📅 ${nombre}${personas}`;
                    } else {
                        // Si no tiene formato específico, mostrar las primeras palabras
                        const palabras = obs.split(/[,\n]/).filter(p => p.trim());
                        return palabras[0] ? `📅 ${palabras[0].trim()}` : obs.substring(0, 40) + '...';
                    }
                    
                } else {
                    // Para mesas normales, mostrar la observación completa (truncada si es muy larga)
                    return obs.length > 50 ? obs.substring(0, 50) + '...' : obs;
                }
            }

            function esUrgente(tiempoTranscurrido) {
                return tiempoTranscurrido.includes('h') || 
                       (tiempoTranscurrido.includes('min') && parseInt(tiempoTranscurrido) > 30);
            }

            // === RENDERIZADO DE ÓRDENES CORREGIDO ===
            function renderizarOrdenes(ordenesData) {
                const pendientesContainer = document.getElementById('ordenes-pendientes');
                const listasContainer = document.getElementById('ordenes-listas');
                const template = document.getElementById('order-card-template');

                // Limpiar contenedores
                pendientesContainer.innerHTML = '<h2>🍳 Órdenes Pendientes <span class="contador-columna" id="contador-pendientes">0</span></h2>';
                listasContainer.innerHTML = '<h2>🍽️ Listas para Servir <span class="contador-columna" id="contador-listas">0</span></h2>';

                if (!ordenesData || ordenesData.length === 0) {
                    pendientesContainer.innerHTML += '<p style="text-align: center; color: #888; padding: 2rem;">No hay órdenes pendientes.</p>';
                    listasContainer.innerHTML += '<p style="text-align: center; color: #888; padding: 2rem;">No hay órdenes listas.</p>';
                    actualizarContadoresEspeciales([]);
                    return;
                }

                // 🔧 CORRECCIÓN PRINCIPAL: Filtrar órdenes excluyendo reservas por defecto
                let ordenesFiltradas = ordenesData.filter(orden => {
                    // PRIMERO: Excluir reservas (mesa 50) de las órdenes normales de cocina
                    // Las reservas solo se ven en el modal especial
                    if (orden.mesa === 50 && filtroActual !== 'reservas') {
                        return false;
                    }
                    
                    // SEGUNDO: Aplicar filtros adicionales
                    if (filtroActual === 'todas') {
                        // "Todas" = solo mesas normales (1-49) + domicilios (0), NO reservas (50)
                        return orden.mesa !== 50;
                    }
                    if (filtroActual === 'mesas') {
                        // Solo mesas físicas (1-49), NO domicilios ni reservas
                        return orden.mesa && orden.mesa !== 0 && orden.mesa !== 50;
                    }
                    if (filtroActual === 'urgentes') {
                        const tiempo = calcularTiempoTranscurrido(orden.creado_en);
                        return esUrgente(tiempo) && orden.mesa !== 50;
                    }
                    if (filtroActual === 'listas') {
                        return orden.completada && orden.mesa !== 50;
                    }
                    return true;
                });

                console.log(`📊 Órdenes filtradas: ${ordenesFiltradas.length} de ${ordenesData.length} (filtro: ${filtroActual})`);

                let contadorPendientes = 0, contadorListas = 0;

                ordenesFiltradas.forEach(orden => {
                    const card = crearTarjetaOrden(orden, template);
                    
                    if (orden.completada) {
                        listasContainer.appendChild(card);
                        contadorListas++;
                    } else {
                        pendientesContainer.appendChild(card);
                        contadorPendientes++;
                    }
                });

                if (contadorPendientes === 0) {
                    pendientesContainer.innerHTML += '<p style="text-align: center; color: #888; padding: 2rem;">No hay órdenes pendientes.</p>';
                }
                if (contadorListas === 0) {
                    listasContainer.innerHTML += '<p style="text-align: center; color: #888; padding: 2rem;">No hay órdenes listas.</p>';
                }

                // Actualizar contadores
                document.getElementById('contador-pendientes').textContent = contadorPendientes;
                document.getElementById('contador-listas').textContent = contadorListas;

                // Actualizar contadores de especiales
                actualizarContadoresEspeciales(ordenesData);
            }

            function crearTarjetaOrden(orden, template) {
                const clone = document.importNode(template.content, true);
                const card = clone.querySelector('.orden-card');
                
                // 🔧 CORRECCIÓN: Determinar tipo correctamente
                const tipoOrden = determinarTipoOrden(orden);
                card.classList.add(tipoOrden);
                if (orden.completada) card.classList.add('lista');

                // 🔧 CORRECCIÓN: Textos mejorados según el tipo
                let mesaTexto = '';
                if (tipoOrden === 'domicilio') {
                    mesaTexto = '🏠 Domicilio';
                } else if (tipoOrden === 'reserva') {
                    mesaTexto = '📅 Reserva';
                } else {
                    mesaTexto = `Mesa #${orden.mesa}`;
                }
                
                card.querySelector('.mesa-texto').textContent = mesaTexto;
                
                // Badge de tipo
                const tipoBadge = card.querySelector('.tipo-orden-badge');
                if (tipoOrden === 'domicilio') {
                    tipoBadge.textContent = 'DOM';
                    tipoBadge.style.background = 'rgba(32, 201, 151, 0.8)';
                } else if (tipoOrden === 'reserva') {
                    tipoBadge.textContent = 'RES';
                    tipoBadge.style.background = 'rgba(111, 66, 193, 0.8)';
                } else {
                    tipoBadge.style.display = 'none';
                }

                // Información de la orden
                card.querySelector('.numero-orden').textContent = `Orden #${orden.id}`;
                card.querySelector('.mesero-info').textContent = `Mesero: ${orden.mesero}`;
                
                // 🔧 CORRECCIÓN: Tiempo transcurrido
                const tiempoTranscurrido = calcularTiempoTranscurrido(orden.creado_en);
                card.querySelector('.tiempo-transcurrido').textContent = tiempoTranscurrido;

                // 🔧 CORRECCIÓN PRINCIPAL: Mostrar observaciones completas
                const obsGeneral = card.querySelector('.observacion-general');
                let contenidoObservacion = '';

                if (orden.observaciones && orden.observaciones.trim()) {
                    contenidoObservacion = extraerInformacionCompleta(orden.observaciones, tipoOrden);
                }

                if (contenidoObservacion) {
                    obsGeneral.textContent = contenidoObservacion;
                    obsGeneral.style.display = 'block';
                    obsGeneral.title = orden.observaciones; // Tooltip con observación completa
                    obsGeneral.classList.add(tipoOrden); // Clase para estilos específicos
                } else {
                    obsGeneral.style.display = 'none';
                }

                // Productos
                const listaProductos = card.querySelector('.lista-productos');
                listaProductos.innerHTML = '';
                
                let productosListos = 0;
                const totalProductos = orden.productos.length;

                orden.productos.forEach(producto => {
                    if (producto.estado === 'LISTO') productosListos++;
                    
                    const li = document.createElement('li');
                    li.className = 'producto-item';
                    if (producto.estado === 'LISTO') li.classList.add('listo');
                    if (producto.agregado_despues) li.classList.add('agregado-despues');

                    const observacionesHTML = producto.observaciones ? 
                        `<div class="obs">📝 ${producto.observaciones}</div>` : '';

                    let controlesHTML = '';
                    if (orden.completada || producto.estado === 'LISTO') {
                        controlesHTML = `<div class="controles-producto">
                            <span style="color: var(--verde-listo); font-weight: 600;">✅ Listo</span>
                        </div>`;
                    } else {
                        const confirmarId = `c-${producto.id}`;
                        const decrementoId = `d-${producto.id}`;
                        const enCooldownC = buttonsOnCooldown.has(confirmarId);
                        const enCooldownD = buttonsOnCooldown.has(decrementoId);
                        
                        if (producto.cantidad === 1) {
                            controlesHTML = `<div class="controles-producto">
                                <button class="btn btn-confirmar-producto" 
                                        data-producto-orden-id="${producto.id}" 
                                        data-cooldown-id="${confirmarId}" 
                                        ${enCooldownC ? 'disabled' : ''}>
                                    Confirmar
                                </button>
                            </div>`;
                        } else {
                            controlesHTML = `<div class="controles-producto">
                                <button class="btn btn-confirmar-producto" 
                                        data-producto-orden-id="${producto.id}" 
                                        data-cooldown-id="${confirmarId}" 
                                        ${enCooldownC ? 'disabled' : ''}>
                                    Confirmar Todo
                                </button>
                                <button class="btn btn-decremento" 
                                        data-producto-orden-id="${producto.id}" 
                                        data-cooldown-id="${decrementoId}" 
                                        ${enCooldownD ? 'disabled' : ''}>
                                    Entregar 1
                                </button>
                            </div>`;
                        }
                    }

                    li.innerHTML = `
                        <div class="producto-info">
                            <strong>${producto.cantidad}x ${producto.nombre}</strong>
                            ${observacionesHTML}
                            ${producto.agregado_despues ? '<span style="color: var(--amarillo-especial); font-size: 0.8em; font-weight: 600;">⚡ Agregado después</span>' : ''}
                        </div>
                        ${controlesHTML}
                    `;
                    
                    listaProductos.appendChild(li);
                });

                card.querySelector('.productos-count').textContent = `${productosListos}/${totalProductos} Listos`;

                // Botón de servido para órdenes completas
                if (orden.completada) {
                    const accionesDiv = card.querySelector('.orden-acciones');
                    const servidoId = `s-${orden.id}`;
                    const enCooldown = buttonsOnCooldown.has(servidoId);
                    
                    accionesDiv.innerHTML = `
                        <button class="btn btn-servido" 
                                data-orden-id="${orden.id}" 
                                data-cooldown-id="${servidoId}" 
                                ${enCooldown ? 'disabled' : ''}>
                            🍽️ Marcar como Servido
                        </button>
                    `;
                    accionesDiv.style.display = 'block';
                }

                return clone;
            }

            function actualizarContadoresEspeciales(ordenesData) {
                const domicilios = ordenesData.filter(o => o.mesa === 0);
                // 🔧 CORRECCIÓN: No actualizar contador de reservas aquí
                // porque las reservas se cargan por separado
                document.getElementById('contador-domicilios').textContent = domicilios.length;
                // El contador de reservas se actualiza en actualizarContadorReservas()
            }

            // === GESTIÓN DE MODALES ESPECIALES ===
            function renderizarOrdenesEspeciales(tipo, ordenesData) {
                const ordenes = ordenesData.filter(orden => 
                    tipo === 'domicilios' ? orden.mesa === 0 : orden.mesa === 50
                );
                
                const contenedor = document.getElementById(`contenido-${tipo}`);
                const template = document.getElementById('order-card-template');
                
                contenedor.innerHTML = '';
                
                if (ordenes.length === 0) {
                    const mensaje = tipo === 'domicilios' ? 'domicilios' : 'reservas futuras';
                    contenedor.innerHTML = `<p style="text-align: center; color: #888; padding: 2rem;">No hay órdenes de ${mensaje}.</p>`;
                } else {
                    ordenes.forEach(orden => {
                        const card = crearTarjetaOrden(orden, template);
                        contenedor.appendChild(card);
                    });
                }
            }

            // 🔧 FUNCIÓN CORREGIDA: Cargar reservas desde API específica
            window.abrirModalEspeciales = async function(tipo) {
                if (tipo === 'reservas') {
                    // Para reservas, usar API específica
                    const contenedor = document.getElementById('contenido-reservas');
                    contenedor.innerHTML = '<div class="loading">Cargando reservas...</div>';
                    
                    try {
                        const response = await fetch('/api/cocina/reservas/');
                        if (response.ok) {
                            const reservasData = await response.json();
                            renderizarOrdenesEspeciales('reservas', reservasData);
                            console.log(`📅 Reservas cargadas en modal: ${reservasData.length}`);
                        } else {
                            contenedor.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">Error cargando reservas.</p>';
                        }
                    } catch (error) {
                        console.error('❌ Error cargando reservas:', error);
                        contenedor.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">Error de conexión.</p>';
                    }
                } else {
                    // Para domicilios, usar datos ya cargados
                    renderizarOrdenesEspeciales(tipo, ordenes);
                }
                
                document.getElementById(`modal-${tipo}`).style.display = 'flex';
            };

            window.cerrarModalEspeciales = function(tipo) {
                document.getElementById(`modal-${tipo}`).style.display = 'none';
            };

            // === CARGA DE DATOS DESDE BACKEND ===
            async function cargarOrdenesCocina() {
                try {
                    // 🔧 CORRECCIÓN: URL dinámica para Django
                    const response = await fetch('/api/cocina/ordenes/');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    ordenes = data;
                    
                    console.log(`✅ Órdenes cargadas: ${data.length} (Mesas: ${data.filter(o => o.mesa > 0 && o.mesa < 50).length}, Domicilios: ${data.filter(o => o.mesa === 0).length})`);
                    
                    renderizarOrdenes(data);
                    
                    // 🔧 NUEVO: Cargar también las reservas para los contadores
                    await actualizarContadorReservas();
                    
                } catch (error) {
                    console.error('❌ Error cargando órdenes:', error);
                    showToast('Error al cargar las órdenes de cocina', 'error');
                }
            }

            // 🔧 NUEVA FUNCIÓN: Actualizar contador de reservas
            async function actualizarContadorReservas() {
                try {
                    const response = await fetch('/api/cocina/reservas/');
                    if (response.ok) {
                        const reservasData = await response.json();
                        document.getElementById('contador-reservas').textContent = reservasData.length;
                        console.log(`📅 Contador de reservas actualizado: ${reservasData.length}`);
                    }
                } catch (error) {
                    console.error('❌ Error actualizando contador de reservas:', error);
                }
            }

            // === GESTIÓN DE ACCIONES ===
            async function manejarAccionProducto(url, successMessage, errorMessage) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(result.mensaje || successMessage, 'success');
                        // Recargar órdenes después de la acción
                        await cargarOrdenesCocina();
                    } else {
                        showToast(result.error || errorMessage, 'error');
                    }
                    
                } catch (error) {
                    console.error('❌ Error en la acción:', error);
                    showToast('Error de conexión.', 'error');
                }
            }

            // === EVENT LISTENERS ===
            
            // Event delegation para acciones de productos
            document.addEventListener('click', async function(e) {
                const target = e.target;
                const cooldownId = target.dataset.cooldownId;
                
                if (cooldownId && buttonsOnCooldown.has(cooldownId)) return;

                const productoItem = target.closest('.producto-item');
                const productoName = productoItem ? productoItem.querySelector('strong').textContent : '';
                
                let actionConfirmed = false;
                let url = '', successMsg = '', errorMsg = '';

                if (target.classList.contains('btn-decremento')) {
                    actionConfirmed = await showConfirm(`¿Confirmas la entrega de 1 unidad de "<b>${productoName}</b>"?`);
                    if (actionConfirmed) {
                        url = `/api/cocina/producto/${target.dataset.productoOrdenId}/decrementar/`;
                        successMsg = 'Producto entregado parcialmente.';
                        errorMsg = 'No se pudo entregar el producto.';
                    }
                } else if (target.classList.contains('btn-confirmar-producto')) {
                    actionConfirmed = await showConfirm(`¿Marcar "<b>${productoName}</b>" como completado?`);
                    if (actionConfirmed) {
                        url = `/api/cocina/producto/${target.dataset.productoOrdenId}/listo/`;
                        successMsg = 'Producto marcado como listo.';
                        errorMsg = 'No se pudo confirmar el producto.';
                    }
                } else if (target.classList.contains('btn-servido')) {
                    actionConfirmed = await showConfirm(`¿Confirmas que la orden completa fue servida al cliente?`);
                    if (actionConfirmed) {
                        url = `/api/cocina/orden/${target.dataset.ordenId}/servida/`;
                        successMsg = '¡Orden marcada como servida!';
                        errorMsg = 'No se pudo marcar como servida.';
                    }
                }

                if (actionConfirmed) {
                    buttonsOnCooldown.add(cooldownId);
                    target.disabled = true;
                    
                    await manejarAccionProducto(url, successMsg, errorMsg);
                    
                    // Limpiar cooldown después de 3 segundos
                    setTimeout(() => {
                        buttonsOnCooldown.delete(cooldownId);
                        target.disabled = false;
                    }, 3000);
                }
            });

            // Filtros
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filtroActual = this.dataset.filtro;
                    
                    console.log(`🔍 Filtro cambiado a: ${filtroActual}`);
                    renderizarOrdenes(ordenes);
                });
            });

            // Cerrar modales con escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-especiales').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });

            // === FUNCIÓN DE ACTUALIZACIÓN MANUAL ===
            window.actualizarOrdenes = function() {
                showToast('Actualizando órdenes...', 'info', 2000);
                cargarOrdenesCocina();
            };

            // === LONG POLLING PARA TIEMPO REAL ===
            async function iniciarLongPolling() {
                while (true) {
                    try {
                        const url = `/api/longpolling/cocina/${currentHash ? `?hash=${currentHash}` : ''}`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.cambios) {
                            currentHash = data.hash;
                            
                            // Si hay cambios, recargar órdenes
                            console.log('🔄 Cambios detectados en cocina, actualizando...');
                            await cargarOrdenesCocina();
                            
                            // Mostrar notificación discreta
                            showToast('Vista actualizada', 'info', 2000);
                        }
                        
                        // Pequeño delay antes del siguiente poll
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.error('❌ Error en long polling:', error);
                        // Esperar 5 segundos antes de reintentar en caso de error
                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                }
            }

            // === INICIALIZACIÓN ===
            
            // Cargar órdenes iniciales
            cargarOrdenesCocina();
            
            // Iniciar long polling después de un breve delay
            setTimeout(() => {
                console.log('🔄 Iniciando long polling para cocina...');
                iniciarLongPolling();
            }, 2000);
            
            // Auto-actualización de respaldo cada 30 segundos
            setInterval(() => {
                cargarOrdenesCocina();
            }, 30000);
            
            console.log('✅ Dashboard de cocina inicializado correctamente');
        });
    </script>
</body>
</html>